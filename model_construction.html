<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modeling &mdash; xpsi 0.7.10 documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Instrument synergy" href="multiple_instruments.html" />
    <link rel="prev" title="Acknowledgements" href="acknowledgements.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> xpsi
          </a>
              <div class="version">
                0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Modeling</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Likelihood">Likelihood</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-parameter-space">The parameter space</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Interlude:-fast-and-slow-parameters">Interlude: fast and slow parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Data">Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Instrument">Instrument</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Signal">Signal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Constructing-a-star">Constructing a star</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#The-ambient-spacetime">The ambient spacetime</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-photosphere-and-its-constituent-regions">The photosphere and its constituent regions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Star">Star</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#A-callable-likelihood-object">A callable likelihood object</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Inspecting-functionality">Inspecting functionality</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Prior">Prior</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Custom-subclass">Custom subclass</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Density-and-support-checking">Density and support checking</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Sampling-interface">Sampling interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Ensemble-MCMC">Ensemble MCMC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Nested-sampling">Nested sampling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Synthesis">Synthesis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Data-format">Data format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Custom-method">Custom method</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Synthesise">Synthesise</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multiple_instruments.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field_checking_tools_tutorial.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction_streamlined.html">Modeling (without statistics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_imaging.html">Multiple imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing_tutorial.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_job.html">Example job</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal.html">Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Extension modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="extensions_overview.html">Overview of extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field.html">Surface radiation field</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood_implementations.html">Likelihoods</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing.html">PostProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xpsi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Modeling</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/model_construction.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Modeling">
<h1>Modeling<a class="headerlink" href="#Modeling" title="Permalink to this headline">¶</a></h1>
<p>The unexecuted and streamlined notebook for this tutorial may be found in a GitHub repository <em>together</em> with the necessary files which due to size are not included in the X-PSI respository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/ThomasEdwardRiley/xpsi_workshop.git &lt;/path/to/clone&gt;

<span class="nb">cd</span> &lt;/path/to/clone&gt;/tutorials/v0.6/
</pre></div>
</div>
<p>You can use the default atmosphere extension module <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/archive/hot/blackbody.pyx</span></code> as described below. To run this tutorial, you should therefore be able to simply use the default extensions that are automatically compiled when X-PSI is installed.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">AutoLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="kn">import</span> <span class="nn">xpsi</span>

<span class="kn">from</span> <span class="nn">xpsi.global_imports</span> <span class="kn">import</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_G</span><span class="p">,</span> <span class="n">_dpr</span><span class="p">,</span> <span class="n">gravradius</span><span class="p">,</span> <span class="n">_csq</span><span class="p">,</span> <span class="n">_km</span><span class="p">,</span> <span class="n">_2pi</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/=============================================\
| X-PSI: X-ray Pulse Simulation and Inference |
|---------------------------------------------|
|                Version: 0.6.1               |
|---------------------------------------------|
|  https://thomasedwardriley.github.io/xpsi/  |
\=============================================/

Imported GetDist version: 0.3.1
Imported nestcheck version: 0.2.0
</pre></div></div>
</div>
<p>Let’s build a generative model for the data; first we build a <em>callable</em> object for likelihood evaluation, and then we build a <em>callable</em> object for prior-density evaluation.</p>
<p>En route, we will explain why various software design choices were made during development. In some cases the conventions defined are not necessarily important for future development and indeed we expect them to be redesigned.</p>
<div class="section" id="Likelihood">
<h2>Likelihood<a class="headerlink" href="#Likelihood" title="Permalink to this headline">¶</a></h2>
<p>If you have not yet read the <a class="reference internal" href="overview.html"><span class="doc">likelihood overview</span></a>, it is advisable to do so now, or refer to a paper such as <a class="reference internal" href="applications.html#riley-et-al-2019-apjl-887-l21"><span class="std std-ref">Riley et al.&nbsp;(2019)</span></a>.</p>
<div class="section" id="The-parameter-space">
<h3>The parameter space<a class="headerlink" href="#The-parameter-space" title="Permalink to this headline">¶</a></h3>
<p>In order to implement an X-PSI likelihood function it is first necessary to define an underlying model parameter space. In general the parameter space is <span class="math notranslate nohighlight">\(\mathbb{R}^{d}\)</span>, where <span class="math notranslate nohighlight">\(d\in\mathbb{N}\)</span> is the total number of free model parameters. Each free parameter is an instance of the <a class="reference internal" href="parameter.html#xpsi.Parameter.Parameter"><span class="std std-ref">Parameter</span></a> class. We also support fixed (or frozen) variables and <em>derived</em> variables that are deterministic functions of other variables (notably, free
parameters).</p>
<p>In X-PSI we build upon a base class representing a <a class="reference internal" href="parameterSubspace.html#xpsi.ParameterSubspace.ParameterSubspace"><span class="std std-ref">ParameterSubspace</span></a>. To construct an X-PSI model a set of objects are defined which <em>derive</em> from this parameter subspace, and it is the <em>union</em> of these objects that forms both the global model parameter space, and a set of methods and attributes for evaluation of a parametrised sampling distribution of the data at the vector <span class="math notranslate nohighlight">\(\mathcal{D}\)</span>, conditional on a vector of model
parameter values.</p>
<p>Our aim is to construct a <em>callable</em> <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object to feed as a <em>callback</em> function to a posterior sampler and a posterior integrator. We illustrate this object in the diagram below; all nodes in the diagram below represent objects (instances of some class). In some cases there are multiple instances of a particular class, in other cases there is only a single instance of a particular class. Moreover, a subset of these classes inherit from (subclass)
<a class="reference internal" href="parameterSubspace.html#xpsi.ParameterSubspace.ParameterSubspace"><span class="std std-ref">ParameterSubspace</span></a>, because instances of these classes are objects with a parameter subspace and a collection of methods with instructions for handling parameter vectors in that subspace (methods and attributes to, e.g., calculate and store some <em>derived</em> quantities of the underlying theory/model respectively for likelihood evaluation).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="s2">&quot;./_static/oop_modelling_diagram_v1.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_11_0.png" src="_images/model_construction_11_0.png" />
</div>
</div>
<p>The arrows in the diagram denote an object that is stored as an attribute of another encapsulating (a reference to) another object. When a call is processed to evaluate the likelihood given a vector of model parameter values, encapsulating objects get attributes (magically including method calls) of the wrapped objects. The likelihood call results in a cascade of attribute lookups by objects higher in the hierarchy to those lower in the hierarchy. An arguably powerful aspect of the
implementation is the merging of parameter subspaces when references to two or more subspaces are encapsulated with an object higher in the hierarchy. This permits parameters to be accessed via Python container <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> and <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code> magic on any object (deriving from <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code>) that encapsulates references to them.</p>
<p>We will now briefly describe the purpose of each object above which is encapsulated by the callable <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object (<code class="docutils literal notranslate"><span class="pre">Likelihood</span></code> in the diagram to denote the name of the class of which it is an instance). Note the use of the term <em>abstract base class</em>, which means that a user is required to subclass, and thereby provide a concrete implementation of some functionality specific to their model. Some source code classes are concrete classes that can be instantiated directly.</p>
<ul class="simple">
<li>A <code class="docutils literal notranslate"><span class="pre">Star</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class. It represents the model star. The objects it encapsulates also derive from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class.<ul>
<li>A <code class="docutils literal notranslate"><span class="pre">Spacetime</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class. It represents the ambient Schwarzschild spacetime solution.</li>
<li>A <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class. It represents a radiation field on a 2-surface embedded in a spacelike hypersurface of that ambient spacetime. There can be multiple <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instances per <code class="docutils literal notranslate"><span class="pre">Star</span></code> instance, naturally representing <em>snapshots</em> in time that are assumed to be adequate approximations for some natural number of stellar rotations. Note that the dimensionality of the parameter space grows linearly, however, so in practice this
approximation to time evolution is intended for simulation and data synthesis.<ul>
<li>A <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class. It represents a radiatively intense region: e.g., a “circular hot-spot” in the photosphere (the surface radiation field). Alternatively, a <code class="docutils literal notranslate"><span class="pre">TwoHotRegions</span></code> object that derives from <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code>, or a <code class="docutils literal notranslate"><span class="pre">HotRegions</span></code> object that encapsulates references to two or more <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> instances, is used.</li>
<li>An <code class="docutils literal notranslate"><span class="pre">Elsewhere</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class. The represents the surface radiation field exterior to the hot region.</li>
<li>An <code class="docutils literal notranslate"><span class="pre">Everywhere</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class. The represents the surface radiation field <em>everywhere</em>, and <em>cannot</em> be used in conjuction with <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> instances and <code class="docutils literal notranslate"><span class="pre">Elsewhere</span></code> instances.</li>
</ul>
</li>
</ul>
</li>
<li>A <code class="docutils literal notranslate"><span class="pre">Signal</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class, and is itself an abstract base class. A signal is defined as a subset <span class="math notranslate nohighlight">\(\mathcal{D}_{i}\subseteq\mathcal{D}\)</span> of the dataset with a parametrised sampling distribution dependent on an incident specific flux signal generated by a particular <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance. There can thus be multiple <code class="docutils literal notranslate"><span class="pre">Signal</span></code> instances.<ul>
<li>A <code class="docutils literal notranslate"><span class="pre">Data</span></code> instance does <em>not</em> derive from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class, and is a concrete class. It is a container for the data subset <span class="math notranslate nohighlight">\(\mathcal{D}_{i}\subseteq\mathcal{D}\)</span>.</li>
<li>An <code class="docutils literal notranslate"><span class="pre">Instrument</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class, and is a concrete class. It represents the model instrument for transforming incident specific flux signals into a structure which directly enters the parameterised sampling distribution of <span class="math notranslate nohighlight">\(\mathcal{D}_{i}\)</span>.</li>
<li>An <code class="docutils literal notranslate"><span class="pre">Interstellar</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class, and is itself an abstract base class. It represents a model for physical interstellar radiation-matter interaction processes which modify the surface radiation field during propagation to the instrument.</li>
<li>A <code class="docutils literal notranslate"><span class="pre">Background</span></code> instance derives from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class, and is itself an abstract base class. It represents a model for the background radiation field <em>incident</em> on the instrument.</li>
</ul>
</li>
</ul>
<p>The purpose of invoking the object-oriented paradigm here is to organise a non-trivial likelihood evaluation algorithm in a <em>logical</em>, <em>flexible</em>, and <em>extensible</em> manner by identifying groups of mathematical structures which can be considered as belonging to some more abstract object with some physical and/or statistical meaning, and <em>modularising</em> them in classes.</p>
<p>We use a dynamic and expressive high-level language to organise this computation, allowing both calls low-level library routines where necessary to improve calculation speed, and straightforward communication between our problem-specific code and other more general open-source software libraries (in particular, statistical sampling software).</p>
<p>As stated above, for each of these objects which derive from the <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> class, their parameter subspaces are merged into a higher-dimensional space when referenced by an object higher in the hierarcy. As an example, a <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> instance and an <code class="docutils literal notranslate"><span class="pre">Elsewhere</span></code> instance each have an associated parameter subspace, and those are merged to form most of the dimensions of the parameter space associated with a <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance.</p>
<p>Note that one can in principle utilise a given object multiple times. An example would be the use of the same <code class="docutils literal notranslate"><span class="pre">Instrument</span></code> object or <code class="docutils literal notranslate"><span class="pre">Interstellar</span></code> processes object for constructing multiple <code class="docutils literal notranslate"><span class="pre">Signal</span></code> objects, although this might result in too many parameter dimensions for a problem to be tractable. On another level, the instruments might reference some of the same <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> objects, but themselves be distinct objects, each passed to a distinct <code class="docutils literal notranslate"><span class="pre">Signal</span></code> object. In the diagram below we
illustrate a <em>tied</em> relationship between some objects with connecting lines: this could mean the tied objects are <em>the same</em> object, or that the objects share some parameters, or that properties of one are derived from the free parameters of another.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;./_static/oop_modelling_diagram_v2.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_17_0.png" src="_images/model_construction_17_0.png" />
</div>
</div>
<p>In this case, the tied objects represent physical systems or processes exisiting at different times, but some behaviour is shared. Note that we also assumed that the <code class="docutils literal notranslate"><span class="pre">Interstellar</span></code> processes are time-invariant and thus moved the object over to connect to the <code class="docutils literal notranslate"><span class="pre">Star</span></code> itself; the source code is not structured quite in this way, but achieves the same if an <code class="docutils literal notranslate"><span class="pre">Interstellar</span></code> process object is time-invariant. The <code class="docutils literal notranslate"><span class="pre">Data</span></code> objects are never parametrised and thus are not tied in the sense discussed
above.</p>
<p>Another example might be supplying the same hot-region radiation field parameters to two <em>disjoint</em> hot regions that simultaneously occupy a subset of the stellar surface. In this case the <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> objects referenced in the <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> objects would be shared. Another way to achieve the same effect is to define parameters of one hot region as <em>derived</em> from those of the other hot region. Both methods would achieve the same goal, but would be implemented differently. The latter is more
flexible and thus more powerful. More extensive examples of this paradigm are given in a separate tutorial.</p>
<p>If there are instantaneously multiple <em>disjoint</em> surface hot regions, the model object hierarchy diagram would more accurately be rendered as:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;./_static/oop_modelling_diagram_v3.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_21_0.png" src="_images/model_construction_21_0.png" />
</div>
</div>
<p>If there are multiple instances of the <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a> class, and multiple instances of the <a class="reference internal" href="signal.html#xpsi.Signal.Signal"><span class="std std-ref">Signal</span></a> class with a one-to-one mapping, the parameter set would assume the following form:</p>
<ul class="simple">
<li>coordinate spin frequency</li>
<li>(rotationally deformed) gravitational mass</li>
<li>coordinate equatorial radius</li>
<li>distance from Earth</li>
<li>inclination of Earth to stellar rotation axis</li>
<li><code class="docutils literal notranslate"><span class="pre">photosphere_1</span></code> (non-optional):<ul>
<li>coordinate rotation frequency of a mode of radiative asymmetry assumed to generate the observed pulsations</li>
<li>subvector of geometric hot-region parameters (e.g., spot centre colatitude, spot angular radius, and so on) and a parameter controlling the surface local-comoving-frame radiation field <em>within</em> the region boundaries</li>
<li>(optional) subvector of additional parameters controlling the surface local-comoving-frame radiation field <em>within</em> the hot-region boundaries (e.g., pertaining to ionisation degree or composition)</li>
<li>(optional) subvector of parameters controlling the surface local-comoving-frame radiation field <em>outside</em> the hot-region boundaries</li>
<li>subvector of fast parameters for the phases of the hot region(s) relative to some fiducial phase</li>
</ul>
</li>
<li><span class="math notranslate nohighlight">\(\ldots\)</span></li>
<li><code class="docutils literal notranslate"><span class="pre">photosphere_n</span></code> (optional):<ul>
<li>coordinate rotation frequency of a mode of radiative asymmetry assumed to generate the observed pulsations</li>
<li>subvector of geometric hot-region parameters (e.g., spot centre colatitude, spot angular radius, and so on) and a parameter such as an effective temperature controlling the surface local-comoving-frame radiation field <em>within</em> the region boundaries</li>
<li>(optional) subvector of additional parameters controlling the surface local-comoving-frame radiation field <em>within</em> the hot-region boundaries (e.g., pertaining to ionisation degree or composition)</li>
<li>(optional) subvector of parameters controlling the surface local-comoving-frame radiation field <em>outside</em> the hot-region boundaries</li>
<li>subvector of fast parameters for the phases of the hot region(s) relative to some fiducial phase</li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">signal_1</span></code> (non-optional):<ul>
<li>(optional) subvector of fast nuisance parameters associated with interstellar processes</li>
<li>(optional) subvector of fast nuisance parameters associated with instrument response</li>
<li>(optional) subvector of fast nuisance parameters associated with background processes</li>
</ul>
</li>
<li><span class="math notranslate nohighlight">\(\ldots\)</span></li>
<li><code class="docutils literal notranslate"><span class="pre">signal_n</span></code> (if matching <code class="docutils literal notranslate"><span class="pre">photosphere_n</span></code>):<ul>
<li>(optional) subvector of fast nuisance parameters associated with interstellar processes</li>
<li>(optional) subvector of fast nuisance parameters associated with instrument response</li>
<li>(optional) subvector of fast nuisance parameters associated with background processes</li>
</ul>
</li>
</ul>
<p>where <span class="math notranslate nohighlight">\(\forall i\in[1,n]\)</span> <code class="docutils literal notranslate"><span class="pre">photosphere_i</span></code> and <code class="docutils literal notranslate"><span class="pre">signal_i</span></code> share an identification <code class="docutils literal notranslate"><span class="pre">tag</span></code>.</p>
<p>Most model parameters that are <em>not</em> associated with <code class="docutils literal notranslate"><span class="pre">Signal</span></code> instances are considered <em>slow</em> parameters; see the interlude below for definition of <em>slow</em> and <em>fast</em>. An example of a <em>slow</em> parameter is the gravitational mass, whilst examples of <em>fast</em> parameters are the initial phase of the photosphere and the distance (from Earth) to the star.</p>
<p>Yet another paradigm is that the same signal yielded by integrating over the photosphere is operated on by multiple instruments (on different telescopes or the same telescope, or some on one telecope and others on other telescopes), and because these instruments are synergystic probes of the physical signal-generating process, we aim to jointly model the data from those instruments. This can be executed as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;./_static/oop_modelling_diagram_v4.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_24_0.png" src="_images/model_construction_24_0.png" />
</div>
</div>
<p>Here the signal from integrating over the image of the <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance is relayed to all <code class="docutils literal notranslate"><span class="pre">Signal</span></code> instances for instrument operation and likelihood function calculation. The signal relayed is always encapsulated by a 2D NumPy array with photon energy increasing with row (zeroth dimension) and phase increasing with column (first dimension). Even if an integrator (extension module) is called that assumes time-invariance of the image of the <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> and thus returns a single
spectrum, that spectrum is encapsulated by a 2D NumPy array. Specifically, an <code class="docutils literal notranslate"><span class="pre">Elsewhere</span></code> instance returns a spectrum which is added to the spectrum at each phase generated by the associated <code class="docutils literal notranslate"><span class="pre">HotRegion(s)</span></code> instance. The user can then completely phase-average the signal (thus generating a single spectrum) for comparison to an instrument whose registered (and pre-processed) data is a spectrum. For instruments that register time-resolved data, the user will usually integrate the signal phase
intervals (bins) for likelihood function evaluation. The phase-resolved and phase-averaged data can be jointly modeled.</p>
<p>Finally, one can use <code class="docutils literal notranslate"><span class="pre">Everywhere</span></code> instances to model the surface radiation field everywhere, but these instances cannot be used in conjuction with <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> instances nor <code class="docutils literal notranslate"><span class="pre">Elsewhere</span></code> instances to constitute the same <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance. An example of this paradigm is as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;./_static/oop_modelling_diagram_v5.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_27_0.png" src="_images/model_construction_27_0.png" />
</div>
</div>
<p>Note that here we chose to return to the notion of time-evolution between <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instances, instead of using multiple <code class="docutils literal notranslate"><span class="pre">Signal</span></code> intances operating on one <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance.</p>
</div>
<div class="section" id="Interlude:-fast-and-slow-parameters">
<h3>Interlude: fast and slow parameters<a class="headerlink" href="#Interlude:-fast-and-slow-parameters" title="Permalink to this headline">¶</a></h3>
<p>A subset of model parameters are <em>slow</em> because varying those parameters requires <em>likelihood</em> re-evaluation, and the compute time required to perform that re-evaluation is slow <em>relative</em> to re-evaluation when varying only a distinct <em>subset</em> of the model parameters: the <em>fast</em> parameters. In general there can be multiple subsets of parameters forming a <em>speed hierarchy</em>; see <a class="reference external" href="https://arxiv.org/abs/1304.4473">A. Lewis, “Efficient sampling of fast and slow cosmological parameters”
(arXiv:1304.4473)</a>.</p>
<p>X-PSI, during developement, supported the use of the nested sampler PolyChord, whose internals require that parameters forming a speed hierarchy are ordered in subsets (or blocks) from <em>slow</em> to <em>fast</em> in an array passed to a <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> callback function (if one wishes to exploit a speed hierarchy that is). Thus the ordering of an array of parameter values passed to a general instance of the <a class="reference internal" href="likelihood.html#xpsi.Likelihood.Likelihood"><span class="std std-ref">Likelihood</span></a> class was of crucial importance. During
development, we opted to support the nested sampler MultiNest instead based on the nature of the sampling problem (dimensionality and likelihood evaluation expense).</p>
<p>However, until X-PSI <code class="docutils literal notranslate"><span class="pre">v0.3</span></code>, a convention for parameter ordering for likelihood evaluation was imposed, with two basic speed grades. In <code class="docutils literal notranslate"><span class="pre">v0.3</span></code>, however, we do not adhere to a speed hierarchy for lack of an application at present, although with some added sophistication this can be supported.</p>
</div>
<div class="section" id="Data">
<h3>Data<a class="headerlink" href="#Data" title="Permalink to this headline">¶</a></h3>
<p>For the analysis in this notebook we consider all data <span class="math notranslate nohighlight">\(\mathcal{D}\)</span> to be drawn from a joint sampling distribution whose dependency on <em>slow</em> model source parameters is expressed in terms of a <em>single</em> pulse signal. The justification for such an assumption is that we are performing parameter estimation given a synthetic data set for a model <em>pulsar</em> with a stable (effectively non-evolving) surface radiation field, with any quasi-periodicity arising solely from relative orbital motion of
source and telescope. The synthetic data is intended to emulate detection of photons over a long observing run, after which the photon incidence events are phase-folded during a pre-processing phase.</p>
<p>This parameter estimation excercise is not <em>blind</em>: we know the parameter values injected to generate the synthetic dataset we will later load into a custom container.</p>
<p>We do not need to subclass data container, but you can if you wish. X-PSI is designed this way because there is a clear common usage pattern that can be concretely implemented whilst preserving the freedom and the scope of applicability of the source code. The container instance will be available as an underscore instance method of <a class="reference internal" href="signal.html#xpsi.Signal.Signal"><span class="std std-ref">Signal</span></a>, and thus available in a derived class where we will later write code for likelihood evaluation.</p>
<p>Hereafter we will write our custom derived classes in the notebook itself, but in practice it is best if your derived classes are written in distinct modules within a project directory, so they can be imported by a script for use with an MPI command within a shell (because in general we want to exploit parallelism for expensive likelihood evaluations).</p>
<p>Let us load a synthetic data set that we generated in advance, and know the fictitious exposure time for:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;../../examples/data/synthetic_realisation.dat&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
                <span class="n">channels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">201</span><span class="p">),</span>
                <span class="n">phases</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
                <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span>
                <span class="n">exposure_time</span><span class="o">=</span><span class="mf">984307.6661</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Setting channels for event data...
Channels set.
</pre></div></div>
</div>
<p>Let’s take a look at the data that we aim to model. First we define some settings and helper functions:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">14.0</span>

<span class="k">def</span> <span class="nf">veneer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make the plots a little more aesthetically pleasing. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_one_pulse</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot a pulse resolved over a single rotational cycle. &quot;&quot;&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                             <span class="n">data</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                             <span class="n">pulse</span><span class="p">,</span>
                             <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span>
                             <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span>
                             <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
                             <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">profile</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Phase&#39;</span><span class="p">)</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span>
                      <span class="n">cax</span> <span class="o">=</span> <span class="n">ax_cb</span><span class="p">)</span>

    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">solids</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now for the data:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_39_0.png" src="_images/model_construction_39_0.png" />
</div>
</div>
</div>
<div class="section" id="Instrument">
<h3>Instrument<a class="headerlink" href="#Instrument" title="Permalink to this headline">¶</a></h3>
<p>We require a model instrument object to transform incident specific flux signals into a form which enters directly in the sampling distribution of the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">CustomInstrument</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A model of the NICER telescope response. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overwrite base just to show it is possible.</span>

<span class="sd">        We loaded only a submatrix of the total instrument response</span>
<span class="sd">        matrix into memory, so here we can simplify the method in the</span>
<span class="sd">        base class.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_matrix</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_folded_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folded_signal</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_response_files</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ARF</span><span class="p">,</span> <span class="n">RMF</span><span class="p">,</span> <span class="n">max_input</span><span class="p">,</span> <span class="n">min_input</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">channel_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructor which converts response files into :class:`numpy.ndarray`s.</span>
<span class="sd">        :param str ARF: Path to ARF which is compatible with</span>
<span class="sd">                                :func:`numpy.loadtxt`.</span>
<span class="sd">        :param str RMF: Path to RMF which is compatible with</span>
<span class="sd">                                :func:`numpy.loadtxt`.</span>
<span class="sd">        :param str channel_edges: Optional path to edges which is compatible with</span>
<span class="sd">                                  :func:`numpy.loadtxt`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">min_input</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_input</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_input</span><span class="p">)</span>

        <span class="n">max_input</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_input</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ARF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">ARF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">RMF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">RMF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">channel_edges</span><span class="p">:</span>
                <span class="n">channel_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">channel_edges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A file could not be loaded.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">RMF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">20</span><span class="p">:</span><span class="mi">201</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

        <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">*=</span> <span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">201</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">channel_edges</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">202</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Let’s construct an instance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">NICER</span> <span class="o">=</span> <span class="n">CustomInstrument</span><span class="o">.</span><span class="n">from_response_files</span><span class="p">(</span><span class="n">ARF</span> <span class="o">=</span> <span class="s1">&#39;../../examples/model_data/nicer_v1.01_arf.txt&#39;</span><span class="p">,</span>
                                             <span class="n">RMF</span> <span class="o">=</span> <span class="s1">&#39;../../examples/model_data/nicer_v1.01_rmf_matrix.txt&#39;</span><span class="p">,</span>
                                             <span class="n">max_input</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
                                             <span class="n">min_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="n">channel_edges</span> <span class="o">=</span> <span class="s1">&#39;../../examples/model_data/nicer_v1.01_rmf_energymap.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Setting channels for loaded instrument response (sub)matrix...
Channels set.
No parameters supplied... empty subspace created.
</pre></div></div>
</div>
<p>The NICER <code class="docutils literal notranslate"><span class="pre">v1.01</span></code> response matrix:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">veneer</span><span class="p">((</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">NICER</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span>
              <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span>
              <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Channel $-\;20$&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy interval&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_46_0.png" src="_images/model_construction_46_0.png" />
</div>
</div>
<p>Summed over channel subset <span class="math notranslate nohighlight">\([20,200]\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">250</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">NICER</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">NICER</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">NICER</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effective area [cm$^{-2}$]&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_48_0.png" src="_images/model_construction_48_0.png" />
</div>
</div>
</div>
<div class="section" id="Signal">
<h3>Signal<a class="headerlink" href="#Signal" title="Permalink to this headline">¶</a></h3>
<p>We can now combine the dataset and model instrument into a <a class="reference internal" href="signal.html#xpsi.Signal.Signal"><span class="std std-ref">Signal</span></a> object. The source code for this class has methods and attributes which simplify communication between the aforementioned model objects and another object representing our model star (created below). The surface radiation field of the model star is integrated over based on energies relayed from a <a class="reference internal" href="signal.html#xpsi.Signal.Signal"><span class="std std-ref">Signal</span></a> object based on the properties of the instrument and the
dataset (which are tightly coupled).</p>
<p>We are forced to inherit from <a class="reference internal" href="signal.html#xpsi.Signal.Signal"><span class="std std-ref">Signal</span></a> and write a method that evaluates the logarithm of the likelihood conditional on a parametrised sampling distribution for the data. There is much freedom in constructing this sampling distribution, so the design strategy for X-PSI was to leave this part of the modelling process entirely to a user, guided by a number of examples. The only condition for applicability is that the sampling distribution of the data (or of each
subset) can be written in terms of a set of <em>single</em> count-rate pulses.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">xpsi.likelihoods.default_background_marginalisation</span> <span class="kn">import</span> <span class="n">eval_marginal_likelihood</span>
<span class="kn">from</span> <span class="nn">xpsi.likelihoods.default_background_marginalisation</span> <span class="kn">import</span> <span class="n">precomputation</span>

<span class="k">class</span> <span class="nc">CustomSignal</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Signal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    A custom calculation of the logarithm of the likelihood.</span>
<span class="sd">    We extend the :class:`~xpsi.Signal.Signal` class to make it callable.</span>
<span class="sd">    We overwrite the body of the __call__ method. The docstring for the</span>
<span class="sd">    abstract method is copied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace_intervals</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">epsabs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">epsrel</span> <span class="o">=</span> <span class="mf">1.0e-8</span><span class="p">,</span>
                 <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0e-3</span><span class="p">,</span> <span class="n">sigmas</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform precomputation.</span>

<span class="sd">        :params ndarray[m,2] support:</span>
<span class="sd">            Prior support bounds for background count rate variables in the</span>
<span class="sd">            :math:`m` instrument channels, where the lower bounds must be zero</span>
<span class="sd">            or positive, and the upper bounds must be positive and greater than</span>
<span class="sd">            the lower bound. Alternatively, setting the an upper bounds as</span>
<span class="sd">            negative means the prior support is unbounded and the flat prior</span>
<span class="sd">            density functions per channel are improper. If ``None``, the lower-</span>
<span class="sd">            bound of the support for each channel is zero but the prior is</span>
<span class="sd">            unbounded.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CustomSignal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precomp</span> <span class="o">=</span> <span class="n">precomputation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: No data... can synthesise data but cannot evaluate a &#39;</span>
                  <span class="s1">&#39;likelihood function.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workspace_intervals</span> <span class="o">=</span> <span class="n">workspace_intervals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epsabs</span> <span class="o">=</span> <span class="n">epsabs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epsrel</span> <span class="o">=</span> <span class="n">epsrel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigmas</span> <span class="o">=</span> <span class="n">sigmas</span>

            <span class="k">if</span> <span class="n">support</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="n">support</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_support</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_signal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_given_support</span> <span class="o">=</span> \
                <span class="n">eval_marginal_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">exposure_time</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_shifts</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_precomp</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_support</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_workspace_intervals</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_epsabs</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_epsrel</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_sigmas</span><span class="p">,</span>
                                          <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;llzero&#39;</span><span class="p">),</span>
                                          <span class="n">allow_negative</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>In the first part of this notebook we define a <em>marginal</em> likelihood function. That is, instead of invoking the true background model that in this case is known to us, we invoke a default treatment whereby we marginalise over a set of channel-by-channel background count-rate parameters instead.</p>
<p>We wrote our <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method as a wrapper for a extension module to improve speed. The source code for the simpler case of parameter estimation when the background model is known (see path <code class="docutils literal notranslate"><span class="pre">xpsi/examples/true_background</span></code>). In general, if you wish to change the model for likelihood evaluation given expected signals, you can archive the Cython extensions in, e.g., the <code class="docutils literal notranslate"><span class="pre">xpsi/likelihoods</span></code> directory, and compile these when X-PSI is compiled and installed (by editing the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script).
Alternatively, you can compile your extension elsewhere and call those compiled binaries from your custom class derived from <code class="docutils literal notranslate"><span class="pre">Signal</span></code>.</p>
<p>Let’s construct and instantiate a <code class="docutils literal notranslate"><span class="pre">Signal</span></code> object. We must accept phase shift parameters, which are a <em>fast</em> nuisance parameter; this detailed in the docstring of <code class="docutils literal notranslate"><span class="pre">Signal</span></code>. The bounds of the background parameter have already been specified above.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">signal</span> <span class="o">=</span> <span class="n">CustomSignal</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                        <span class="n">instrument</span> <span class="o">=</span> <span class="n">NICER</span><span class="p">,</span>
                        <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">interstellar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">workspace_intervals</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                        <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">epsrel</span> <span class="o">=</span> <span class="mf">1.0e-8</span><span class="p">,</span>
                        <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0e-3</span><span class="p">,</span>
                        <span class="n">sigmas</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
                        <span class="n">support</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Constructing-a-star">
<h3>Constructing a star<a class="headerlink" href="#Constructing-a-star" title="Permalink to this headline">¶</a></h3>
<p>We now need to build our star. The basic units for building a star are:</p>
<ul class="simple">
<li>the <a class="reference internal" href="spacetime.html#xpsi.Spacetime.Spacetime"><span class="std std-ref">Spacetime</span></a> class;</li>
<li>the <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a> class;</li>
<li>the <a class="reference internal" href="hotregion.html#xpsi.HotRegion.HotRegion"><span class="std std-ref">HotRegion</span></a> class;</li>
<li>the <a class="reference internal" href="elsewhere.html#xpsi.Elsewhere.Elsewhere"><span class="std std-ref">Elsewhere</span></a> class;</li>
<li>and four low-level user-modifiable routines for evaluation of a parametrised specific intensity model.</li>
</ul>
<p>For this demonstration we will assume that the surface radiation field <em>elsewhere</em> (other than the hot regions) can be ignored in the soft X-ray regime our model instrument is sensitive to. For more advanced modelling, we can simply write custom <em>derived</em> classes, and instantiate those derived classes to construct objects for our model. In particular, a common pattern will be to subclass the <a class="reference internal" href="hotregion.html#xpsi.HotRegion.HotRegion"><span class="std std-ref">HotRegion</span></a> class. Let’s start with the
<a class="reference internal" href="spacetime.html#xpsi.Spacetime.Spacetime"><span class="std std-ref">Spacetime</span></a> class.</p>
<div class="section" id="The-ambient-spacetime">
<h4>The ambient spacetime<a class="headerlink" href="#The-ambient-spacetime" title="Permalink to this headline">¶</a></h4>
<p>We will assume a coordinate rotation frequency based on timing analyses of 300.0 Hz; we thus <em>fix</em> the coordinate rotation frequency of the star.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Spacetime</span><span class="o">.</span><span class="n">fixed_spin</span><span class="p">(</span><span class="mf">300.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Configuring default bounds with fixed spin...
Creating parameter:
    &gt; Named &#34;frequency&#34; with fixed value 3.000e+02.
    &gt; Spin frequency [Hz].
Creating parameter:
    &gt; Named &#34;mass&#34; with bounds [1.000e+00, 3.000e+00].
    &gt; Gravitational mass [solar masses].
Creating parameter:
    &gt; Named &#34;radius&#34; with bounds [1.477e+00, 1.600e+01].
    &gt; Coordinate equatorial radius [km].
Creating parameter:
    &gt; Named &#34;distance&#34; with bounds [5.000e-02, 2.000e+00].
    &gt; Earth distance [kpc].
Creating parameter:
    &gt; Named &#34;cos_inclination&#34; with bounds [0.000e+00, 1.000e+00].
    &gt; Cosine of Earth inclination to rotation axis.
Spacetime configured.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">spacetime</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Gravitational mass [solar masses].
Coordinate equatorial radius [km].
Earth distance [kpc].
Cosine of Earth inclination to rotation axis.
</pre></div></div>
</div>
<p>Alternatively we can specify bounds manually for the free parameters, and give the spin frequency.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">Spacetime</span><span class="c1">#? # uncomment to query</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
xpsi.Spacetime.Spacetime
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>                     <span class="c1"># (Earth) distance</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>                       <span class="c1"># mass</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">gravradius</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">16.0</span><span class="p">),</span>  <span class="c1"># equatorial radius</span>
                <span class="n">cos_inclination</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>      <span class="c1"># (Earth) inclination to rotation axis</span>

<span class="n">spacetime</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Spacetime</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mf">300.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;frequency&#34; with fixed value 3.000e+02.
    &gt; Spin frequency [Hz].
Creating parameter:
    &gt; Named &#34;mass&#34; with bounds [1.000e+00, 3.000e+00].
    &gt; Gravitational mass [solar masses].
Creating parameter:
    &gt; Named &#34;radius&#34; with bounds [4.430e+00, 1.600e+01].
    &gt; Coordinate equatorial radius [km].
Creating parameter:
    &gt; Named &#34;distance&#34; with bounds [1.000e-01, 1.000e+00].
    &gt; Earth distance [kpc].
Creating parameter:
    &gt; Named &#34;cos_inclination&#34; with bounds [0.000e+00, 1.000e+00].
    &gt; Cosine of Earth inclination to rotation axis.
</pre></div></div>
</div>
</div>
<div class="section" id="The-photosphere-and-its-constituent-regions">
<h4>The photosphere and its constituent regions<a class="headerlink" href="#The-photosphere-and-its-constituent-regions" title="Permalink to this headline">¶</a></h4>
<p>It is not necessary for us to write a custom derived class for the photosphere object, so we will simply instantiate a <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a> object. However, we first need an instance of <a class="reference internal" href="hotregion.html#xpsi.HotRegion.HotRegion"><span class="std std-ref">HotRegion</span></a> to instantiate the photosphere, and we need to implement a low-level parametrised model for the specific intensity emergent from the photosphere in a local comoving frame.</p>
<p>The neutron star atmosphere is assumed to be geometrically thin. In the applications thus far, the surface local-comoving-frame radiation field as being described by a single <em>free</em> parameter: the effective temperature. The radiation field is also dependent on the local effective gravitational acceleration, however this is a <em>derived</em> parameter in the model. The parametrised radiation field as a function of energy and angle subtended to the normal to the (plane-parallel) atmosphere in a local
comoving frame is provided as numerical model data for multi-dimensional interpolation.</p>
<p>In X-PSI, integration over the surface radiation field is performed via calls to low-level C routines. To reduce likelihood evaluation times, the atmosphere interpolator is written in C, and calls to that interpolator are from C routine. In other words, in X-PSI, <strong>we do not use Python callback functions for evaluation of specific intensities, but C functions which are compiled when the</strong> X-PSI <strong>package is built</strong>. Unfortunately this means that to change the parametrised surface radiation field
you need to get your hands a little dirty; on the bright side, the body of these functions can be implemented almost completely in the Cython language, so syntactically there is some similarity to Python because the language syntax is somewhat of a hybrid/superset. Beware, however, that the body of these functions must not contain calls to the Python API, and only to external C libraries if required: the code must evaluate to pure C, and not require the Python/C API. Note that the Python global
interpreter lock is deactivated during integration to enable OpenMP multi-threading in some applications of the integrator; thus the code needs to be thread safe and <code class="docutils literal notranslate"><span class="pre">nogil</span></code> (not require the global interpreter lock, although a context manager could <em>in principle</em> be used to reacquire the lock within the integrator). Also note that if external C libraries are required, that you include a Cython .pxd (header) file in the package which <code class="docutils literal notranslate"><span class="pre">extern</span></code>s the required library components; the library
also needs to be included and linked in <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> at package build-time.</p>
<p><em>You are encouraged to ask the author of X-PSI for assistance in implementing your low-level surface radiation field model if you are uncertain. If you have ideas for making this model specification more user-friendly, without, crucially, increasing signal integration time, please contact the author or submit a pull request.</em></p>
<p>The following is the contents of the <code class="docutils literal notranslate"><span class="pre">hot.pxd</span></code> file which the X-PSI integrators use as the header file for including other C functions in the package.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span> <span class="nn">preload</span> <span class="k">cimport</span> <span class="n">_preloaded</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">eval_hot</span><span class="p">(</span><span class="n">size_t</span> <span class="n">THREAD</span><span class="p">,</span>
                     <span class="n">double</span> <span class="n">E</span><span class="p">,</span>
                     <span class="n">double</span> <span class="n">mu</span><span class="p">,</span>
                     <span class="n">const</span> <span class="n">double</span> <span class="o">*</span><span class="n">const</span> <span class="n">VEC</span><span class="p">,</span>
                     <span class="n">void</span> <span class="o">*</span><span class="n">const</span> <span class="n">data</span><span class="p">)</span> <span class="k">nogil</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">eval_hot_norm</span><span class="p">()</span> <span class="k">nogil</span>

<span class="k">cdef</span> <span class="kt">void</span>* <span class="nf">init_hot</span><span class="p">(</span><span class="n">size_t</span> <span class="n">numThreads</span><span class="p">,</span> <span class="n">const</span> <span class="n">_preloaded</span> <span class="o">*</span><span class="n">const</span> <span class="n">preloaded</span><span class="p">)</span> <span class="k">nogil</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">free_hot</span><span class="p">(</span><span class="n">size_t</span> <span class="n">numThreads</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">const</span> <span class="n">data</span><span class="p">)</span> <span class="k">nogil</span>
</pre></div>
</div>
<p><strong>You are free to modify these functions in the associated</strong> <code class="docutils literal notranslate"><span class="pre">hot.pyx</span></code> <strong>implementation file, and you have almost complete control over the function bodies, but not the signatures.</strong> By default the package includes an isotropic blackbody model:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c">#cython: cdivision=True</span>
<span class="c">#cython: boundscheck=False</span>
<span class="c">#cython: nonecheck=False</span>
<span class="c">#cython: wraparound=False</span>

<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">exp</span><span class="p">,</span> <span class="nb">pow</span>

<span class="k">from</span> <span class="nn">xpsi.global_imports</span> <span class="k">import</span> <span class="n">_keV</span><span class="p">,</span> <span class="n">_k_B</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">SUCCESS</span> <span class="o">=</span> <span class="mf">0</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">erg</span> <span class="o">=</span> <span class="mf">1.0e-7</span>
<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">Planck_dist_const</span> <span class="o">=</span> <span class="mf">5.040366110812353e22</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">k_B</span> <span class="o">=</span> <span class="n">_k_B</span>
<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">keV</span> <span class="o">=</span> <span class="n">_keV</span>
<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">k_B_over_keV</span> <span class="o">=</span> <span class="n">k_B</span> <span class="o">/</span> <span class="n">keV</span>

<span class="c">#-----------------------------------------------------------------------&gt;&gt;&gt;</span>
<span class="c"># &gt;&gt;&gt; User modifiable functions.</span>
<span class="c"># &gt;&gt;&gt; Note that the user is entirely free to wrap thread-safe and</span>
<span class="c"># ... non-parallel external C routines from an external library.</span>
<span class="c"># &gt;&gt;&gt; Thus the bodies of the following need not be written explicitly in</span>
<span class="c"># ... the Cython language.</span>
<span class="c">#-----------------------------------------------------------------------&gt;&gt;&gt;</span>
<span class="k">cdef</span> <span class="kt">void</span>* <span class="nf">init_hot</span><span class="p">(</span><span class="n">size_t</span> <span class="n">numThreads</span><span class="p">,</span> <span class="n">const</span> <span class="n">_preloaded</span> <span class="o">*</span><span class="n">const</span> <span class="n">preloaded</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c"># This function must match the free management routine free_hot()</span>
    <span class="c"># in terms of freeing dynamically allocated memory. This is entirely</span>
    <span class="c"># the user&#39;s responsibility to manage.</span>

    <span class="c"># Return NULL if dynamic memory is not required for the model.</span>
    <span class="k">return</span> <span class="bp">NULL</span>

<span class="k">cdef</span> <span class="kt">int</span> <span class="nf">free_hot</span><span class="p">(</span><span class="n">size_t</span> <span class="n">numThreads</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">const</span> <span class="n">data</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c"># This function must match the initialisation routine init_hot()</span>
    <span class="c"># in terms of freeing dynamically allocated memory. This is entirely</span>
    <span class="c"># the user&#39;s responsibility to manage.</span>
    <span class="c"># The void pointer must be appropriately cast before memory is freed --</span>
    <span class="c"># only the user can know this at compile time.</span>
    <span class="c"># Just use free(&lt;void*&gt; data) iff no memory was dynamically</span>
    <span class="c"># allocated in the function:</span>
    <span class="c">#   init_local_hot()</span>
    <span class="c"># because data is expected to be NULL in this case</span>

    <span class="c">#printf(&quot;\nNo data to be freed.&quot;)</span>

    <span class="k">return</span> <span class="n">SUCCESS</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">eval_hot</span><span class="p">(</span><span class="n">size_t</span> <span class="n">THREAD</span><span class="p">,</span>
                     <span class="n">double</span> <span class="n">E</span><span class="p">,</span>
                     <span class="n">double</span> <span class="n">mu</span><span class="p">,</span>
                     <span class="n">const</span> <span class="n">double</span> <span class="o">*</span><span class="n">const</span> <span class="n">VEC</span><span class="p">,</span>
                     <span class="n">void</span> <span class="o">*</span><span class="n">const</span> <span class="n">data</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c"># Arguments:</span>
    <span class="c"># E = photon energy in keV</span>
    <span class="c"># mu = cosine of ray zenith angle (i.e., angle to surface normal)</span>
    <span class="c"># VEC = variables such as temperature, effective gravity, ...</span>
    <span class="c"># data = numerical model data required for intensity evaluation</span>

    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">temp</span> <span class="o">=</span> <span class="n">k_B_over_keV</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">VEC</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span> <span class="o">/</span> <span class="p">(</span> <span class="n">exp</span><span class="p">(</span><span class="n">E</span> <span class="o">/</span> <span class="n">temp</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span>

<span class="k">cdef</span> <span class="kt">double</span> <span class="nf">eval_hot_norm</span><span class="p">()</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c"># Source radiation field normalisation which is independent of the</span>
    <span class="c"># parameters of the parametrised model -- i.e. cell properties, energy,</span>
    <span class="c"># and angle.</span>
    <span class="c"># Writing the normalisation here reduces the number of operations required</span>
    <span class="c"># during integration.</span>
    <span class="c"># The units of the specific intensity need to be J/cm^2/s/keV/steradian.</span>

    <span class="k">return</span> <span class="n">erg</span> <span class="o">*</span> <span class="n">Planck_dist_const</span>
</pre></div>
</div>
<p>In most use-cases we need to modify these functions to enable handling of the numerical atmosphere data. An extension for such a case may be found as an <a class="reference internal" href="surface_radiation_field.html#a-numerical-atmosphere"><span class="std std-ref">example</span></a>, which contains the extension used by <a class="reference internal" href="applications.html#riley-et-al-2019-apjl-887-l21"><span class="std std-ref">Riley et al.&nbsp;(2019)</span></a> to implement a numerical atmosphere generated by the NSX atmosphere code (<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2001MNRAS.327.1081H/abstract">Ho, W.C.G &amp; Lai, D. 2001</a>;
<a class="reference external" href="https://ui.adsabs.harvard.edu/link_gateway/2009Natur.462...71H/doi:10.1038/nature08525">Ho, W.C.G &amp; Heinke, C.O. 2009</a>), courtesy of W.C.G. Ho for NICER modeling efforts. A fully-ionized hydrogen atmosphere (Ho &amp; Lai 2001) was used in <a class="reference internal" href="applications.html#riley-et-al-2019-apjl-887-l21"><span class="std std-ref">Riley et al.&nbsp;(2019)</span></a>; also see Bogdanov et al.&nbsp;(2020).</p>
<p>In general, if you wish to change the model for the parametrised surface local-comoving-frame radiation field model, you can archive the extensions in, e.g., the <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/archive</span></code>, and completely replace the contents of <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/hot.pyx</span></code> when X-PSI is compiled and installed. Alternatively, you can compile your extension elsewhere and link it when X-PSI is installed (by editing the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script), <code class="docutils literal notranslate"><span class="pre">cimporting</span></code> or <code class="docutils literal notranslate"><span class="pre">extern</span></code>ing from the
appropriate <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> header file(s), and calling those precompiled binaries from the functions declared in the <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/hot.pxd</span></code> header.</p>
<p>We now instantiate hot region objects. We can find the required and optional parameter names in the class docstring:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="c1">#? # uncomment to query</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
xpsi.HotRegion.HotRegion
</pre></div></div>
</div>
<p>The names can also be found as class attributes as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="o">.</span><span class="n">required_names</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;super_colatitude&#39;,
 &#39;super_radius&#39;,
 &#39;phase_shift&#39;,
 &#39;super_temperature (if no custom specification)&#39;]
</pre></div></div>
</div>
<p>The condition <em>if no custom specification</em> means that this name is required if we do not supply custom parameters for the radiation field in the superseding member of the hot region. If we supply custom parameters, we also need to subclass <code class="docutils literal notranslate"><span class="pre">xpsi.HotRegion</span></code> and overwrite the <code class="docutils literal notranslate"><span class="pre">__compute_cellParamVecs</span></code> method to handle our parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="o">.</span><span class="n">optional_names</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;omit_colatitude&#39;,
 &#39;omit_radius&#39;,
 &#39;omit_azimuth&#39;,
 &#39;cede_colatitude&#39;,
 &#39;cede_radius&#39;,
 &#39;cede_azimuth&#39;,
 &#39;cede_temperature&#39;]
</pre></div></div>
</div>
<p>For the purpose of illustration, we <em>tie</em> the temperatures of the hot regions together: <em>this is where the model deviates from the examples directory as alluded to in the preamble of this tutorial</em>. There is more than one way to achieve this, but we will use the most powerful approach.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">super_colatitude</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
              <span class="n">super_radius</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
              <span class="n">phase_shift</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
              <span class="n">super_temperature</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

<span class="c1"># a simple circular, simply-connected spot</span>
<span class="n">primary</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">values</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># no initial values and no derived/fixed</span>
                            <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">omit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">cede</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">min_sqrt_num_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">max_sqrt_num_cells</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">num_leaves</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                            <span class="n">num_rays</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span> <span class="c1"># unique prefix needed because &gt;1 instance</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;super_colatitude&#34; with bounds [0.000e+00, 3.142e+00].
    &gt; The colatitude of the centre of the superseding region [radians].
Creating parameter:
    &gt; Named &#34;super_radius&#34; with bounds [0.000e+00, 1.571e+00].
    &gt; The angular radius of the (circular) superseding region [radians].
Creating parameter:
    &gt; Named &#34;phase_shift&#34; with bounds [-2.500e-01, 7.500e-01].
    &gt; The phase of the hot region, a periodic parameter [cycles].
Creating parameter:
    &gt; Named &#34;super_temperature&#34; with bounds [3.000e+00, 7.000e+00].
    &gt; log10(superseding region effective temperature [K]).
</pre></div></div>
</div>
<p>Note that since the atmospheric local-comoving-frame effective temperature is uniform everywhere within the hot region boundaries, we can use the default value of the <code class="docutils literal notranslate"><span class="pre">symmetry</span></code> keyword, <code class="docutils literal notranslate"><span class="pre">True</span></code>. All other arguments determine the numerical resolution, and have defaults which have been (somewhat arbitrarily) chosen to be result in a likelihood evaluation time of <span class="math notranslate nohighlight">\(\mathcal{O}(1)\)</span> s.</p>
<p>Let’s take a look at the <code class="docutils literal notranslate"><span class="pre">xpsi.Derive</span></code> docstring for guidance:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">Derive</span><span class="c1">#? # uncomment to query</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
xpsi.Parameter.Derive
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">derive</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Derive</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We can pass a reference to the primary here instead</span>
<span class="sd">        and store it as an attribute if there is risk of</span>
<span class="sd">        the global variable changing.</span>

<span class="sd">        This callable can for this simple case also be</span>
<span class="sd">        achieved merely with a function instead of a magic</span>
<span class="sd">        method associated with a class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundto</span><span class="p">,</span> <span class="n">caller</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># one way to get the required reference</span>
        <span class="k">global</span> <span class="n">primary</span> <span class="c1"># unnecessary, but for clarity</span>
        <span class="k">return</span> <span class="n">primary</span><span class="p">[</span><span class="s1">&#39;super_temperature&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.2</span>

<span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;super_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># declare fixed/derived variable</span>

<span class="n">secondary</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="c1"># can otherwise use same bounds</span>
                              <span class="n">values</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;super_temperature&#39;</span><span class="p">:</span> <span class="n">derive</span><span class="p">()},</span> <span class="c1"># create a callable value</span>
                              <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">omit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">cede</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                              <span class="n">min_sqrt_num_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">max_sqrt_num_cells</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                              <span class="n">num_leaves</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                              <span class="n">num_rays</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                              <span class="n">is_antiphased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="c1"># unique prefix needed because &gt;1 instance</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;super_colatitude&#34; with bounds [0.000e+00, 3.142e+00].
    &gt; The colatitude of the centre of the superseding region [radians].
Creating parameter:
    &gt; Named &#34;super_radius&#34; with bounds [0.000e+00, 1.571e+00].
    &gt; The angular radius of the (circular) superseding region [radians].
Creating parameter:
    &gt; Named &#34;phase_shift&#34; with bounds [-2.500e-01, 7.500e-01].
    &gt; The phase of the hot region, a periodic parameter [cycles].
Creating parameter:
    &gt; Named &#34;super_temperature&#34; that is derived from ulterior variables.
    &gt; log10(superseding region effective temperature [K]).
</pre></div></div>
</div>
<p>The description <em>derived from ulterior variables</em> means that when we lookup the value, it is calculated dynamically from the values of other (ulterior) model parameters. We clearly expect the temperature of the secondary hot region to behave in this way. A few other varibles do to because of keyword arguments passed upon instantiation of the hot regions. For example, the colatitude of the <em>zero-radii</em> omission and ceding regions (<code class="docutils literal notranslate"><span class="pre">omit=False</span></code> and <code class="docutils literal notranslate"><span class="pre">cede=False</span></code>) are equivalent to the
colatitude of the centre of the superseding region. The azimuths are <em>relative</em> to the superseding region, and are thus listed as being <em>fixed</em> at zero azimuthal separation. If one of <code class="docutils literal notranslate"><span class="pre">omit</span></code> or <code class="docutils literal notranslate"><span class="pre">cede</span></code> was <code class="docutils literal notranslate"><span class="pre">True</span></code>, and <code class="docutils literal notranslate"><span class="pre">concentric=True</span></code>, a similar setup is performed, but with the radius of <code class="docutils literal notranslate"><span class="pre">omit</span></code> or <code class="docutils literal notranslate"><span class="pre">cede</span></code> being free, fixed (at finite value, but zero achieves the same as <code class="docutils literal notranslate"><span class="pre">False</span></code> for both <code class="docutils literal notranslate"><span class="pre">omit</span></code> and <code class="docutils literal notranslate"><span class="pre">cede</span></code> keyword arguments), or derived.</p>
<p>We now need to encapsulate the hot region instances in a container with properties expected by the <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> class.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">xpsi</span> <span class="kn">import</span> <span class="n">HotRegions</span>

<span class="n">hot</span> <span class="o">=</span> <span class="n">HotRegions</span><span class="p">((</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Let’s check out the hot regions:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># &#39;p&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Free parameters
---------------
p__phase_shift: The phase of the hot region, a periodic parameter [cycles].
p__super_colatitude: The colatitude of the centre of the superseding region [radians].
p__super_radius: The angular radius of the (circular) superseding region [radians].
p__super_temperature: log10(superseding region effective temperature [K]).

Derived/fixed parameters
------------------------
p__cede_colatitude: The colatitude of the centre of the ceding region [radians].
p__cede_radius: The angular radius of the (circular) ceding region [radians].
p__cede_azimuth: The azimuth of the centre of the ceding region relative to the
centre of the superseding region [radians].
p__omit_colatitude: The colatitude of the centre of the omission region [radians].
p__omit_radius: The angular radius of the (circular) omission region [radians].
p__omit_azimuth: The azimuth of the centre of the omission region relative to the
centre of the superseding region [radians].
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># &#39;s&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Free parameters
---------------
s__phase_shift: The phase of the hot region, a periodic parameter [cycles].
s__super_colatitude: The colatitude of the centre of the superseding region [radians].
s__super_radius: The angular radius of the (circular) superseding region [radians].

Derived/fixed parameters
------------------------
s__super_temperature: log10(superseding region effective temperature [K]).
s__cede_colatitude: The colatitude of the centre of the ceding region [radians].
s__cede_radius: The angular radius of the (circular) ceding region [radians].
s__cede_azimuth: The azimuth of the centre of the ceding region relative to the
centre of the superseding region [radians].
s__omit_colatitude: The colatitude of the centre of the omission region [radians].
s__omit_radius: The angular radius of the (circular) omission region [radians].
s__omit_azimuth: The azimuth of the centre of the omission region relative to the
centre of the superseding region [radians].
</pre></div></div>
</div>
<p>A list of names, with the prefix, can also be accessed as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span> <span class="o">=</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">h</span><span class="o">.</span><span class="n">names</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;p__phase_shift&#39;,
 &#39;p__super_colatitude&#39;,
 &#39;p__super_radius&#39;,
 &#39;p__super_temperature&#39;,
 &#39;p__cede_colatitude&#39;,
 &#39;p__cede_radius&#39;,
 &#39;p__cede_azimuth&#39;,
 &#39;p__omit_colatitude&#39;,
 &#39;p__omit_radius&#39;,
 &#39;p__omit_azimuth&#39;]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span><span class="o">.</span><span class="n">prefix</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;p&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">h</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;phase_shift&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The phase of the hot region, a periodic parameter [cycles]
</pre></div></div>
</div>
<p>Let’s set a value for the temperature of the primary hot region:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hot</span><span class="p">[</span><span class="s1">&#39;p__super_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.0</span> <span class="c1"># equivalent to ``primary[&#39;super_temperature&#39;] = 6.0``</span>
</pre></div>
</div>
</div>
<p>Now let’s lookup the temperature of the secondary:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">secondary</span><span class="p">[</span><span class="s1">&#39;super_temperature&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.8
</pre></div></div>
</div>
<p>No value was set explicitly for this secondary temperature: it is looked up dynamically from that of the primary hot region.</p>
<p>Note that the following access will <em>not</em> work:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># hot[&#39;s__super_temperature&#39;]</span>
</pre></div>
</div>
</div>
<p>The reason for this is because the temperature of the secondary hot region is a <em>fixed/derived</em> variable. Only <em>free</em> model parameters are merged into larger spaces. A fixed/derived variable needs to be accessed via the subspace that directly encapsulates a reference to it.</p>
<p>We can now instantitate the photosphere:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">CustomPhotosphere</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Photosphere</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Implement method for imaging.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__super_temperature&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">],</span>
                          <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;s__super_temperature&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span> <span class="o">=</span> <span class="n">CustomPhotosphere</span><span class="p">(</span><span class="n">hot</span> <span class="o">=</span> <span class="n">hot</span><span class="p">,</span> <span class="n">elsewhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode_frequency</span> <span class="o">=</span> <span class="n">spacetime</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;mode_frequency&#34; with fixed value 3.000e+02.
    &gt; Coordinate frequency of the mode of radiative asymmetry in the
photosphere that is assumed to generate the pulsed signal [Hz].
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="p">[</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spacetime</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>Note that generally the <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> instance must have a prefix that matches a prefix given to a <code class="docutils literal notranslate"><span class="pre">Signal</span></code> instance to ensure the user achieves what they intend for likelihood evaluation; when the model defines multiple data subsets and thus multiple <a class="reference internal" href="signal.html#xpsi.Signal.Signal"><span class="std std-ref">Signal</span></a> instances, tagging the objects in this manner is a safety guard (in particular against inadvertently wasting compute resources sampling a distribution conditional on an unintended model). If there is
one <code class="docutils literal notranslate"><span class="pre">Photosphere</span></code> and one <code class="docutils literal notranslate"><span class="pre">Signal</span></code> object, the prefixes can simply be none because there is no potential ambiguity.</p>
<p>We do not model the surface radiation field <em>elsewhere</em>, and we thus leave the <code class="docutils literal notranslate"><span class="pre">elsewhere</span></code> keyword as <code class="docutils literal notranslate"><span class="pre">None</span></code> (the default). <em>Elsewhere</em> means on the surface, exterior to radiating hot regions that are typically expected to span a smaller angular extent; in the current version, the radiation from <em>elsewhere</em>, if explicitly computed is assumed to be time-invariant supposing the hot regions were not present. To account for radiation from <em>elsewhere</em>, a time-invariant signal is first computed,
meaning an axisymmetric surface local-comoving-frame radiation field is assumed. The time-dependent signals from the hot regions are then computed, and modified by subtracting the specific intensity that would otherwise be generated by the surface local-comoving-frame radiation field from <em>elsewhere</em> (i.e., in place of the hot regions).</p>
</div>
<div class="section" id="Star">
<h4>Star<a class="headerlink" href="#Star" title="Permalink to this headline">¶</a></h4>
<p>We can now combine the ambient spacetime, <code class="docutils literal notranslate"><span class="pre">spacetime</span></code>, and the embedded photosphere, <code class="docutils literal notranslate"><span class="pre">photosphere</span></code>, into a model star represented by an instance of <a class="reference internal" href="star.html#xpsi.Star.Star"><span class="std std-ref">Star</span></a>. We do not need to extend this class, so we can simply construct and instantiate a star as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Star</span><span class="p">(</span><span class="n">spacetime</span> <span class="o">=</span> <span class="n">spacetime</span><span class="p">,</span> <span class="n">photospheres</span> <span class="o">=</span> <span class="n">photosphere</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s check out the star object, which merged parameter subspaces associated with objects lower in the hierarchy:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Free parameters
---------------
mass: Gravitational mass [solar masses].
radius: Coordinate equatorial radius [km].
distance: Earth distance [kpc].
cos_inclination: Cosine of Earth inclination to rotation axis.
p__phase_shift: The phase of the hot region, a periodic parameter [cycles].
p__super_colatitude: The colatitude of the centre of the superseding region [radians].
p__super_radius: The angular radius of the (circular) superseding region [radians].
p__super_temperature: log10(superseding region effective temperature [K]).
s__phase_shift: The phase of the hot region, a periodic parameter [cycles].
s__super_colatitude: The colatitude of the centre of the superseding region [radians].
s__super_radius: The angular radius of the (circular) superseding region [radians].
</pre></div></div>
</div>
<p>Note that only the free parameters are merged into a subspace higher in the object hierarchy. The reason for this is that there is not a clear and common pattern (at present) for accessing fixed/derived variables outside of the primary subspace to which they belong. If you try hard enough, of course, you can still get at them.</p>
</div>
</div>
<div class="section" id="A-callable-likelihood-object">
<h3>A callable likelihood object<a class="headerlink" href="#A-callable-likelihood-object" title="Permalink to this headline">¶</a></h3>
<p>Given the objects constructed above and the relevant pre-compiled low-level code, we can now construct and instantiate a <em>callable</em> likelihood object. We do not need extend (via inheritance) the <a class="reference internal" href="likelihood.html#xpsi.Likelihood.Likelihood"><span class="std std-ref">Likelihood</span></a> class found the source code: this class simply combines all of the model objects defined above, performs some automatic operations given the properties of the those objects, and facilitates communication of those objects when it recieves a call
to evaluate the likelihood.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Likelihood</span><span class="p">(</span><span class="n">star</span> <span class="o">=</span> <span class="n">star</span><span class="p">,</span> <span class="n">signals</span> <span class="o">=</span> <span class="n">signal</span><span class="p">,</span>
                             <span class="n">num_energies</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
                             <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">externally_updated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s retrieve the total number of free model parameters merged into the full parameter space:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Free parameters
---------------
mass: Gravitational mass [solar masses].
radius: Coordinate equatorial radius [km].
distance: Earth distance [kpc].
cos_inclination: Cosine of Earth inclination to rotation axis.
p__phase_shift: The phase of the hot region, a periodic parameter [cycles].
p__super_colatitude: The colatitude of the centre of the superseding region [radians].
p__super_radius: The angular radius of the (circular) superseding region [radians].
p__super_temperature: log10(superseding region effective temperature [K]).
s__phase_shift: The phase of the hot region, a periodic parameter [cycles].
s__super_colatitude: The colatitude of the centre of the superseding region [radians].
s__super_radius: The angular radius of the (circular) superseding region [radians].
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">len</span><span class="p">(</span><span class="n">likelihood</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
11
</pre></div></div>
</div>
<p><strong>Note that if you want to modify the definition of the model parameter space you should restart the process of constructing a</strong> <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> <strong>object, instead of manipulating existing objects, for ultimate safety.</strong> (You can also restart the kernel although if this is required it is a bug.)</p>
<p>Let’s call the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object with the true model parameter values that we injected to generate the synthetic data rendered above, omitting background parameters. Note that you can switch the phase interpolant invoked from GSL by:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">set_phase_interpolant</span><span class="p">(</span><span class="s1">&#39;Akima&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Pre-<code class="docutils literal notranslate"><span class="pre">v0.6</span></code>, the interpolant choice was <code class="docutils literal notranslate"><span class="pre">'Steffen'</span></code>, but the default is now <code class="docutils literal notranslate"><span class="pre">'Akima'</span></code>, and this notebook was executed with this default.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span>
     <span class="mf">12.5</span><span class="p">,</span>
     <span class="mf">0.2</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
     <span class="mf">0.0</span><span class="p">,</span>
     <span class="mf">1.0</span><span class="p">,</span>
     <span class="mf">0.075</span><span class="p">,</span>
     <span class="mf">6.2</span><span class="p">,</span>
     <span class="mf">0.025</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span>
     <span class="mf">0.2</span><span class="p">]</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># source code changes since model was applied, so let&#39;s be a</span>
<span class="c1"># bit lenient when checking the likelihood function</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">26713.6136777</span><span class="p">],</span> <span class="mf">1.0e-6</span><span class="p">,</span>
                 <span class="n">physical_points</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;time = </span><span class="si">%.3f</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">))</span>

<span class="c1"># &gt; xpsi.set_phase_interpolant(&#39;Akima&#39;)</span>
<span class="c1"># Checking likelihood and prior evaluation before commencing sampling...</span>
<span class="c1"># Cannot import ``allclose`` function from NumPy.</span>
<span class="c1"># Using fallback implementation...</span>
<span class="c1"># Checking closeness of likelihood arrays:</span>
<span class="c1"># -2.67136012e+04 | -2.67136137e+04 .....</span>
<span class="c1"># Closeness evaluated.</span>
<span class="c1"># Log-likelihood value checks passed on root process.</span>
<span class="c1"># Checks passed.</span>
<span class="c1"># time = 0.571 s</span>

<span class="c1"># &gt; xpsi.set_phase_interpolant(&#39;Steffen&#39;)</span>
<span class="c1"># Checking likelihood and prior evaluation before commencing sampling...</span>
<span class="c1"># Cannot import ``allclose`` function from NumPy.</span>
<span class="c1"># Using fallback implementation...</span>
<span class="c1"># Checking closeness of likelihood arrays:</span>
<span class="c1"># -2.67136140e+04 | -2.67136137e+04 .....</span>
<span class="c1"># Closeness evaluated.</span>
<span class="c1"># Log-likelihood value checks passed on root process.</span>
<span class="c1"># Checks passed.</span>
<span class="c1"># time = 0.581 s</span>

<span class="c1"># &gt; xpsi.set_phase_interpolant(&#39;Cubic&#39;)</span>
<span class="c1"># Checking likelihood and prior evaluation before commencing sampling...</span>
<span class="c1"># Cannot import ``allclose`` function from NumPy.</span>
<span class="c1"># Using fallback implementation...</span>
<span class="c1"># Checking closeness of likelihood arrays:</span>
<span class="c1"># -2.67135656e+04 | -2.67136137e+04 .....</span>
<span class="c1"># Closeness evaluated.</span>
<span class="c1"># Log-likelihood value checks passed on root process.</span>
<span class="c1"># Checks passed. (increasing the tolerance to 1e-5)</span>
<span class="c1"># time = 0.720 s (consistently slower)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Checking likelihood and prior evaluation before commencing sampling...
Cannot import ``allclose`` function from NumPy.
Using fallback implementation...
Checking closeness of likelihood arrays:
-2.67136012e+04 | -2.67136137e+04 .....
Closeness evaluated.
Log-likelihood value checks passed on root process.
Checks passed.
time = 0.590 s
</pre></div></div>
</div>
<p>If the secondary temperature was free, we would extend the vector <code class="docutils literal notranslate"><span class="pre">p</span></code> by one element, passing the injected value of <code class="docutils literal notranslate"><span class="pre">6.0</span></code>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">secondary</span><span class="p">[</span><span class="s1">&#39;super_temperature&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
6.0
</pre></div></div>
</div>
<p>External sampling software will interact with a <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object in this way. That is, it will pass some ordered container of parameter values: a vector. However, this vector will be ignored if the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> instance is told it can safely assume all parameters have been updated <em>externally</em>, meaning before the call is placed to <code class="docutils literal notranslate"><span class="pre">likelihood.__call__()</span></code>. This external update will typically happen during <em>nested sampling</em> when a call is placed to a <code class="docutils literal notranslate"><span class="pre">prior</span></code> object to inverse sample
from the joint prior distribution. Our <code class="docutils literal notranslate"><span class="pre">prior</span></code> object can interact with our <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object outside of a sampling process, and thus we can encapsulate a reference to the parameter space in the <code class="docutils literal notranslate"><span class="pre">prior</span></code> instance and simply update the parameter values using easier handles (via <code class="docutils literal notranslate"><span class="pre">__getitem__</span></code> magic) to conclude an inverse sampled procedure.</p>
</div>
<div class="section" id="Inspecting-functionality">
<h3>Inspecting functionality<a class="headerlink" href="#Inspecting-functionality" title="Permalink to this headline">¶</a></h3>
<p>Calling the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object also modified the <code class="docutils literal notranslate"><span class="pre">signals</span></code> property of the <code class="docutils literal notranslate"><span class="pre">photosphere</span></code> object. Let’s plot the <code class="docutils literal notranslate"><span class="pre">signals</span></code> by summing the count-rate over output instrument channels. We first define a helper function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot_pulse</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Plot hot region signals before and after telescope operation. &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Signal [arbitrary normalisation]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase [cycles]&#39;</span><span class="p">)</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reinitialise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_pulse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_128_0.png" src="_images/model_construction_128_0.png" />
</div>
</div>
<p>The pulse-profiles with markers are the signals incident on the telescope, before operating on them with the response model. The markers, linearly spaced in phase, denote the phase resolution.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object calls the <code class="docutils literal notranslate"><span class="pre">star.update</span></code> method which in-turn calls the <code class="docutils literal notranslate"><span class="pre">photosphere.embed</span></code> method. The <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object then calls the <code class="docutils literal notranslate"><span class="pre">photosphere.integrate</span></code> method, passing the energies stored as the property <code class="docutils literal notranslate"><span class="pre">signal.energies</span></code>. We can do this manually if we wish to integrate signals but not calculate likelihoods. Here we sum over incident specific photon flux pulses as an approximation to integrating over energy. Note that we do not change the <code class="docutils literal notranslate"><span class="pre">signal.signals</span></code> traced
by the solid curves without markers.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">externally_updated</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># declare safe to assume updates performed before call</span>
<span class="n">xpsi</span><span class="o">.</span><span class="n">ParameterSubspace</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">likelihood</span><span class="p">)</span> <span class="c1"># no vector supplied</span>
<span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
<span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">plot_pulse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_131_0.png" src="_images/model_construction_131_0.png" />
</div>
</div>
<p>Notice the solid pulses without markers are unchanged from the plot a few cells above, and can be used to guide the eye to the effect of a change in Earth inclination.</p>
<p>Below we print crude representations of the cell meshes spanning each hot region. The elements of a mesh cell-area array which are finite are not all identical: at the boundary of a hot region the proper area elements are smaller because of partial coverage by radiating material. The sum of all finite proper areas effectively equals the total proper area within a hot-region boundary.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

<span class="c1"># primary (lower colatitude) hot region</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">_HotRegion__cellArea</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_HotRegion__cellArea</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">z</span><span class="p">,</span>
                         <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                         <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                         <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">,</span>
                         <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                         <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

<span class="c1"># secondary (higher colatitude) hot region</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">_HotRegion__cellArea</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">_HotRegion__cellArea</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">z</span><span class="p">,</span>
                   <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                   <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                   <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">,</span>
                   <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                   <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">ax_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span>
                  <span class="n">cax</span> <span class="o">=</span> <span class="n">ax_cb</span><span class="p">,</span>
                  <span class="n">ticks</span> <span class="o">=</span> <span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

<span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;cell area (normalised by maximum)&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">solids</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

<span class="n">veneer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax_cb</span><span class="p">)</span>
<span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_134_0.png" src="_images/model_construction_134_0.png" />
</div>
</div>
<p>Note that the lowest colatitude row is at zero on the y-axis.</p>
<p>Let’s plot a pulse in two dimensions. Also note that we can interpolate the signal in phase as follows.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">xpsi.tools</span> <span class="kn">import</span> <span class="n">phase_interpolator</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot_2D_pulse</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span>
                  <span class="n">num_rotations</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                  <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function to plot a phase-energy pulse.</span>

<span class="sd">    :param array-like z:</span>
<span class="sd">        A pair of *ndarray[m,n]* objects representing the signal at</span>
<span class="sd">        *n* phases and *m* values of an energy variable.</span>

<span class="sd">    :param ndarray[n] x: Phases the signal is resolved at.</span>

<span class="sd">    :param tuple shift: Hot region phase parameters.</span>

<span class="sd">    :param ndarray[m] x: Energy values the signal is resolved at.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">new_phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">num_rotations</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                      <span class="n">x</span><span class="p">,</span>
                                      <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">interpolated</span> <span class="o">+=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                       <span class="n">x</span><span class="p">,</span>
                                       <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                             <span class="n">y</span><span class="p">,</span>
                             <span class="n">interpolated</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">interpolated</span><span class="p">),</span>
                             <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="p">,</span>
                             <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">profile</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">num_rotations</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Phase&#39;</span><span class="p">)</span>
    <span class="n">veneer</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span>
                      <span class="n">cax</span> <span class="o">=</span> <span class="n">ax_cb</span><span class="p">,</span>
                      <span class="n">ticks</span> <span class="o">=</span> <span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>

    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Signal (normalised by maximum)&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">solids</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="n">veneer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax_cb</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The incident specific flux signal, in units of photons/cm<span class="math notranslate nohighlight">\(^{2}\)</span>/s/keV as output by the source code, and then normalised to the maximum in specific flux:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">shift</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">shifts</span><span class="p">,</span>
              <span class="n">y</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_140_0.png" src="_images/model_construction_140_0.png" />
</div>
</div>
<p>The count rate signal in each channel:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">signal</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">signal</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">shift</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">shifts</span><span class="p">,</span>
              <span class="n">y</span><span class="o">=</span><span class="n">NICER</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_142_0.png" src="_images/model_construction_142_0.png" />
</div>
</div>
<p>Now we increase the phase resolution, and plot a single rotational pulse:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">set_phases</span><span class="p">(</span><span class="n">num_leaves</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">)</span>
<span class="c1"># the current relationship between objects requires that we reinitialise</span>
<span class="c1"># if we wish to automatically communicate the updated settings between objects</span>
<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># set inclination</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">likelihood</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reinitialise</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Note that reinitialisation also returned the following to default:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">externally_updated</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
False
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">signal</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">signal</span><span class="o">.</span><span class="n">signals</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">shift</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">shifts</span><span class="p">,</span>
              <span class="n">y</span><span class="o">=</span><span class="n">NICER</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Channels&#39;</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">,</span>
              <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_147_0.png" src="_images/model_construction_147_0.png" />
</div>
</div>
<p>Let’s iterate over a monotonically increasing set of values of the hot-region angular radius. Note that we use the keyword <code class="docutils literal notranslate"><span class="pre">threads</span></code> to directly instruct the low-level routines how many OpenMP threads to spawn to accelerate the computation. Usually the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object instructs the low-level routines how many threads to spawn, based on it’s <code class="docutils literal notranslate"><span class="pre">thread</span></code> property:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">threads</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1
</pre></div></div>
</div>
<p>Given that we are not currently using the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object as a callback function passed to posterior sampling software (which parallelises efficiently using MPI), we can safely spawn additional OpenMP threads for signal integration; if likelihood evaluations are parallelised in an MPI environment on the other hand, one risks <em>losing</em> efficiency by spawning OpenMP threads for likelihood evaluation.</p>
<p>For objects that derive from <code class="docutils literal notranslate"><span class="pre">ParameterSubspace</span></code> we can get the current parameter vector in several ways:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.4,
 12.5,
 0.2,
 0.5403023058681398,
 0.0,
 1.0,
 0.075,
 6.2,
 0.025,
 2.141592653589793,
 0.2]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span><span class="p">()</span> <span class="o">==</span> <span class="n">star</span><span class="o">.</span><span class="n">vector</span> <span class="c1"># possible shortcut to save some characters</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Likelihood</span></code> subclass overrides the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> dunder, however, so we have to access it in the following ways:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">super</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Likelihood</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">()</span> <span class="o">==</span> <span class="n">likelihood</span><span class="o">.</span><span class="n">vector</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>Note that we did not define any other parameters other than those associated with the <code class="docutils literal notranslate"><span class="pre">star</span></code>, and thus:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">len</span><span class="p">(</span><span class="n">likelihood</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">star</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>Finally, let’s play with some geometric parameters:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;photons/cm$^2$/s/keV (normalised by maxima)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase [cycles]&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">set_phases</span><span class="p">(</span><span class="n">num_leaves</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span>

<span class="c1"># let&#39;s play with the angular radius of the primary hot region</span>
<span class="n">angular_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">externally_updated</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.25</span><span class="p">)</span>

<span class="k">for</span> <span class="n">angular_radius</span> <span class="ow">in</span> <span class="n">angular_radii</span><span class="p">:</span>
    <span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angular_radius</span> <span class="c1"># play time</span>
    <span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">angular_radius</span> <span class="ow">in</span> <span class="n">angular_radii</span><span class="p">:</span>
    <span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angular_radius</span>
    <span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">angular_radius</span> <span class="ow">in</span> <span class="n">angular_radii</span><span class="p">:</span>
    <span class="n">likelihood</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angular_radius</span>
    <span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_159_0.png" src="_images/model_construction_159_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Prior">
<h2>Prior<a class="headerlink" href="#Prior" title="Permalink to this headline">¶</a></h2>
<p>Let us now construct a callable object representing a joint prior density distribution on the space <span class="math notranslate nohighlight">\(\mathbb{R}^{d}\)</span>. We need to extend the base class to implement our distribution, which with respect to some parameters is separable, but for others it is <em>uniform</em> on a joint space, and compactly supported according to non-trivial constraint equations.</p>
<p>As an example gravitational mass and equatorial radius: a joint constraint is imposed to assign zero density to stars which are <em>too</em> compact: the polar radius, in units of the gravitational radius, of the rotationally deformed stellar 2-surface is too small.</p>
<div class="section" id="Custom-subclass">
<h3>Custom subclass<a class="headerlink" href="#Custom-subclass" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">truncnorm</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">CustomPrior</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Prior</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A custom (joint) prior distribution.</span>

<span class="sd">    Source: Fictitious</span>
<span class="sd">    Model variant: ST-U</span>
<span class="sd">        Two single-temperature, simply-connected circular hot regions with</span>
<span class="sd">        unshared parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__derived_names__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;compactness&#39;</span><span class="p">,</span> <span class="s1">&#39;phase_separation&#39;</span><span class="p">,]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Nothing to be done.</span>

<span class="sd">        A direct reference to the spacetime object could be put here</span>
<span class="sd">        for use in __call__:</span>

<span class="sd">        .. code-block::</span>

<span class="sd">            self.spacetime = ref</span>

<span class="sd">        Instead we get a reference to the spacetime object through the</span>
<span class="sd">        a reference to a likelihood object which encapsulates a</span>
<span class="sd">        reference to the spacetime object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CustomPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span> <span class="c1"># not strictly required if no hyperparameters</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate distribution at ``p``.</span>

<span class="sd">        :param list p: Model parameter values.</span>

<span class="sd">        :returns: Logarithm of the distribution evaluated at ``p``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CustomPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">temp</span>

        <span class="c1"># based on contemporary EOS theory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">16.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">spacetime</span> <span class="c1"># shortcut</span>

        <span class="c1"># limit polar radius to try to exclude deflections &gt;= \pi radians</span>
        <span class="c1"># due to oblateness this does not quite eliminate all configurations</span>
        <span class="c1"># with deflections &gt;= \pi radians</span>
        <span class="n">R_p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.788</span> <span class="o">+</span> <span class="mf">1.030</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">zeta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">R_p</span> <span class="o">&lt;</span> <span class="mf">1.76</span> <span class="o">/</span> <span class="n">ref</span><span class="o">.</span><span class="n">R_r_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># polar radius at photon sphere for ~static star (static ambient spacetime)</span>
        <span class="c1">#if R_p &lt; 1.5 / ref.R_r_s:</span>
        <span class="c1">#    return -np.inf</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.788</span> <span class="o">+</span> <span class="mf">1.030</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">zeta</span><span class="p">)))</span>

        <span class="c1"># 2-surface cross-section have a single maximum in |z|</span>
        <span class="c1"># i.e., an elliptical surface; minor effect on support, if any,</span>
        <span class="c1"># for high spin frequenies</span>
        <span class="k">if</span> <span class="n">mu</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="c1"># redefine shortcut</span>

        <span class="c1"># enforce order in hot region colatitude</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">_2pi</span>

        <span class="n">ang_sep</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">],</span>
                                     <span class="n">phi</span><span class="p">,</span>
                                     <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">])</span>

        <span class="c1"># hot regions cannot overlap</span>
        <span class="k">if</span> <span class="n">ang_sep</span> <span class="o">&lt;</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">inverse_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypercube</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Draw sample uniformly from the distribution via inverse sampling. &quot;&quot;&quot;</span>

        <span class="n">to_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">vector</span>

        <span class="k">if</span> <span class="n">hypercube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hypercube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># the base method is useful, so to avoid writing that code again:</span>
        <span class="n">_</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CustomPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">(</span><span class="n">hypercube</span><span class="p">)</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="c1"># shortcut</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncnorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># flat priors in cosine of hot region centre colatitudes (isotropy)</span>
        <span class="c1"># support modified by no-overlap rejection condition</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="c1"># restore proper cache</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">cache</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">to_cache</span><span class="p">):</span>
            <span class="n">parameter</span><span class="o">.</span><span class="n">cached</span> <span class="o">=</span> <span class="n">cache</span>

        <span class="c1"># it is important that we return the desired vector because it is</span>
        <span class="c1"># automatically written to disk by MultiNest and only by MultiNest</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">vector</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A transformation for post-processing. &quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c1"># copy</span>

        <span class="c1"># used ordered names and values</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

        <span class="c1"># compactness ratio M/R_eq</span>
        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gravradius</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]]</span>

        <span class="c1"># phase separation between hot regions</span>
        <span class="c1"># first some temporary variables:</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span>

        <span class="n">temp_s</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">temp_s</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">temp_s</span> <span class="o">=</span> <span class="n">temp_s</span> <span class="o">-</span> <span class="mf">1.0</span>

        <span class="c1"># now append:</span>
        <span class="k">if</span> <span class="n">temp_s</span> <span class="o">&gt;=</span> <span class="n">temp_p</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">temp_s</span> <span class="o">-</span> <span class="n">temp_p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">temp_p</span> <span class="o">+</span> <span class="n">temp_s</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">len</span><span class="p">(</span><span class="n">likelihood</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
11
</pre></div></div>
</div>
<p>We can now construct and instantiate a callable <code class="docutils literal notranslate"><span class="pre">prior</span></code> object, pass it to the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object, which stores a mutual reference to itself in <code class="docutils literal notranslate"><span class="pre">prior</span></code>. Note that if you have hyperparameters defined in the parameter subspace of <code class="docutils literal notranslate"><span class="pre">prior</span></code>, the prior needs to be passed upon instantiation of the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object so that the hyperparameters get merged into the global parameter space; this is not demonstrated in this tutorial.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prior</span> <span class="o">=</span> <span class="n">CustomPrior</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No parameters supplied... empty subspace created.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span> <span class="c1"># if there were hyperparameters, can merge them in</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">prior</span><span class="p">)</span> <span class="c1"># if there were hyperparameters, can merge them in</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">externally_updated</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># already set above, but for clarity</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prior</span><span class="p">()</span> <span class="c1"># a parameter vector is already stored</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0.0
</pre></div></div>
</div>
<p>We also defined a transform method:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prior</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1.4,
 12.5,
 0.2,
 0.5403023058681398,
 0.0,
 1.0,
 0.075,
 6.2,
 0.025,
 2.141592653589793,
 0.2,
 0.16538201343999998,
 0.525]
</pre></div></div>
</div>
<p>The penultimate entry is the compactness ratio M/R_eq, which should have a familar magnitude. The last entry is the phase separation in cycles.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">prior.inverse_sample()</span></code> method is required by <a class="reference external" href="https://github.com/farhanferoz/MultiNest">MultiNest</a> to uniformly sample from the prior distribution and transform it into a posterior distribution. Let’s call the method, passing a vector of pseudorandom numbers drawn when each is drawn from a uniform distribution on the interval <span class="math notranslate nohighlight">\([0,1)\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2.3341954824001987,
 10.60195054536041,
 0.27819953864231406,
 0.042268943830421346,
 0.0345120220181776,
 1.1337904971368222,
 0.7049490311536339,
 5.134168474700057,
 0.6039657445287777,
 2.008663413095534,
 0.4223272254536369]
</pre></div></div>
</div>
<p>In principle, inverse sampling from the prior can be used to initialise the ensemble of walkers evolved by <a class="reference external" href="http://emcee.readthedocs.io/en/latest/">emcee</a>.</p>
</div>
<div class="section" id="Density-and-support-checking">
<h3>Density and support checking<a class="headerlink" href="#Density-and-support-checking" title="Permalink to this headline">¶</a></h3>
<p>Let’s draw samples from the prior and plot them:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Drawing samples from the joint prior...
Samples drawn.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">plot_samps</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot samples as 2D scatter plot. &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">samps</span><span class="p">[:,</span><span class="n">x</span><span class="p">],</span> <span class="n">samps</span><span class="p">[:,</span><span class="n">y</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">veneer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Let’s first plot the <span class="math notranslate nohighlight">\((M, R_{\rm eq})\)</span> samples:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_samps</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">),</span> <span class="c1"># we can find the index for __getitem__ magic</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;mass&#39;</span><span class="p">),</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">symbol</span> <span class="o">+</span> <span class="s1">&#39; [km]&#39;</span><span class="p">,</span> <span class="c1"># can use symbols like so</span>
                <span class="sa">r</span><span class="s1">&#39;$M$ [M$_{\odot}$]&#39;</span><span class="p">)</span> <span class="c1"># or manual entry</span>

<span class="c1"># the Schwarzschild photon sphere R_eq = 1.5 x r_s(M)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gravradius</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mi">100</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>

<span class="c1"># R_eq = 1.76 x r_s(M)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="mf">1.76</span><span class="o">*</span><span class="n">gravradius</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mi">100</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">,</span><span class="mi">100</span><span class="p">),</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_184_0.png" src="_images/model_construction_184_0.png" />
</div>
</div>
<p>Note that the prior support is defined with a constraint that the polar radius <span class="math notranslate nohighlight">\(R_{\rm p}(R_{\rm eq}, M, \Omega)\geq 1.76r_{s}(M)\)</span>, which is why there is a region devoid of samples between the prior support and the dashed line <span class="math notranslate nohighlight">\(R_{\rm eq} = 1.76r_s(M)\)</span>. This condition is not necessary though because as of <code class="docutils literal notranslate"><span class="pre">v0.6</span></code>, X-PSI can include higher-order images, with the secondary and tertiary expected to be entirely sufficient in practice.</p>
<p>Let’s now plot the hot region (circular spot) colatitudes:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">plot_samps</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">),</span>
                <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">),</span>
                <span class="sa">r</span><span class="s1">&#39;$\Theta_</span><span class="si">{p}</span><span class="s1">$ [radians]&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\Theta_</span><span class="si">{s}</span><span class="s1">$ [radians]&#39;</span><span class="p">)</span>

<span class="c1"># enforce colatitude order to distinguish hot regions as primary and secondary</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">]),</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_187_0.png" src="_images/model_construction_187_0.png" />
</div>
</div>
<p>Note that the samples, marginalised over other region geometry parameters, are sparser when both hot regions approach the poles because we exclude overlapping configurations from the prior support. This is because the hot regions are by convention defined as disjoint, and cannot merge. If one wanted a more complex hot region, one would not invoke multiple hot regions that are permitted to overlap, but one would instead handle the extra complexity within the <code class="docutils literal notranslate"><span class="pre">HotRegion</span></code> class or a subclass.</p>
<p>Let’s plot the angular radii of the spots:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plot_samps</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span>
               <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">),</span>
               <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">),</span>
               <span class="sa">r</span><span class="s1">&#39;$\zeta_</span><span class="si">{p}</span><span class="s1">$ [radians]&#39;</span><span class="p">,</span>
               <span class="sa">r</span><span class="s1">&#39;$\zeta_</span><span class="si">{s}</span><span class="s1">$ [radians]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_190_0.png" src="_images/model_construction_190_0.png" />
</div>
</div>
<p>Note that the prior density is greater for hot regions that subtend smaller solid angles at the centre of the star, which also derives from the non-overlapping criterion for prior support.</p>
<p>Finally, let’s take a look at the phases:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plot_samps</span><span class="p">(</span><span class="n">samps</span><span class="p">,</span>
               <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">),</span>
               <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">),</span>
               <span class="sa">r</span><span class="s1">&#39;$\phi_</span><span class="si">{p}</span><span class="s1">$ [cycles]&#39;</span><span class="p">,</span>
               <span class="sa">r</span><span class="s1">&#39;$\phi_</span><span class="si">{s}</span><span class="s1">$ [cycles]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_193_0.png" src="_images/model_construction_193_0.png" />
</div>
</div>
<p>Note that again because the hot regions cannot overlap, rarefaction occurs in the vicinity of lines of minimal phase separation. Note that the boundaries are all periodic, so this pattern tesselates. Because we implemented a transformation in our <code class="docutils literal notranslate"><span class="pre">CustomPrior</span></code> subclass, we can actually draw the samples and transform them, which is useful in post-processing contexts. We defined the intervals <code class="docutils literal notranslate"><span class="pre">[-0.25,</span> <span class="pre">0.75]</span></code> for the inverse sampling so that the posterior mode(s) will not be near a boundary.
The nested sampling algorithm can handle periodic boundaries by defining <code class="docutils literal notranslate"><span class="pre">wrapped</span></code> parameters; however, this can be trivially avoided altogether by rough inspection of the phases of the subpulses in the data, which we can see above are at around <span class="math notranslate nohighlight">\(-0.1\)</span> and <span class="math notranslate nohighlight">\(0.4\)</span> given the respective ground truth (injected) phases of <span class="math notranslate nohighlight">\(\phi_{p}=0.0\)</span> and <span class="math notranslate nohighlight">\(\phi_{s}=0.025\)</span>.</p>
<p>Transformations for the purpose of likelihood evaluation must be handled in the <code class="docutils literal notranslate"><span class="pre">inverse_sample</span></code> method of an instance of the <code class="docutils literal notranslate"><span class="pre">Prior</span></code> class, but additional transformations that <em>extend</em> the parameter vector are written in the <code class="docutils literal notranslate"><span class="pre">transform</span></code> method.</p>
<p>If we wanted to transform automatically upon drawing the samples, thereby extending the parameter vectors passed to the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method (so be careful with wrap-around indices when evaluating prior support conditions), we would do the following:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samps_plus_transformed</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Drawing samples from the joint prior...
Samples drawn.
</pre></div></div>
</div>
<p>We defined a transformation from the hot region centre phases to the phase separation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_</span> <span class="o">=</span> <span class="n">plot_samps</span><span class="p">(</span><span class="n">samps_plus_transformed</span><span class="p">,</span>
               <span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">),</span>
               <span class="n">likelihood</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;phase_separation&#39;</span><span class="p">),</span>
               <span class="sa">r</span><span class="s1">&#39;$\phi_</span><span class="si">{p}</span><span class="s1">$ [cycles]&#39;</span><span class="p">,</span>
               <span class="sa">r</span><span class="s1">&#39;$\Delta\phi$ [cycles]&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_199_0.png" src="_images/model_construction_199_0.png" />
</div>
</div>
<p>We can see the rarefaction occurs for <span class="math notranslate nohighlight">\(\Delta\phi\sim0.0=1.0\)</span>.</p>
<p>The marginal one-dimensional prior distributions are overplotted, by the <a class="reference internal" href="postprocessing.html"><span class="doc">PostProcessing</span></a> module, with the posterior distributions.</p>
<p>It is recommended to carefully inspect joint prior samples for pairs of parameters before commencing a sampling run, especially if there is a non-trivial constraint equation imposed on the prior support.</p>
</div>
</div>
<div class="section" id="Sampling-interface">
<h2>Sampling interface<a class="headerlink" href="#Sampling-interface" title="Permalink to this headline">¶</a></h2>
<p>We have constructed and instantiated both a callable <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> object and a callable <code class="docutils literal notranslate"><span class="pre">prior</span></code> object. We could proceed, for example, to apply the open-source sampler <a class="reference external" href="http://emcee.readthedocs.io/en/latest/">emcee</a> to the joint posterior distribution proportional to the product of the (exponentiated) calls to the <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> and <code class="docutils literal notranslate"><span class="pre">prior</span></code> objects.</p>
<div class="section" id="Ensemble-MCMC">
<h3>Ensemble MCMC<a class="headerlink" href="#Ensemble-MCMC" title="Permalink to this headline">¶</a></h3>
<p>To prove that the objects constructed above can be fed to the <code class="docutils literal notranslate"><span class="pre">emcee</span></code> sampler, let’s run a number of iterations using a single Python process. We will initialise the ensemble by drawing from a multivariate Gaussian with mean vector equal to the ground truth (injected) vector.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">std</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>
         <span class="mf">0.05</span><span class="p">,</span>
         <span class="mf">1.0</span><span class="p">,</span>
         <span class="mf">0.01</span><span class="p">,</span>
         <span class="mf">0.05</span><span class="p">,</span>
         <span class="mf">0.0025</span><span class="p">,</span>
         <span class="mf">0.01</span><span class="p">,</span>
         <span class="mf">0.05</span><span class="p">,</span>
         <span class="mf">0.05</span><span class="p">,</span>
         <span class="mf">0.01</span><span class="p">,</span>
         <span class="mf">0.01</span><span class="p">]</span>

<span class="n">runtime_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resume&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;root_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;./&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;nwalkers&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                  <span class="s1">&#39;nsteps&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="s1">&#39;walker_dist_moments&#39;</span><span class="p">:</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">std</span><span class="p">)}</span> <span class="c1">#  if resume then ``None``</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
    <span class="n">h</span><span class="o">.</span><span class="n">set_phases</span><span class="p">(</span><span class="n">num_leaves</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># revert to original phase resolution above</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">reinitialise</span><span class="p">()</span> <span class="c1"># because we played with the object above</span>

<span class="c1"># Use MPI=False for testing purposes</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">ensemble</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span>
                               <span class="n">MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">runtime_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imported emcee version: 3.0.1

Commencing posterior sampling.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 100/100 [43:55&lt;00:00, 26.35s/it]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Sampling complete.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># clean up the docs/source directory</span>
<span class="c1">#!rm samples.h5; rm -r old_samples</span>
</pre></div>
</div>
</div>
<p>Note that we could also try initialising the ensemble by inverse sampling the joint prior distribution.</p>
<p>Let’s quickly plot the evolution of the ensemble Markov chains to prove that the sampling process commenced and is behaving in a somewhat reasonable manner:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">backend</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">emcee</span>
    <span class="n">backend</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">HDFBackend</span><span class="p">(</span><span class="s1">&#39;samples.h5&#39;</span><span class="p">)</span>

<span class="n">chain</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>

<span class="c1"># These chains plotted were generated using</span>
<span class="c1"># v0.2 so the labels here are in a different</span>
<span class="c1"># order. The model also had two free</span>
<span class="c1"># temperature parameters instead of just one.</span>
<span class="c1"># Also, inclination was the parameter, not</span>
<span class="c1"># cos(inclination), and the prior was flat</span>
<span class="c1"># in inclination, not cos(inclination).</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$D$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$M$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$R_{\rm eq}$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$\cos(i)$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$\phi_</span><span class="si">{p}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$\Theta_</span><span class="si">{p}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$\zeta_</span><span class="si">{p}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$T_</span><span class="si">{p}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$\phi_</span><span class="si">{s}</span><span class="s1">$&#39;</span>
          <span class="sa">r</span><span class="s1">&#39;$\Theta_</span><span class="si">{s}</span><span class="s1">$&#39;</span><span class="p">,</span>
          <span class="sa">r</span><span class="s1">&#39;$\zeta_</span><span class="si">{s}</span><span class="s1">$&#39;</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">32</span><span class="p">))</span>

<span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">chain</span><span class="p">[:,</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Steps&#39;</span><span class="p">)</span>
    <span class="n">veneer</span><span class="p">((</span><span class="mi">250</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_210_0.png" src="_images/model_construction_210_0.png" />
</div>
</div>
<p>The chains rendered in the documentation were run on a desktop machine in about a day of wall-time. It is visually discernable that the ensemble distribution has not yet evolved to a stationary state: a rigourous application of ensemble MCMC would cover convergence criteria, auto-correlation, and examination of sensitivity to initial conditions and the transition kernel. In fact, based on the analysis with nested sampling on path <code class="docutils literal notranslate"><span class="pre">xpsi/examples/default_background</span></code>, we know that the posterior
mode in the vicinity of the above ensemble is rather non-linear in the space being sampled, so ensemble MCMC may require <em>many</em> steps in order to argue for convergence.</p>
</div>
<div class="section" id="Nested-sampling">
<h3>Nested sampling<a class="headerlink" href="#Nested-sampling" title="Permalink to this headline">¶</a></h3>
<p>We interface with the nested sampler MultiNest in a similar manner, by defining some runtime settings, and then passing those settings together with <code class="docutils literal notranslate"><span class="pre">likelihood</span></code> and <code class="docutils literal notranslate"><span class="pre">prior</span></code> objects to a wrapper from the <a class="reference internal" href="sample.html"><span class="doc">Sample</span></a> module. We will run the sampler for a specified number (1000) of nested replacements (iterations). Note that the output below was actually generated with the temperature of the secondary hot region as a <em>free</em> parameter, resulting in an additional dimension to the
model above.</p>
<p>The environment variable <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> must be set before launching Jupyter as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ export LD_LIBRARY_PATH=&lt;path/to/multinest&gt;/lib
</pre></div>
</div>
<p>Get the parameters that are periodic or <em>wrapped</em> to inform MultiNest of boundary properties:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">wrapped_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">likelihood</span><span class="p">)</span>
<span class="n">wrapped_params</span><span class="p">[</span><span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">wrapped_params</span><span class="p">[</span><span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">runtime_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resume&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;importance_nested_sampling&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;multimodal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;n_clustering_params&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="s1">&#39;outputfiles_basename&#39;</span><span class="p">:</span> <span class="s1">&#39;./run/run&#39;</span><span class="p">,</span> <span class="c1"># make ./run directory manually</span>
                  <span class="s1">&#39;n_iter_before_update&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                  <span class="s1">&#39;n_live_points&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="s1">&#39;sampling_efficiency&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
                  <span class="s1">&#39;const_efficiency_mode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;wrapped_params&#39;</span><span class="p">:</span> <span class="n">wrapped_params</span><span class="p">,</span>
                  <span class="s1">&#39;evidence_tolerance&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                  <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1"># manual termination condition for short test</span>
                  <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
    <span class="n">h</span><span class="o">.</span><span class="n">set_phases</span><span class="p">(</span><span class="n">num_leaves</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">reinitialise</span><span class="p">()</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>

<span class="c1"># inform source code that parameter objects updated when inverse sampling</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">externally_updated</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span>
     <span class="mf">12.5</span><span class="p">,</span>
     <span class="mf">0.2</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
     <span class="mf">0.0</span><span class="p">,</span>
     <span class="mf">1.0</span><span class="p">,</span>
     <span class="mf">0.075</span><span class="p">,</span>
     <span class="mf">6.2</span><span class="p">,</span>
     <span class="mf">0.025</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span>
     <span class="mf">0.2</span><span class="p">]</span>

<span class="c1"># let&#39;s require that checks pass before starting to sample</span>
<span class="n">check_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">hypercube_points</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">physical_points</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="c1"># externally_updated preserved</span>
                    <span class="n">loglikelihood_call_vals</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">26713.613677</span><span class="p">],</span> <span class="c1"># from above</span>
                    <span class="n">rtol_loglike</span> <span class="o">=</span> <span class="mf">1.0e-6</span><span class="p">)</span> <span class="c1"># choose a tolerance</span>

<span class="c1"># note that mutual refs are already stored in the likelihood and prior</span>
<span class="c1"># objects to facilitate communication externally of the sampling process</span>
<span class="n">xpsi</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">nested</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="n">check_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">runtime_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imported PyMultiNest.
Checking likelihood and prior evaluation before commencing sampling...
Cannot import ``allclose`` function from NumPy...
Using fallback implementation...
Log-likelihood value checks passed on root process.
Checks passed.
Commencing integration...
Estimating fractional hypervolume of the unit hypercube with finite prior density:
Requiring 1E+05 draws from the prior support for Monte Carlo estimation...
Drawing samples from the joint prior...
Samples drawn.
The support occupies an estimated 11.9% of the hypervolume within the unit hypercube...
Fractional hypervolume estimated.
Sampling efficiency set to: 6.7485.
</pre></div></div>
</div>
<p>The verbose output of the MultiNest program is by default directed to the host terminal session. Instead of trying to redirect that output to that of the above cell, we simply copy and paste the output from the terminal below. For the purpose of illustration, this output was for a 12-dimensional model variant (as for the emcee plot above).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*****************************************************</span>
<span class="n">MultiNest</span> <span class="n">v3</span><span class="o">.</span><span class="mi">11</span>
<span class="n">Copyright</span> <span class="n">Farhan</span> <span class="n">Feroz</span> <span class="o">&amp;</span> <span class="n">Mike</span> <span class="n">Hobson</span>
<span class="n">Release</span> <span class="n">Apr</span> <span class="mi">2018</span>

<span class="n">no</span><span class="o">.</span> <span class="n">of</span> <span class="n">live</span> <span class="n">points</span> <span class="o">=</span>  <span class="mi">100</span>

<span class="n">dimensionality</span> <span class="o">=</span>   <span class="mi">12</span>
<span class="o">*****************************************************</span>
<span class="n">Starting</span> <span class="n">MultiNest</span>
<span class="n">generating</span> <span class="n">live</span> <span class="n">points</span>
 <span class="n">live</span> <span class="n">points</span> <span class="n">generated</span><span class="p">,</span> <span class="n">starting</span> <span class="n">sampling</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.724638</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">100</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                               <span class="mi">138</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>            <span class="o">**************</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.649351</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">150</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                               <span class="mi">231</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>            <span class="o">-</span><span class="mf">116670.287917</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.569801</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">200</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                               <span class="mi">351</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>            <span class="o">-</span><span class="mf">115291.669431</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.449640</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">250</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                               <span class="mi">556</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>            <span class="o">-</span><span class="mf">108499.449911</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.408719</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">300</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                               <span class="mi">734</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">95430.022790</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.367261</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">350</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                               <span class="mi">953</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">77360.112633</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.319744</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">400</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">1251</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">66119.380404</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.263930</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">450</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">1705</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">57607.930990</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.213675</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">500</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">2340</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">53505.956949</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.173119</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">550</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">3177</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">50428.177797</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.147893</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">600</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">4057</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">47108.755667</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.132653</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">650</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">4900</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">43437.007007</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.125381</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">700</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">5583</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">39888.092691</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.113533</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">750</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">6606</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">36841.337131</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.100251</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">800</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">7980</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">34450.919514</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.088450</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">850</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                              <span class="mi">9610</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">32545.531967</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.080121</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">900</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                             <span class="mi">11233</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">31270.147897</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.069674</span>
<span class="n">Replacements</span><span class="p">:</span>                                <span class="mi">950</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                             <span class="mi">13635</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">30103.155016</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.064201</span>
<span class="n">Replacements</span><span class="p">:</span>                               <span class="mi">1000</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                             <span class="mi">15576</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">29365.169148</span>
<span class="n">Acceptance</span> <span class="n">Rate</span><span class="p">:</span>                        <span class="mf">0.058427</span>
<span class="n">Replacements</span><span class="p">:</span>                               <span class="mi">1050</span>
<span class="n">Total</span> <span class="n">Samples</span><span class="p">:</span>                             <span class="mi">17971</span>
<span class="n">Nested</span> <span class="n">Sampling</span> <span class="n">ln</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>             <span class="o">-</span><span class="mf">28879.280235</span>
 <span class="n">ln</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span><span class="o">=</span>  <span class="o">-</span><span class="mf">28879.280235090871</span>      <span class="o">+/-</span>                       <span class="n">NaN</span>
 <span class="n">Total</span> <span class="n">Likelihood</span> <span class="n">Evaluations</span><span class="p">:</span>        <span class="mi">17971</span>
 <span class="n">Sampling</span> <span class="n">finished</span><span class="o">.</span> <span class="n">Exiting</span> <span class="n">MultiNest</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Synthesis">
<h2>Synthesis<a class="headerlink" href="#Synthesis" title="Permalink to this headline">¶</a></h2>
<p>In this notebook thus far we have not generated sythetic data. However, we did condition on synthetic data. Below we outline how that data was generated.</p>
<div class="section" id="Background">
<h3>Background<a class="headerlink" href="#Background" title="Permalink to this headline">¶</a></h3>
<p>The background radiation field incident on the model instrument for the purpose of generating synthetic data was a time-invariant powerlaw spectrum, and was transformed into a count-rate in each output channel using the response matrix for synthetic data generation. We would reproduce this background here by writing a custom subclass as follows.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">CustomBackground</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Background</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The background injected to generate synthetic data. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># first the parameters that are fundemental to this class</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Powerlaw spectral index.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;powerlaw_index&#39;</span><span class="p">,</span>
                                <span class="n">strict_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.01</span><span class="p">),</span>
                                <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span>
                                <span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="p">,</span>
                                <span class="n">symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\Gamma$&#39;</span><span class="p">,</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CustomBackground</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energy_edges</span><span class="p">,</span> <span class="n">phases</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate the incident background field. &quot;&quot;&quot;</span>

        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;powerlaw_index&#39;</span><span class="p">]</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">energy_edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phases</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">temp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">energy_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">energy_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phases</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">temp</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_incident_background</span> <span class="o">=</span> <span class="n">temp</span>
</pre></div>
</div>
</div>
<p>Note that the analytic background is integrated over energy intervals, as required by a <code class="docutils literal notranslate"><span class="pre">Signal</span></code> instance, which would then straightforwardly apply the model instrument response to the background.</p>
<p>We can now construct and instantiate a <code class="docutils literal notranslate"><span class="pre">background</span></code> object. The base clase <code class="docutils literal notranslate"><span class="pre">xpsi.Background</span></code> is inherited from the <a class="reference internal" href="parameterSubspace.html#xpsi.ParameterSubspace.ParameterSubspace"><span class="std std-ref">ParameterSubspace</span></a> ABC. We therefore need to specify the number of background parameters, and define the hard bounds on those parameters; in this case we have only a single parameter, the powerlaw index.</p>
<p>We would then instantiate as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">background</span> <span class="o">=</span> <span class="n">CustomBackground</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="c1"># use strict bounds, but do not fix/derive</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;powerlaw_index&#34; with bounds [-3.000e+00, -1.010e+00].
    &gt; Powerlaw spectral index.
</pre></div></div>
</div>
</div>
<div class="section" id="Data-format">
<h3>Data format<a class="headerlink" href="#Data-format" title="Permalink to this headline">¶</a></h3>
<p>We are also in need of a simpler data object.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">SynthesiseData</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Custom data container to enable synthesis. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span> <span class="o">=</span> <span class="n">phases</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The first and last channels must be integers.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The first channel number must be lower than the &#39;</span>
                             <span class="s1">&#39;the last channel number.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Instantiate:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_data</span> <span class="o">=</span> <span class="n">SynthesiseData</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">201</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Setting channels for event data...
Channels set.
</pre></div></div>
</div>
</div>
<div class="section" id="Custom-method">
<h3>Custom method<a class="headerlink" href="#Custom-method" title="Permalink to this headline">¶</a></h3>
<p>We are in need of a <code class="docutils literal notranslate"><span class="pre">synthesise</span></code> method, which in this implementation wraps an extension module. Let’s check what the extension module offers:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">xpsi.tools.synthesise</span> <span class="kn">import</span> <span class="n">synthesise_given_total_count_number</span> <span class="k">as</span> <span class="n">_synthesise</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span>_synthesise<span class="o">?</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">synthesise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">require_source_counts</span><span class="p">,</span>
               <span class="n">require_background_counts</span><span class="p">,</span>
               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;synthetic&#39;</span><span class="p">,</span>
               <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Synthesise data set.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_counts</span><span class="p">,</span> <span class="n">synthetic</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_synthesise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                            <span class="n">require_source_counts</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_shifts</span><span class="p">,</span>
                                            <span class="n">require_background_counts</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_background</span><span class="o">.</span><span class="n">registered_background</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cannot create write directory.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_realisation.dat&#39;</span><span class="p">),</span>
                   <span class="n">synthetic</span><span class="p">,</span>
                   <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="p">,</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_expected_hreadable.dat&#39;</span><span class="p">),</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.8e</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">synthetic</span><span class="p">,</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;_realisation_hreadable.dat&#39;</span><span class="p">),</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fmt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write to file in human readable format. &quot;&quot;&quot;</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">rows</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>

    <span class="n">phases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">phases</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%.6f</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">fmt</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Add unbound methods:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">CustomSignal</span><span class="o">.</span><span class="n">synthesise</span> <span class="o">=</span> <span class="n">synthesise</span>
<span class="n">CustomSignal</span><span class="o">.</span><span class="n">_write</span> <span class="o">=</span> <span class="n">_write</span>
</pre></div>
</div>
</div>
<p>Instantiate, and reconfigure the likelihood object:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">signal</span> <span class="o">=</span> <span class="n">CustomSignal</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">_data</span><span class="p">,</span>
                        <span class="n">instrument</span> <span class="o">=</span> <span class="n">NICER</span><span class="p">,</span>
                        <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span>
                        <span class="n">interstellar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;NICER&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hot</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
    <span class="n">h</span><span class="o">.</span><span class="n">set_phases</span><span class="p">(</span><span class="n">num_leaves</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">likelihood</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Likelihood</span><span class="p">(</span><span class="n">star</span> <span class="o">=</span> <span class="n">star</span><span class="p">,</span> <span class="n">signals</span> <span class="o">=</span> <span class="n">signal</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Warning: No data... can synthesise data but cannot evaluate a likelihood function.
</pre></div></div>
</div>
</div>
<div class="section" id="Synthesise">
<h3>Synthesise<a class="headerlink" href="#Synthesise" title="Permalink to this headline">¶</a></h3>
<p>We proceed to synthesise. First we set an environment variable to seed the random number generator being called:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">env</span> GSL_RNG_SEED=0
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
env: GSL_RNG_SEED=0
</pre></div></div>
</div>
<p>Check write path:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>pwd
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/home/thomas/xpsi/docs/source
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Free parameters
---------------
mass: Gravitational mass [solar masses].
radius: Coordinate equatorial radius [km].
distance: Earth distance [kpc].
cos_inclination: Cosine of Earth inclination to rotation axis.
p__phase_shift: The phase of the hot region, a periodic parameter [cycles].
p__super_colatitude: The colatitude of the centre of the superseding region [radians].
p__super_radius: The angular radius of the (circular) superseding region [radians].
p__super_temperature: log10(superseding region effective temperature [K]).
s__phase_shift: The phase of the hot region, a periodic parameter [cycles].
s__super_colatitude: The colatitude of the centre of the superseding region [radians].
s__super_radius: The angular radius of the (circular) superseding region [radians].
NICER__powerlaw_index: Powerlaw spectral index.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span>
     <span class="mf">12.5</span><span class="p">,</span>
     <span class="mf">0.2</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.25</span><span class="p">),</span>
     <span class="mf">0.0</span><span class="p">,</span>
     <span class="mf">1.0</span><span class="p">,</span>
     <span class="mf">0.075</span><span class="p">,</span>
     <span class="mf">6.2</span><span class="p">,</span>
     <span class="mf">0.025</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span>
     <span class="mf">0.2</span><span class="p">,</span>
     <span class="o">-</span><span class="mf">2.0</span><span class="p">]</span>

<span class="n">NICER_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">require_source_counts</span><span class="o">=</span><span class="mf">2.0e6</span><span class="p">,</span>
                     <span class="n">require_background_counts</span><span class="o">=</span><span class="mf">2.0e6</span><span class="p">,</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;new_synthetic&#39;</span><span class="p">,</span>
                     <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./data&#39;</span><span class="p">)</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">synthesise</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NICER</span><span class="o">=</span><span class="n">NICER_kwargs</span><span class="p">)</span> <span class="c1"># SEED=0</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exposure time: 984282.657643 [s]
Background normalisation: 1.89132777e-05
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/new_synthetic_realisation.dat&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_249_0.png" src="_images/model_construction_249_0.png" />
</div>
</div>
<p>Check we have generated the same count numbers, given the same seed and resolution settings:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">counts</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/new_synthetic_realisation.dat&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True
</pre></div></div>
</div>
<p>The output should be <code class="docutils literal notranslate"><span class="pre">False</span></code> if there is no difference in the expectations of the Poisson-distribution random variables, as was the case for <code class="docutils literal notranslate"><span class="pre">xpsi.__version__</span> <span class="pre">&lt;=</span> <span class="pre">v0.5</span></code>. Now however, because of slight tweaks to the signal integrators, small differences manifest, especially when hot region visibility gets truncated at the stellar limb. The major cause of this difference is because we swap to the Akima Periodic splines phase interpolants from GSL. Previously we invoked the non-periodic Steffen
spline interpolants (the important feature for comparison being that minima and maxima in the interpolant can only occur at spline nodes), also from GSL. The aim in doing this is to increase accuracy near the signal maxima and minima, whilst potentially sacrificing some accuracy when interpolating a curve that is truncated at zero due to a radiating element going out of visibility, or in the context of an extended radiating region, that region going fully out of visibility.</p>
<p>The change in the log-likelihood was small, at the <span class="math notranslate nohighlight">\(\sim5\times10^{-5}\%\)</span> level, but let’s plot the difference between the expectations:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[96]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;../../examples/data/synthetic_expected_hreadable.dat&#39;</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/new_synthetic_expected_hreadable.dat&#39;</span><span class="p">)</span>

<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">xx</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[97]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_255_0.png" src="_images/model_construction_255_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[98]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">xx</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_256_0.png" src="_images/model_construction_256_0.png" />
</div>
</div>
<p>And normalised by the root-variance:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[99]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span><span class="o">-</span><span class="n">xx</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
<span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">_r</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
               <span class="s1">&#39;Standardised residuals&#39;</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
               <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">_r</span><span class="p">)),</span>
               <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">_r</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_258_0.png" src="_images/model_construction_258_0.png" />
</div>
</div>
<p>The difference between realisations is far larger than one count (which is what might be expected in some cases due to discreteness of the Poisson probability mass function) for many intervals, despite the small change in the expectation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[100]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_260_0.png" src="_images/model_construction_260_0.png" />
</div>
</div>
<p>I’m actually unsure why a such small changes in the Poisson-distributed random variable expectations yields such large differences in the random variates for the same GSL RNG seed. For a substantial subset of elements, the random variates <em>are</em> equal, and that is not always where the difference in expectations is zero or relatively small. I consider this an open problem: please get in touch if you happen to read this and you have some insight you can share!</p>
<p>Here is the distribution of standardised variate residuals, for the realisation generated by this notebook, bearing in mind noise and that the Poisson distribution deparature from Gaussianity for lower expectations:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[101]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">variates</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/new_synthetic_realisation.dat&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">variates</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
             <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
             <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
             <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">_x</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="s1">&#39;k-.&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Count number standardised residuals&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_263_0.png" src="_images/model_construction_263_0.png" />
</div>
</div>
<p>And there are no discernable correlations:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[102]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">variates</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
               <span class="s1">&#39;Standardised residuals&#39;</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
               <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">variates</span><span class="p">)),</span>
               <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">variates</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_265_0.png" src="_images/model_construction_265_0.png" />
</div>
</div>
<p>If we switch back to a Steffen phase spline, the issue does not entirely disappear, but the differences are seemingly too small to affect random number generation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[103]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">set_phase_interpolant</span><span class="p">(</span><span class="s1">&#39;Steffen&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">likelihood</span><span class="o">.</span><span class="n">synthesise</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NICER</span><span class="o">=</span><span class="n">NICER_kwargs</span><span class="p">)</span> <span class="c1"># SEED=0</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Exposure time: 984307.670283 [s]
Background normalisation: 1.89127971e-05
</pre></div></div>
</div>
<p>Note the small difference here in exposure time and background normalisation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[105]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/new_synthetic_expected_hreadable.dat&#39;</span><span class="p">)</span>
<span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">zz</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[106]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">zz</span><span class="o">-</span><span class="n">xx</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
<span class="n">plot_one_pulse</span><span class="p">(</span><span class="n">_r</span><span class="p">,</span> <span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
               <span class="s1">&#39;Standardised residuals&#39;</span><span class="p">,</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
               <span class="n">vmin</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">_r</span><span class="p">)),</span>
               <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">_r</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/model_construction_271_0.png" src="_images/model_construction_271_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">counts</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;data/new_synthetic_realisation.dat&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
<span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
False
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Permalink to this headline">¶</a></h2>
<p>In this notebook we constructed a model including a likelihood and prior objects. We also looked at the sampling interface, and concluded by synthesising the pre-prepared data set that was loaded at the beginning of the notebook.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="acknowledgements.html" class="btn btn-neutral float-left" title="Acknowledgements" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="multiple_instruments.html" class="btn btn-neutral float-right" title="Instrument synergy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, 2020, 2021 Thomas E. Riley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>