<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Likelihoods &mdash; xpsi 0.7.10 documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tools" href="tools.html" />
    <link rel="prev" title="Surface radiation field" href="surface_radiation_field.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> xpsi
          </a>
              <div class="version">
                0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_instruments.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field_checking_tools_tutorial.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction_streamlined.html">Modeling (without statistics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_imaging.html">Multiple imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing_tutorial.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_job.html">Example job</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal.html">Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Extension modules</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="extensions_overview.html">Overview of extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field.html">Surface radiation field</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Likelihoods</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extensions">Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing.html">PostProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xpsi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Likelihoods</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/likelihood_implementations.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="likelihoods-1">
<span id="likelihoods"></span><h1>Likelihoods<a class="headerlink" href="#likelihoods-1" title="Permalink to this headline">¶</a></h1>
<span class="target" id="module-xpsi.likelihoods"></span><p>Likelihood function implementations.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Users and developers can implement the final phase of likelihood function
evaluation as an extension module.</p>
<p>These functions must operate on a channel-phase resolved set of signals
(one per hot region). Each component will have an associated phase shift to
account for. An exposure time must be invoked to scale the signal to yield the
expected count numbers.</p>
<p>A phase-resolved signal means that the signal is evaluated at a sequence
of phase points, and thus the signal is to be integrated over a sequence of
phase intervals if the data (event) space in each channel is discrete. If
one desires an unbinned likelihood function, this can be approximated with
a high number of phase bins using existing extensions, or a new extension
module can be straighforwardly developed to loop over events at greater
computational expense.</p>
<p>Lastly, a background model is required. If a physical background model is
condition upon, an extension can operate with the expected background count
(rate or number) signal. In lieu of such a model, one can invoke the default
background marginalisation protocol; channel-by-channel
background count rate variables will be numerically and rapidly marginalised
over. See the discussion in <a class="reference internal" href="applications.html#r19"><span class="std std-ref">Riley et al. 2019 (ApJL, 887, L21)</span></a> and the X-PSI technical notes to evaluate
whether this is appropriate for coupling with a given model for target source
signal.</p>
</div>
<div class="section" id="extensions">
<h2>Extensions<a class="headerlink" href="#extensions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="xpsi.likelihoods.precomputation">
<code class="descclassname">xpsi.likelihoods.</code><code class="descname">precomputation</code><span class="sig-paren">(</span><em>__Pyx_memviewslice data</em><span class="sig-paren">)</span><a class="headerlink" href="#xpsi.likelihoods.precomputation" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute negative of sum of log-factorials of data count numbers.</p>
<p>Use this function to perform precomputation before repeatedly calling
<a class="reference internal" href="#xpsi.likelihoods.eval_marginal_likelihood" title="xpsi.likelihoods.eval_marginal_likelihood"><code class="xref py py-func docutils literal notranslate"><span class="pre">eval_marginal_likelihood()</span></code></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>data</strong> (<em>int</em><em>[</em><em>:</em><em>,</em><em>::1</em><em>]</em>) – Phase-channel resolved count numbers (integers). Phase increases with
column number.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">A 1D <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> information, one element per channel. Each
element is the negative of the sum (over phase intervals) of
log-factorials of data count numbers.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="xpsi.likelihoods.eval_marginal_likelihood">
<code class="descclassname">xpsi.likelihoods.</code><code class="descname">eval_marginal_likelihood</code><span class="sig-paren">(</span><em>double exposure_time</em>, <em>__Pyx_memviewslice phases</em>, <em>__Pyx_memviewslice counts</em>, <em>components</em>, <em>component_phases</em>, <em>phase_shifts</em>, <em>__Pyx_memviewslice neg_sum_ln_data_factorial</em>, <em>__Pyx_memviewslice support</em>, <em>size_t workspace_intervals</em>, <em>double epsabs</em>, <em>double epsrel</em>, <em>double epsilon</em>, <em>double sigmas</em>, <em>double llzero</em>, <em>allow_negative=False</em>, <em>background=None</em><span class="sig-paren">)</span><a class="headerlink" href="#xpsi.likelihoods.eval_marginal_likelihood" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluate the Poisson likelihood.</p>
<p>The count rate is integrated over phase intervals.</p>
<p>A Newton iteration procedure is implemented channel-by-channel to
approximate the conditional-ML background count-rate variable given
a fiducial estimate. Marginalisation over each background variable (in each
channel) is then executed numerically between bounds centred on the ML
background estimate. The bounds are based on a Gaussian expansion of the
conditional likelihood function, and are <code class="xref py py-obj docutils literal notranslate"><span class="pre">sigmas</span></code> standard deviations
above and below the ML estimate. The marginalisation is with respect to a
flat bounded or unbounded prior density function of each background
variable.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>exposure_time</strong> (<em>double</em>) – Exposure time in seconds by which to scale the expected count rate
in each phase interval.</li>
<li><strong>phases</strong> (<em>double</em><em>[</em><em>::1</em><em>]</em>) – A <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of phase interval edges in cycles.</li>
<li><strong>components</strong> (<em>tuple</em>) – Component signals, each a C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of
signal count rates where phase increases with column number.</li>
<li><strong>component_phases</strong> (<em>tuple</em>) – For each component, a C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of phases
in cycles at which the model <code class="xref py py-obj docutils literal notranslate"><span class="pre">signal</span></code> is evaluated on
the interval <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code>.</li>
<li><strong>phase_shifts</strong> (<em>array-like</em>) – Phase shifts in cycles, such as on the interval <code class="docutils literal notranslate"><span class="pre">[-0.5,0.5]</span></code>, for
the component signals.</li>
<li><strong>neg_sum_ln_data_factorial</strong> (<em>double</em><em>[</em><em>::1</em><em>]</em>) – The precomputed output of <a class="reference internal" href="#xpsi.likelihoods.precomputation" title="xpsi.likelihoods.precomputation"><code class="xref py py-func docutils literal notranslate"><span class="pre">precomputation()</span></code></a> given the data count
numbers.</li>
<li><strong>support</strong> (<em>double</em><em>[</em><em>:</em><em>,</em><em>::1</em><em>]</em>) – The prior support of the background <em>count-rate</em> variables. The first
column contains lower-bounds as a function of channel number. Lower-
bounds must be greater than or equal to zero. The second column contains
the upper-bounds as a function of channel number. Upper-bounds for a
proper prior must be greater than zero and greater than the
corresponding lower-bound but finite. If the upper-bound is less than
zero the prior is semi-unbounded and thus improper. Must be a
C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a>.</li>
<li><strong>workspace_intervals</strong> (<em>size_t</em>) – The size of the workspace to allocate for marginalisation via numerical
quadrature using the GSL <code class="docutils literal notranslate"><span class="pre">cquad</span></code> integration routine.</li>
<li><strong>epsabs</strong> (<em>double</em>) – The absolute tolerance for marginalisation via numerical quadrature
using the GSL <code class="docutils literal notranslate"><span class="pre">cquad</span></code> integration routine.</li>
<li><strong>epsrel</strong> (<em>double</em>) – The relative tolerance for marginalisation via numerical quadrature
using the GSL <code class="docutils literal notranslate"><span class="pre">cquad</span></code> integration routine.</li>
<li><strong>epsilon</strong> (<em>double</em>) – The fraction of the standard deviation of the approximating Gaussian
function to tolerate when a new step of the quadratic maximisation
scheme is proposed. This fraction should be some adequately small
number. The standard deviation is recalculated with each iteration
as the position (in each background variable) evolves.</li>
<li><strong>sigmas</strong> (<em>double</em>) – The number of approximating Gaussian standard deviations to expand
the integration domain about the point estimated to maximise the
conditional likelihood function in each channel. This number should
probably be at least five but no more than ten.</li>
<li><strong>llzero</strong> (<em>double</em>) – The log-likelihood that a MultiNest process treats as zero and thus
ignores points with smaller log-likelihood. This number will be <em>very</em>
negative. This is useful because if the likelihood is predicted, in
advance of full executation of this function, to be incredibly small,
computation can be avoided, returning a number slightly above this
zero-threshold.</li>
<li><strong>allow_negative</strong> (<em>obj</em>) – A boolean or an array of booleans, one per component, declaring whether
to allow negative phase interpolant integrals. If the interpolant is
not a Steffen spline, then the interpolant of a non-negative function
can be negative due to oscillations. For the default Akima Periodic
spline from GSL, such oscillations should manifest as small relative
to those present in cubic splines, for instance, because it is
designed to handle a rapidly changing second-order derivative.</li>
<li><strong>background</strong> (<em>obj</em>) – If not <code class="docutils literal notranslate"><span class="pre">None</span></code>, then a C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of
background count rates where phase interval increases with column
number. Useful for phase-dependent backgrounds, or a phase-independent
background if the channel-by-channel background variable prior support
is restricted.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">A tuple <code class="docutils literal notranslate"><span class="pre">(double,</span> <span class="pre">2D</span> <span class="pre">ndarray,</span> <span class="pre">1D</span> <span class="pre">ndarray)</span></code>. The first element is
the logarithm of the marginal likelihood. The second element is the
expected count numbers in joint phase-channel intervals from the star
(the target source). The last element is the vector of background
count numbers that are estimated to maximise the conditional
likelihood function, one per channel.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="xpsi.likelihoods.poisson_likelihood_given_background">
<code class="descclassname">xpsi.likelihoods.</code><code class="descname">poisson_likelihood_given_background</code><span class="sig-paren">(</span><em>double exposure_time</em>, <em>__Pyx_memviewslice phases</em>, <em>__Pyx_memviewslice counts</em>, <em>components</em>, <em>component_phases</em>, <em>phase_shifts</em>, <em>__Pyx_memviewslice background</em>, <em>allow_negative=False</em><span class="sig-paren">)</span><a class="headerlink" href="#xpsi.likelihoods.poisson_likelihood_given_background" title="Permalink to this definition">¶</a></dt>
<dd><p>Evaluate the Poisson likelihood.</p>
<p>The count rate is integrated over phase intervals.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>exposure_time</strong> (<em>double</em>) – Exposure time in seconds by which to scale the expected count rate
in each phase interval.</li>
<li><strong>phases</strong> (<em>double</em><em>[</em><em>::1</em><em>]</em>) – A <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of phase interval edges in cycles.</li>
<li><strong>components</strong> (<em>tuple</em>) – Component signals, each a C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of
signal count rates where phase increases with column number.</li>
<li><strong>component_phases</strong> (<em>tuple</em>) – For each component, a C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of phases
in cycles at which the model <code class="xref py py-obj docutils literal notranslate"><span class="pre">signal</span></code> is evaluated on
the interval <code class="docutils literal notranslate"><span class="pre">[0,1]</span></code>.</li>
<li><strong>phase_shifts</strong> (<em>array-like</em>) – Phase shifts in cycles, such as on the interval <code class="docutils literal notranslate"><span class="pre">[-0.5,0.5]</span></code>, for
the component signals.</li>
<li><strong>background</strong> (<em>double</em><em>[</em><em>:</em><em>,</em><em>::1</em><em>]</em>) – A C-contiguous <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.22)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> of background expected
<em>counts</em>, whose shape matches the number of channels in each element
of <code class="xref py py-obj docutils literal notranslate"><span class="pre">components</span></code> and the number of phase intervals constructed
from <code class="xref py py-obj docutils literal notranslate"><span class="pre">phases</span></code>.</li>
<li><strong>allow_negative</strong> (<em>obj</em>) – A boolean or an array of booleans, one per component, declaring whether
to allow negative phase interpolant integrals. If the interpolant is
not a Steffen spline, then the interpolant of a non-negative function
can be negative due to oscillations. For the default Akima Periodic
spline from GSL, such oscillations should manifest as small relative
to those present in cubic splines, for instance, because it is
designed to handle a rapidly changing second-order derivative.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">A tuple <code class="docutils literal notranslate"><span class="pre">(double,</span> <span class="pre">2D</span> <span class="pre">ndarray)</span></code>. The first element is
the logarithm of the marginal likelihood. The second element is the
expected count numbers in joint phase-channel intervals from the star
(the target source).</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<p>The following is an example of a custom extension module to evaluate a
simple likelihood function based on Poisson sampling distribution of count
data.</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c">#cython: cdivision=True</span>
<span class="c">#cython: boundscheck=False</span>
<span class="c">#cython: nonecheck=False</span>
<span class="c">#cython: wraparound=False</span>
<span class="c">#cython: embedsignature=True</span>

<span class="k">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="nb">pow</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">floor</span>
<span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span>

<span class="k">from</span> <span class="nn">GSL</span> <span class="k">cimport</span> <span class="p">(</span><span class="n">gsl_interp</span><span class="p">,</span>
                   <span class="n">gsl_interp_alloc</span><span class="p">,</span>
                   <span class="n">gsl_interp_init</span><span class="p">,</span>
                   <span class="n">gsl_interp_free</span><span class="p">,</span>
                   <span class="n">gsl_interp_eval</span><span class="p">,</span>
                   <span class="n">gsl_interp_eval_integ</span><span class="p">,</span>
                   <span class="n">gsl_interp_steffen</span><span class="p">,</span>
                   <span class="n">gsl_interp_accel</span><span class="p">,</span>
                   <span class="n">gsl_interp_accel_alloc</span><span class="p">,</span>
                   <span class="n">gsl_interp_accel_free</span><span class="p">,</span>
                   <span class="n">gsl_interp_accel_reset</span><span class="p">)</span>

<span class="k">ctypedef</span> <span class="n">gsl_interp_accel</span> <span class="n">accel</span>

<span class="k">def</span> <span class="nf">poisson_likelihood_given_background</span><span class="p">(</span><span class="n">double</span> <span class="n">exposure_time</span><span class="p">,</span>
                                        <span class="n">double</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">phases</span><span class="p">,</span>
                                        <span class="n">double</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">counts</span><span class="p">,</span>
                                        <span class="n">components</span><span class="p">,</span>
                                        <span class="n">component_phases</span><span class="p">,</span>
                                        <span class="n">phase_shifts</span><span class="p">,</span>
                                        <span class="n">double</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">background</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Evaluate the Poisson likelihood.</span>

<span class="sd">    The count rate is integrated over phase intervals.</span>

<span class="sd">    :param double exposure_time:</span>
<span class="sd">        Exposure time in seconds by which to scale the expected count rate</span>
<span class="sd">        in each phase interval.</span>

<span class="sd">    :param phases:</span>
<span class="sd">        A C-contiguous :class:`numpy.ndarray` of phase interval edges in cycles.</span>

<span class="sd">    :param tuple components:</span>
<span class="sd">        Component signals, each a C-contiguous :class:`numpy.ndarray` of</span>
<span class="sd">        signal count rates where phase increases with column number.</span>

<span class="sd">    :param tuple component_phases:</span>
<span class="sd">        For each component, a C-contiguous :class:`numpy.ndarray` of phases</span>
<span class="sd">        in cycles at which the model :obj:`signal` is evaluated on</span>
<span class="sd">        the interval ``[0,1]``.</span>

<span class="sd">    :param array-like phase_shifts:</span>
<span class="sd">        Phase shifts in cycles, such as on the interval ``[-0.5,0.5]``, for</span>
<span class="sd">        the component signals.</span>

<span class="sd">    :param background:</span>
<span class="sd">        A C-contiguous :class:`numpy.ndarray` of background expected</span>
<span class="sd">        *counts*, whose shape matches the number of channels in each element</span>
<span class="sd">        of :obj:`components` and the number of phase intervals constructed</span>
<span class="sd">        from :obj:`phases`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">cdef</span><span class="p">:</span>
        <span class="n">size_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">num_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
        <span class="n">double</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>

        <span class="n">double</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">STAR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">components</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">phases</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">-</span><span class="mf">1</span><span class="p">),</span>
                                       <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

    <span class="k">cdef</span> <span class="kt">double</span> *<span class="nf">phases_ptr</span> <span class="o">=</span> <span class="bp">NULL</span>
    <span class="k">cdef</span> <span class="kt">double</span> *<span class="nf">signal_ptr</span> <span class="o">=</span> <span class="bp">NULL</span>

    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">signal</span>
    <span class="k">cdef</span> <span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">signal_phase_set</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">phase_shift</span>

    <span class="k">cdef</span> <span class="kt">gsl_interp</span> **<span class="nf">interp</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">gsl_interp</span><span class="o">**&gt;</span> <span class="n">malloc</span><span class="p">(</span><span class="n">num_components</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">gsl_interp</span><span class="o">*</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">accel</span> **<span class="nf">acc</span> <span class="o">=</span>  <span class="o">&lt;</span><span class="n">accel</span><span class="o">**&gt;</span> <span class="n">malloc</span><span class="p">(</span><span class="n">num_components</span> <span class="o">*</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">accel</span><span class="o">*</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_components</span><span class="p">):</span>
        <span class="n">signal_phase_set</span> <span class="o">=</span> <span class="n">component_phases</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">interp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsl_interp_alloc</span><span class="p">(</span><span class="n">gsl_interp_steffen</span><span class="p">,</span> <span class="n">signal_phase_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="n">acc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">()</span>
        <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

    <span class="k">cdef</span> <span class="kt">gsl_interp</span> *<span class="nf">inter_ptr</span> <span class="o">=</span> <span class="bp">NULL</span>
    <span class="k">cdef</span> <span class="kt">accel</span> *<span class="nf">acc_ptr</span> <span class="o">=</span> <span class="bp">NULL</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">STAR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_components</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">signal_phase_set</span> <span class="o">=</span> <span class="n">component_phases</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">phase_shift</span> <span class="o">=</span> <span class="n">phase_shifts</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

            <span class="n">interp_ptr</span> <span class="o">=</span> <span class="n">interp</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">acc_ptr</span> <span class="o">=</span> <span class="n">acc</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">phases_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">signal_phase_set</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
            <span class="n">signal_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mf">0</span><span class="p">])</span>

            <span class="n">gsl_interp_init</span><span class="p">(</span><span class="n">interp_ptr</span><span class="p">,</span> <span class="n">phases_ptr</span><span class="p">,</span> <span class="n">signal_ptr</span><span class="p">,</span>
                            <span class="n">signal_phase_set</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phases</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">phase_shift</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">phases</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mf">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">phase_shift</span>

                <span class="n">a</span> <span class="o">-=</span> <span class="n">floor</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">-=</span> <span class="n">floor</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">STAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gsl_interp_eval_integ</span><span class="p">(</span><span class="n">interp_ptr</span><span class="p">,</span>
                                                       <span class="n">phases_ptr</span><span class="p">,</span>
                                                       <span class="n">signal_ptr</span><span class="p">,</span>
                                                       <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                                                       <span class="n">acc_ptr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">STAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gsl_interp_eval_integ</span><span class="p">(</span><span class="n">interp_ptr</span><span class="p">,</span>
                                                       <span class="n">phases_ptr</span><span class="p">,</span>
                                                       <span class="n">signal_ptr</span><span class="p">,</span>
                                                       <span class="n">a</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span>
                                                       <span class="n">acc_ptr</span><span class="p">)</span>

                    <span class="n">STAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gsl_interp_eval_integ</span><span class="p">(</span><span class="n">interp_ptr</span><span class="p">,</span>
                                                       <span class="n">phases_ptr</span><span class="p">,</span>
                                                       <span class="n">signal_ptr</span><span class="p">,</span>
                                                       <span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                                                       <span class="n">acc_ptr</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_components</span><span class="p">):</span>
        <span class="n">gsl_interp_accel_free</span><span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
        <span class="n">gsl_interp_free</span><span class="p">(</span><span class="n">interp</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

    <span class="n">free</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
    <span class="n">free</span><span class="p">(</span><span class="n">interp</span><span class="p">)</span>

    <span class="k">cdef</span><span class="p">:</span>
        <span class="n">double</span> <span class="n">LOGLIKE</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">EXPEC</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">double</span> <span class="n">n</span> <span class="o">=</span> <span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;(</span><span class="n">phases</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">STAR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">STAR</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]):</span>
            <span class="n">EXPEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">STAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">background</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">exposure_time</span>
            <span class="n">LOGLIKE</span> <span class="o">-=</span> <span class="n">EXPEC</span>
            <span class="n">LOGLIKE</span> <span class="o">+=</span> <span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">EXPEC</span><span class="p">)</span>

            <span class="n">STAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">background</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">n</span>
            <span class="n">STAR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">exposure_time</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">LOGLIKE</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">STAR</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="surface_radiation_field.html" class="btn btn-neutral float-left" title="Surface radiation field" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools.html" class="btn btn-neutral float-right" title="Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, 2020, 2021 Thomas E. Riley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>