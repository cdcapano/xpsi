<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SURFsara systems &mdash; xpsi 0.7.10 documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Code of Conduct" href="code_of_conduct.html" />
    <link rel="prev" title="Applications" href="applications.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> xpsi
          </a>
              <div class="version">
                0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">SURFsara systems</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cartesius">Cartesius</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables">Environment variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#batch-usage">Batch usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#lisa">Lisa</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_instruments.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field_checking_tools_tutorial.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction_streamlined.html">Modeling (without statistics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_imaging.html">Multiple imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing_tutorial.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_job.html">Example job</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal.html">Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Extension modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="extensions_overview.html">Overview of extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field.html">Surface radiation field</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood_implementations.html">Likelihoods</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing.html">PostProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xpsi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>SURFsara systems</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/SURFsara_systems.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="surfsara-systems">
<span id="surfsystems"></span><h1>SURFsara systems<a class="headerlink" href="#surfsara-systems" title="Permalink to this headline">Â¶</a></h1>
<p>The information provided below is intended for users who intend to work on the
SURFsara systems Cartesius and/or Lisa. These specific systems are typically
used by members of the Anton Pannekoek Institute for Astronomy, where X-PSI
was first developed. However, this information may also be translated to
other systems by users looking for guidance.</p>
<p>The X-PSI project is yet to develop a catalogue of tips/guidelines/instructions
for different types of systems or specific systems. Such information should be
gained to some degree as the package is applied by users.</p>
<div class="section" id="cartesius">
<h2>Cartesius<a class="headerlink" href="#cartesius" title="Permalink to this headline">Â¶</a></h2>
<p><a class="reference external" href="https://userinfo.surfsara.nl/systems/cartesius">Cartesius</a> is the Dutch National
Supercomputer.</p>
<div class="section" id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">Â¶</a></h3>
<p>All of the following must be performed on a login node, in your <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> file
system.</p>
<p>Start by cleaning your home file system of existing versions of dependencies
and move anything else to some archive in <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>. Clean <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> and
<code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> of anything related to this software. Clean <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> and
<code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> of environment variables such as: <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code>,
<code class="docutils literal notranslate"><span class="pre">LD_PRELOAD</span></code>, <code class="docutils literal notranslate"><span class="pre">RUN_PATH</span></code>, <code class="docutils literal notranslate"><span class="pre">PATH</span></code>, and <code class="docutils literal notranslate"><span class="pre">PYTHONPATH</span></code>. Then logout and
log back in order to get a clean environment.</p>
<p>Modify clean environment with Intel toolchain information:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load intel/2017b
</pre></div>
</div>
<p>Load the module environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load pre2019
</pre></div>
</div>
<p>Point to Intel compilers:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">FC</span><span class="o">=</span>ifort
<span class="nb">export</span> <span class="nv">CC</span><span class="o">=</span>icc
<span class="nb">export</span> <span class="nv">CXX</span><span class="o">=</span>icpc
</pre></div>
</div>
<p>When compiling, use the <code class="docutils literal notranslate"><span class="pre">-ax</span></code> flag to select instruction sets that target
Intel Broadwell/Haswell processors on batch nodes via auto-dispatch.
The <code class="docutils literal notranslate"><span class="pre">-x</span></code> instruction set is for sneaky testing purposes on the login node.
Below we write these flags arguments explicitly where required.</p>
<p>The default <code class="docutils literal notranslate"><span class="pre">cmake</span></code> module should be sufficient:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load cmake
</pre></div>
</div>
<p>Prepare Python environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load python/2.7.9
</pre></div>
</div>
<p>We will now install the various python packages we require. We use the module
<code class="docutils literal notranslate"><span class="pre">/sara/sw/python-2.7.9/</span></code> and its <code class="docutils literal notranslate"><span class="pre">pip</span></code> package manager to install packages
locally in <code class="docutils literal notranslate"><span class="pre">$HOME/.local/lib/python2.7/site-packages/</span></code> if they are not
installed globally or are outdated.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install --user <span class="nv">Cython</span><span class="o">==</span><span class="m">0</span>.27.3
pip install --user wrap
pip install --user tools
</pre></div>
</div>
<p>We set the library and python paths:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:<span class="nv">$HOME</span>/multinest/MultiNest_v3.12_CMake/multinest/lib/
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local/lib/python2.7/site-packages/:<span class="nv">$PYTHONPATH</span>
</pre></div>
</div>
<p>To prepare MPI from <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://bitbucket.org/mpi4py/mpi4py/downloads/mpi4py-3.0.0.tar.gz
tar -xvf mpi4py-3.0.0.tar.gz
<span class="nb">cd</span> mpi4py-3.0.0
python setup.py install --user
</pre></div>
</div>
<p>To test on the login node:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiexec -n <span class="m">8</span> python demo/helloworld.py
</pre></div>
</div>
<p>Do you see ranks 0 through 7 reporting for duty?</p>
<p>To prepare <a class="reference external" href="https://github.com/farhanferoz/MultiNest">MultiNest</a> from
<code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/farhanferoz/MultiNest.git ~/multinest
<span class="nb">cd</span> ~/multinest/MultiNest_v3.11_CMake/multinest
mkdir build
<span class="nb">cd</span> build
cmake -DCMAKE_<span class="o">{</span>C,CXX<span class="o">}</span><span class="nv">_FLAGS</span><span class="o">=</span><span class="s2">&quot;-O3 -xAVX -axCORE-AVX2 -funroll-loops&quot;</span> -DCMAKE_Fortran_FLAGS<span class="o">=</span><span class="s2">&quot;-O3 -xAVX -axCORE-AVX2 -funroll-loops&quot;</span> ..
make
ls ../lib/
</pre></div>
</div>
<p>Use the last command to check for the presence of shared objects.</p>
<p>Now you need the Python interface to MultiNest, starting from <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/JohannesBuchner/PyMultiNest.git pymultinest
<span class="nb">cd</span> pymultinest
python setup.py install --user
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We assumed above that nested sampling with <a class="reference external" href="https://github.com/farhanferoz/MultiNest">MultiNest</a> is desired. If
ensemble-MCMC with <code class="docutils literal notranslate"><span class="pre">emcee</span></code> is desired, you need to install the Python
packages <code class="docutils literal notranslate"><span class="pre">emcee</span></code> and <code class="docutils literal notranslate"><span class="pre">schwimmbad</span></code>. We assume the user can infer how to
do this using the information above and on the <a class="reference internal" href="install.html#install"><span class="std std-ref">Installation</span></a> page.</p>
</div>
<p>To build and install <a class="reference external" href="https://www.gnu.org/software/gsl/">GSL</a> from <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget -v http://mirror.koddos.net/gnu/gsl/http://mirror.koddos.net/gnu/gsl/gsl-latest.tar.gz
tar -xvf gsl-latest.tar.gz
mkdir gsl-latest/build
<span class="nb">cd</span> gsl-latest/build
./configure <span class="nv">FC</span><span class="o">=</span>ifort <span class="nv">CC</span><span class="o">=</span>icc <span class="nv">CFLAGS</span><span class="o">=</span><span class="s1">&#39;-O3 -xAVX -axCORE-AVX2 -mieee-fp -funroll-loops&#39;</span> --prefix<span class="o">=</span><span class="nv">$HOME</span>/gsl
make
</pre></div>
</div>
<p>Optionally <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check</span></code> can be executed next, but should fail on linear
algebra (linalg) checks because precision checks designed for GNU compiler
collection, not Intel. Now:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make install
</pre></div>
</div>
<p>You can check the prefix (which should be <code class="docutils literal notranslate"><span class="pre">$HOME/gsl</span></code>) and version of GSL
on your path:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gsl-config --version
gsl-config --prefix
</pre></div>
</div>
<p>Note that if you need to restart installation for some reason, first execute:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make clean<span class="p">;</span> make distclean
</pre></div>
</div>
<p>To prepare X-PSI from <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/xpsi-group/xpsi.git
<span class="nb">cd</span> xpsi
<span class="nv">LDSHARED</span><span class="o">=</span><span class="s2">&quot;icc -shared&quot;</span> <span class="nv">CC</span><span class="o">=</span>icc python setup.py install --user
</pre></div>
</div>
<p>This ensures that both the compiler and linker are Intel, otherwise gcc linker
would be invoked. Provided the GSL <code class="docutils literal notranslate"><span class="pre">&lt;prefix&gt;/bin</span></code> is in your <code class="docutils literal notranslate"><span class="pre">PATH</span></code>
environment variable, the X-PSI <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script will automatically use the
<code class="docutils literal notranslate"><span class="pre">gsl-config</span></code> executable to link the shared libraries and give the required
cflags for compilation of the X-PSI extensions. Because the library location
will not change for runtime, we state the runtime linking instructions at
compilation in the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> script.</p>
<p>If you ever need to reinstall, first clean to recompile C files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm -r build dist *egg* xpsi/*/*.c
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We will not use the <a class="reference internal" href="postprocessing.html#module-xpsi.PostProcessing" title="xpsi.PostProcessing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">PostProcessing</span></code></a> module, but instead
<code class="docutils literal notranslate"><span class="pre">scp</span></code> output files to a local system to perform plotting.
This circumvents any potential backend problems and permits straightforward
use of IPython for interactive plotting. See also the <a class="reference internal" href="install.html#install"><span class="std std-ref">Installation</span></a> page.</p>
</div>
</div>
<div class="section" id="environment-variables">
<h3>Environment variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">Â¶</a></h3>
<p>The following environment variables need to be exported in your job script
script so that all relevant libraries can be located at <em>runtime</em> by the
dynamic loader (ensure that the environment variables are only extended, and
not overwritten because module loading modifies these variables).</p>
<p>Set runtime linking path for MultiNest:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:<span class="nv">$HOME</span>/multinest/Multinest_v3.11_CMake/multinest/lib
</pre></div>
</div>
<p>We want to ensure that your locally installed Python packages take
precedence over globally installed packages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local.lib/python2.7/site-packages/:<span class="nv">$PYTHONPATH</span>
</pre></div>
</div>
<p>If you are to perform small tests on login nodes in your login shell, these
environment variables need to be exported in your <code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> script, or
in your <code class="docutils literal notranslate"><span class="pre">.bash.rc</span></code> script which can be sourced by your <code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code>
script (the default default behaviour).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">/sara/sw/python-2.7.9/</span></code> Python distribution does not
seem to have <a class="reference external" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="(in NumPy v1.22)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy</span></code></a> linked against the Intel MKL library. Instead it
uses the open-source, multithreaded OpenBLAS library which still offers an
optimised interface to BLAS and LAPACK. However for our purposes on distributed
memory architectures, we  wish to export the following environment variables
in our batch job script if we do not want multithreaded libraries to spawn
worker (OpenMP or POSIX) threads:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">GOTO_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>If we instruct our likelihood evaluation object to OpenMP multithread, local
multithreading regions are used which do not take instructions from the
<code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> environment variable, so we can invariantly <code class="docutils literal notranslate"><span class="pre">export</span></code> it as
above.
However, the <code class="docutils literal notranslate"><span class="pre">MKL_NUM_THREADS</span></code> environment variable should either not be
exported (in which case the <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> variable is used), or increased
so that <a class="reference external" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="(in NumPy v1.22)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy</span></code></a> can multithread outside of the local multithreading
regions in the X-PSI extension modules.</p>
<p>Note that OpenBLAS may not be compiled against the OpenMP library but instead
use Pthreads. If <a class="reference external" href="https://numpy.org/doc/stable/reference/index.html#module-numpy" title="(in NumPy v1.22)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">numpy</span></code></a> <em>is</em> linked against MKL, we have covered all
possibilities because MKL whilst uses OpenMP threading but the
<code class="docutils literal notranslate"><span class="pre">MKL_NUM_THREADS</span></code> environment variable takes precedence if set and thus we
ensure it is set to one.</p>
<p>The GSL library we installed (see above) is not a parallel library itself,
and actually supplies a low-level layer of its own as a CBLAS implementation.
This may be replaced with an optimised implementation, in which case the
question of nested multithreading arises. The OpenBLAS and MKL implementations
can detect whether library calls are made within OpenMP-parallel regions of
the X-PSI source code provided the same threading library is used: e.g.,
OpenBLAS compiled with <code class="docutils literal notranslate"><span class="pre">USE_OPENMP=1</span></code>, or X-PSI compiled with an Intel
compiler and linked against MKL.</p>
</div>
<div class="section" id="batch-usage">
<h3>Batch usage<a class="headerlink" href="#batch-usage" title="Permalink to this headline">Â¶</a></h3>
<p>For an example job script, refer to <a class="reference internal" href="example_script.html#example-script"><span class="std std-ref">Example script and modules</span></a>.</p>
</div>
</div>
<div class="section" id="lisa">
<h2>Lisa<a class="headerlink" href="#lisa" title="Permalink to this headline">Â¶</a></h2>
<p>The following are the instructions for the
<a class="reference external" href="https://userinfo.surfsara.nl/systems/lisa">Lisa</a> Cluster, that mostly correspond to those
of Cartesius instructions given above but with few exceptions.</p>
<p>After cleaning your home file system of existing versions of dependencies (as explained for Cartesius), we need to make the environment with Intel toolchain information:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load <span class="m">2019</span>
module load intel/2019b
</pre></div>
</div>
<p>The default <code class="docutils literal notranslate"><span class="pre">cmake</span></code> module can be obtained from:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load Cmake
</pre></div>
</div>
<p>To prepare the correct Python environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load Python/2.7.15-intel-2019b
</pre></div>
</div>
<p>Next, we need to use <code class="docutils literal notranslate"><span class="pre">pip</span></code> to install packages
locally in <code class="docutils literal notranslate"><span class="pre">$HOME/.local/lib/python2.7/site-packages/</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install --user <span class="nv">Cython</span><span class="o">==</span><span class="m">0</span>.28<span class="p">;</span> pip install --user wrapt
</pre></div>
</div>
<p>To prepare MPI and MultiNest from <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://bitbucket.org/mpi4py/mpi4py/downloads/mpi4py-3.0.0.tar.gz
tar -xvf mpi4py-3.0.0.tar.gz
<span class="nb">cd</span> mpi4py-3.0.0
python setup.py install --user
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/farhanferoz/MultiNest.git ~/multinest
<span class="nb">cd</span> ~/multinest/MultiNest_v3.12_CMake/multinest
mkdir build
<span class="nb">cd</span> build
cmake -DCMAKE_<span class="o">{</span>C,CXX<span class="o">}</span><span class="nv">_FLAGS</span><span class="o">=</span><span class="s2">&quot;-O3 -xAVX -axCORE-AVX2 -funroll-loops&quot;</span> -DCMAKE_Fortran_FLAGS<span class="o">=</span><span class="s2">&quot;-O3 -xAVX -axCORE-AVX2 -funroll-loops&quot;</span> ..
make
</pre></div>
</div>
<p>In case of having problems, the <code class="docutils literal notranslate"><span class="pre">-xAVX</span></code> and <code class="docutils literal notranslate"><span class="pre">-axCORE-AVX2</span></code> compiler flags can be omitted.</p>
<p>Finally, we need the Python interface to MultiNest, GSL, and X-PSI, all starting from <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cd<span class="p">;</span> git clone https://github.com/JohannesBuchner/PyMultiNest.git pymultinest
<span class="nb">cd</span> pymultinest
python setup.py install --user
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cd<span class="p">;</span> wget -v http://mirror.koddos.net/gnu/gsl/http://mirror.koddos.net/gnu/gsl/gsl-latest.tar.gz
tar -xvf gsl-latest.tar.gz
<span class="nb">cd</span> gsl-2.6
mkdir build<span class="p">;</span> <span class="nb">cd</span> build
../configure <span class="nv">CC</span><span class="o">=</span>icc <span class="nv">CFLAGS</span><span class="o">=</span><span class="s1">&#39;-O3 -xAVX -axCORE-AVX2 -mieee-fp -funroll-loops&#39;</span> --prefix<span class="o">=</span><span class="nv">$HOME</span>/gsl
make
make install
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/gsl/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cd<span class="p">;</span> git clone https://github.com/xpsi-group/xpsi.git
<span class="nb">cd</span> xpsi
<span class="nv">LDSHARED</span><span class="o">=</span><span class="s2">&quot;icc -shared&quot;</span> <span class="nv">CC</span><span class="o">=</span>icc python setup.py install --user
</pre></div>
</div>
<p>The success of different installation steps can be checked as described in the Cartesius instructions, as well as the instructions for possible re-installations.</p>
<p>The structure of the Lisa filesystem for batch jobs is different to Cartesius. Here is given an example job:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#SBATCH -N 4</span>
<span class="c1">#SBATCH --tasks-per-node=8</span>
<span class="c1">#SBATCH -t 3-00:00:00</span>
<span class="c1">#SBATCH -p normal</span>
<span class="c1">#SBATCH --job-name=run1</span>

<span class="nb">echo</span> start of job in directory <span class="nv">$SLURM_SUBMIT_DIR</span>
<span class="nb">echo</span> number of nodes is <span class="nv">$SLURM_JOB_NUM_NODES</span>
<span class="nb">echo</span> the allocated nodes are:
<span class="nb">echo</span> <span class="nv">$SLURM_JOB_NODELIST</span>

module load <span class="m">2019</span>
module load intel/2019b
module load Python/2.7.15-intel-2019b

cp -r <span class="nv">$HOME</span>/NICER_analyses/J0030_ST_PST <span class="nv">$TMPDIR</span>

<span class="nb">cd</span> <span class="nv">$TMPDIR</span>/J0030_ST_PST

<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local/lib/python2.7/site-packages/:<span class="nv">$PYTHONPATH</span>

<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">GOTO_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$HOME</span>/multinest/MultiNest_v3.12_CMake/multinest/lib/:<span class="nv">$LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/gsl/bin:<span class="nv">$PATH</span>

srun python main_run1.py &gt; out_run1 <span class="m">2</span>&gt; err_run1

cp run1* out_run1 err_run1 <span class="nv">$HOME</span>/NICER_analyses/J0030_ST_PST/.
<span class="c1">#end of job file</span>
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Things here.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="applications.html" class="btn btn-neutral float-left" title="Applications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="code_of_conduct.html" class="btn btn-neutral float-right" title="Code of Conduct" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, 2020, 2021 Thomas E. Riley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>