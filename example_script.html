<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example script and modules &mdash; xpsi 0.7.10 documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example job" href="example_job.html" />
    <link rel="prev" title="Post-processing" href="postprocessing_tutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> xpsi
          </a>
              <div class="version">
                0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_instruments.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field_checking_tools_tutorial.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction_streamlined.html">Modeling (without statistics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_imaging.html">Multiple imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing_tutorial.html">Post-processing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example script and modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#main">Main</a></li>
<li class="toctree-l2"><a class="reference internal" href="#photosphere">Photosphere</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instrument">Instrument</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interstellar">Interstellar</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signal">Signal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prior">Prior</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example_job.html">Example job</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal.html">Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Extension modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="extensions_overview.html">Overview of extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field.html">Surface radiation field</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood_implementations.html">Likelihoods</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing.html">PostProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xpsi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Example script and modules</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/example_script.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="example-script-and-modules">
<span id="example-script"></span><h1>Example script and modules<a class="headerlink" href="#example-script-and-modules" title="Permalink to this headline">Â¶</a></h1>
<p>The following model script is an example from <a class="reference internal" href="applications.html#r19"><span class="std std-ref">Riley et al. 2019 (ApJL, 887, L21)</span></a>. One would run the
program from the command line on a desktop via:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiexec -n <span class="m">4</span> python <span class="o">[</span>-m mpi4py<span class="o">]</span> main.py
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">main.py</span></code> is of course the script name, and where for a machine with
four physical cores, we spawn as many MPI processes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure to set OpenMP environment variables appropriately
(see, e.g., <a class="reference internal" href="SURFsara_systems.html#surfsystems"><span class="std std-ref">SURFsara systems</span></a>) to avoid hybrid parallelisation by
libraries linked to NumPy and GSL, for instance.</p>
</div>
<p>The optional <code class="docutils literal notranslate"><span class="pre">-m</span></code> argument is to run the module <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/mpi4py.html#module-mpi4py" title="(in MPI for Python v3.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mpi4py</span></code></a> as main, which
enables elegant termination of all MPI processes if one process encounters
an unhandled exception, for instance; without out this flag, MPI processes
may hang if an unhandled exception is raised in a subset of processes. An
example of this is an exception thrown from a <a class="reference internal" href="prior.html#xpsi.Prior.Prior" title="xpsi.Prior.Prior"><code class="xref py py-class docutils literal notranslate"><span class="pre">Prior</span></code></a> subclass during
set-up for sampling: only the root (rank zero) process encounters the
exception, whilst all other wait for it and will hang indefinitely. If one
is not monitoring the output during the start of the program to check that
sensible things are happening, this can be missed, which is especially
problematic on a HPC system on which one is budgeted time and thus there is a
serious risk of resource wastage from the perspective of all users of the
system.</p>
<p>The script below is an example like that found on the <cite>Modeling</cite>
page, but without being interleaved with verbose explanations. The model
implemented here is more involved than shown on the <cite>Modeling</cite>
page, and than those defined for the example parameter
estimation problems that can be found in the <code class="docutils literal notranslate"><span class="pre">xpsi/examples</span></code> directory of
the repository.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The script and modules below are being updated to use
the current API (<code class="docutils literal notranslate"><span class="pre">v0.5.0</span></code>).</p>
</div>
<div class="section" id="main">
<h2>Main<a class="headerlink" href="#main" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; main.py &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">xpsi</span>

<span class="kn">from</span> <span class="nn">xpsi.global_imports</span> <span class="kn">import</span> <span class="n">gravradius</span>

<span class="kn">from</span> <span class="nn">CustomInstrument</span> <span class="kn">import</span> <span class="n">CustomInstrument</span>
<span class="kn">from</span> <span class="nn">CustomInterstellar</span> <span class="kn">import</span> <span class="n">CustomInterstellar</span>
<span class="kn">from</span> <span class="nn">CustomSignal</span> <span class="kn">import</span> <span class="n">CustomSignal</span>
<span class="kn">from</span> <span class="nn">CustomPrior</span> <span class="kn">import</span> <span class="n">CustomPrior</span>
<span class="kn">from</span> <span class="nn">CustomPhotosphere</span> <span class="kn">import</span> <span class="n">CustomPhotosphere</span>

<span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/NICER_J0030_PaulRay_fixed_evt_25to299__preprocessed.txt&#39;</span>
<span class="n">obs_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">counts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">),</span>
                    <span class="n">channels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
                    <span class="n">phases</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span>
                    <span class="n">first</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="mi">274</span><span class="p">,</span>
                    <span class="n">exposure_time</span><span class="o">=</span><span class="mf">1936864.0</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span><span class="o">**</span><span class="n">obs_settings</span><span class="p">)</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">),</span>
              <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span>
              <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.5</span><span class="p">))</span>

<span class="n">NICER</span> <span class="o">=</span> <span class="n">CustomInstrument</span><span class="o">.</span><span class="n">from_SWG</span><span class="p">(</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">,</span>
                                  <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span>
                                  <span class="n">ARF</span> <span class="o">=</span> <span class="s1">&#39;model_data/ni_xrcall_onaxis_v1.02_arf.txt&#39;</span><span class="p">,</span>
                                  <span class="n">RMF</span> <span class="o">=</span> <span class="s1">&#39;model_data/nicer_upd_d49_matrix.txt&#39;</span><span class="p">,</span>
                                  <span class="n">ratio</span> <span class="o">=</span> <span class="s1">&#39;model_data/crab_ratio_SA80_d49.txt&#39;</span><span class="p">,</span>
                                  <span class="n">max_input</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
                                  <span class="n">min_input</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">channel_edges</span> <span class="o">=</span> <span class="s1">&#39;model_data/nicer_upd_energy_bounds.txt&#39;</span><span class="p">)</span>

<span class="n">interstellar</span> <span class="o">=</span> <span class="n">CustomInterstellar</span><span class="o">.</span><span class="n">from_SWG</span><span class="p">(</span><span class="s1">&#39;model_data/interstellar_phot_frac.txt&#39;</span><span class="p">,</span>
                                       <span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">column_density</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">)))</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">CustomSignal</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span>
                      <span class="n">instrument</span> <span class="o">=</span> <span class="n">NICER</span><span class="p">,</span>
                      <span class="n">interstellar</span> <span class="o">=</span> <span class="n">interstellar</span><span class="p">,</span>
                      <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">workspace_intervals</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
                      <span class="n">epsrel</span> <span class="o">=</span> <span class="mf">1.0e-8</span><span class="p">,</span>
                      <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0e-3</span><span class="p">,</span>
                      <span class="n">sigmas</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>
              <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gravradius</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">16.0</span><span class="p">),</span>
              <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
              <span class="n">cos_inclination</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)))</span>

<span class="n">spacetime</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Spacetime</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">frequency</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">4.87e-3</span><span class="p">)))</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">super_colatitude</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">),</span>
              <span class="n">super_radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">),</span>
              <span class="n">phase_shift</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
              <span class="n">super_temperature</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">6.8</span><span class="p">))</span>

<span class="n">primary</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">values</span><span class="o">=</span><span class="p">{},</span>
                            <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">omit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">cede</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                            <span class="n">min_sqrt_num_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">max_sqrt_num_cells</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">do_fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">num_leaves</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                            <span class="n">num_rays</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                            <span class="n">is_secondary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="c1"># we transform to these geometric parameters, so see CustomPrior instead</span>
<span class="c1"># for inverse sampling setup</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">super_colatitude</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># see CustomPrior</span>
                <span class="n">super_radius</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># see CustomPrior</span>
                <span class="n">phase_shift</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                <span class="n">super_temperature</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">6.8</span><span class="p">),</span>
                <span class="n">omit_colatitude</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                <span class="n">omit_radius</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1"># see CustomPrior</span>
                <span class="n">omit_azimuth</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="c1"># see CustomPrior</span>

<span class="c1"># overlap of an omission region and</span>
<span class="c1"># and a radiating super region</span>
<span class="n">secondary</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">values</span><span class="o">=</span><span class="p">{},</span>
                            <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">omit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">cede</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                            <span class="n">min_sqrt_num_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">max_sqrt_num_cells</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                            <span class="n">num_leaves</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                            <span class="n">num_rays</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                            <span class="n">do_fast</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">is_secondary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">xpsi</span> <span class="kn">import</span> <span class="n">HotRegions</span>

<span class="n">hot</span> <span class="o">=</span> <span class="n">HotRegions</span><span class="p">((</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">))</span>

<span class="n">photosphere</span> <span class="o">=</span> <span class="n">CustomPhotosphere</span><span class="p">(</span><span class="n">hot</span> <span class="o">=</span> <span class="n">hot</span><span class="p">,</span> <span class="n">elsewhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode_frequency</span> <span class="o">=</span> <span class="n">spacetime</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]))</span>

<span class="n">photosphere</span><span class="o">.</span><span class="n">hot_atmosphere</span> <span class="o">=</span> <span class="s1">&#39;model_data/nsx_H_v171019.out&#39;</span>

<span class="n">star</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Star</span><span class="p">(</span><span class="n">spacetime</span> <span class="o">=</span> <span class="n">spacetime</span><span class="p">,</span> <span class="n">photospheres</span> <span class="o">=</span> <span class="n">photosphere</span><span class="p">)</span>

<span class="n">likelihood</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Likelihood</span><span class="p">(</span><span class="n">star</span> <span class="o">=</span> <span class="n">star</span><span class="p">,</span> <span class="n">signals</span> <span class="o">=</span> <span class="n">signal</span><span class="p">,</span>
                             <span class="n">num_energies</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
                             <span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="n">externally_updated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">prior</span> <span class="o">=</span> <span class="n">CustomPrior</span><span class="p">()</span>

<span class="n">likelihood</span><span class="o">.</span><span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span>

<span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4033703360094012</span><span class="p">,</span>
     <span class="mf">13.378462458584202</span><span class="p">,</span>
     <span class="mf">0.32897884439908337</span><span class="p">,</span>
     <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.004349731136371</span><span class="p">),</span>
     <span class="mf">0.4542555093514883</span><span class="p">,</span>
     <span class="mf">2.1937752730930784</span><span class="p">,</span>
     <span class="mf">0.07916088420116879</span><span class="p">,</span>
     <span class="mf">6.106556223820221</span><span class="p">,</span>
     <span class="mf">0.4768294130316574</span><span class="p">,</span>
     <span class="mf">2.7162985247930496</span><span class="p">,</span>
     <span class="mf">0.32234225478780626</span><span class="p">,</span>
     <span class="mf">6.1173049179880445</span><span class="p">,</span>
     <span class="mf">2.7463301464251777</span><span class="p">,</span>
     <span class="mf">0.2844169651751102</span><span class="p">,</span>
     <span class="o">-</span><span class="mf">0.048326090505605386</span><span class="p">,</span>
     <span class="mf">1.0335682718716097</span><span class="p">,</span>
     <span class="mf">0.02227107198360202</span><span class="p">,</span>
     <span class="mf">0.8748566319738948</span><span class="p">,</span>
     <span class="mf">0.4604998629950954</span><span class="p">]</span>

<span class="c1"># source code changes since model was applied, so let&#39;s be a</span>
<span class="c1"># bit lenient when checking the likelihood function</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">36316.354394388654</span><span class="p">],</span> <span class="mf">1.0e-4</span><span class="p">,</span>
                 <span class="n">physical_points</span><span class="o">=</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

<span class="n">wrapped_params</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">likelihood</span><span class="p">)</span>
<span class="n">wrapped_params</span><span class="p">[</span><span class="n">likelihood</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">runtime_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resume&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;importance_nested_sampling&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;multimodal&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;n_clustering_params&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="s1">&#39;outputfiles_basename&#39;</span><span class="p">:</span> <span class="s1">&#39;./run1_nlive1000_eff0.3_noCONST_noMM_noIS_tol-1&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;n_iter_before_update&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                  <span class="s1">&#39;n_live_points&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                  <span class="s1">&#39;sampling_efficiency&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                  <span class="s1">&#39;const_efficiency_mode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;wrapped_params&#39;</span><span class="p">:</span> <span class="n">wrapped_params</span><span class="p">,</span>
                  <span class="s1">&#39;evidence_tolerance&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                  <span class="s1">&#39;max_iter&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                  <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

<span class="n">xpsi</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">nested</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span> <span class="n">prior</span><span class="p">,</span> <span class="n">check_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">runtime_params</span><span class="p">)</span>
</pre></div>
</div>
<p>We proceed to show the custom modules required for the model.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Write more extensive inline comments for clarity, and clean up where
applicable.</p>
</div>
</div>
<div class="section" id="photosphere">
<h2>Photosphere<a class="headerlink" href="#photosphere" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; CustomPhotosphere.py &quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">xpsi</span>

<span class="k">class</span> <span class="nc">CustomPhotosphere</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Photosphere</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A photosphere extension to preload the numerical atmosphere NSX. &quot;&quot;&quot;</span>

    <span class="nd">@xpsi</span><span class="o">.</span><span class="n">Photosphere</span><span class="o">.</span><span class="n">hot_atmosphere</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">hot_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">NSX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="n">logT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">35</span><span class="p">)</span>
        <span class="n">logg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">67</span><span class="p">)</span>
        <span class="n">logE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">166</span><span class="p">)</span>

        <span class="n">reorder_buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">35</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">67</span><span class="p">,</span><span class="mi">166</span><span class="p">))</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                   <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">logT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NSX</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">logg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">NSX</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">logE</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">NSX</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">mu</span><span class="p">[</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NSX</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">reorder_buf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.0</span><span class="o">**</span><span class="p">(</span><span class="n">NSX</span><span class="p">[</span><span class="n">index</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">buf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>

        <span class="n">bufdex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                   <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reorder_buf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="n">buf</span><span class="p">[</span><span class="n">bufdex</span><span class="p">]</span> <span class="o">=</span> <span class="n">reorder_buf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">];</span> <span class="n">bufdex</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span> <span class="o">=</span> <span class="p">(</span><span class="n">logT</span><span class="p">,</span> <span class="n">logg</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">logE</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="instrument">
<h2>Instrument<a class="headerlink" href="#instrument" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; CustomInstrument.py &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">xpsi</span>
<span class="kn">from</span> <span class="nn">xpsi</span> <span class="kn">import</span> <span class="n">Parameter</span>

<span class="k">class</span> <span class="nc">CustomInstrument</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Instrument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Methods and attributes specific to the NICER instrument.</span>

<span class="sd">    Currently tailored to the NICER light-curve SWG model specification.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set channel edges attribute. &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CustomInstrument</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">construct_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement response matrix parameterisation. &quot;&quot;&quot;</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span>
        <span class="n">matrix</span><span class="p">[</span><span class="n">matrix</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">matrix</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overwrite. &quot;&quot;&quot;</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">construct_matrix</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached_signal</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_SWG</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                 <span class="n">bounds</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>
                 <span class="n">ARF</span><span class="p">,</span> <span class="n">RMF</span><span class="p">,</span>
                 <span class="n">max_input</span><span class="p">,</span> <span class="n">min_input</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">channel_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructor which converts files into :class:`numpy.ndarray`s.</span>

<span class="sd">        :param str ARF: Path to ARF which is compatible with</span>
<span class="sd">                                :func:`numpy.loadtxt`.</span>

<span class="sd">        :param str RMF: Path to RMF which is compatible with</span>
<span class="sd">                                :func:`numpy.loadtxt`.</span>

<span class="sd">        :param str channel_edges: Optional path to edges which is compatible with</span>
<span class="sd">                                :func:`numpy.loadtxt`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ARF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">ARF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">RMF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">RMF</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">channel_edges</span><span class="p">:</span>
            <span class="n">channel_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">channel_edges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1501</span><span class="p">,</span><span class="mi">3980</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3980</span><span class="p">):</span>
            <span class="n">matrix</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RMF</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">1501</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">1501</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">min_input</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_input</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_input</span><span class="p">)</span>

        <span class="n">max_input</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_input</span><span class="p">)</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

        <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">RSP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">25</span><span class="p">:</span><span class="mi">300</span><span class="p">,</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RSP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">RSP</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">25</span><span class="p">,</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">]</span> <span class="o">*</span> <span class="n">ARF</span><span class="p">[</span><span class="n">min_input</span><span class="p">:</span><span class="n">max_input</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mf">49.0</span><span class="o">/</span><span class="mf">52.0</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>

        <span class="n">alpha</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span>
                          <span class="n">strict_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">),</span>
                          <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                          <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;alpha&#39;</span><span class="p">,</span>
                          <span class="n">symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\alpha$&#39;</span><span class="p">,</span>
                          <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>


        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">RSP</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">channel_edges</span><span class="p">[</span><span class="mi">25</span><span class="p">:</span><span class="mi">301</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="interstellar">
<h2>Interstellar<a class="headerlink" href="#interstellar" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; CustomInterstellar.py &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">xpsi</span>
<span class="kn">from</span> <span class="nn">xpsi</span> <span class="kn">import</span> <span class="n">Parameter</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">Akima1DInterpolator</span>

<span class="k">class</span> <span class="nc">CustomInterstellar</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Interstellar</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Apply interstellar attenuation. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">attenuation</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{}):</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">attenuation</span><span class="p">),</span> <span class="s1">&#39;Array length mismatch.&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_lkp_energies</span> <span class="o">=</span> <span class="n">energies</span> <span class="c1"># for lookup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lkp_attenuation</span> <span class="o">=</span> <span class="n">attenuation</span> <span class="c1"># for lookup</span>

        <span class="n">N_H</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;column_density&#39;</span><span class="p">,</span>
                        <span class="n">strict_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">10.0</span><span class="p">),</span>
                        <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_density&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">doc</span> <span class="o">=</span> <span class="s1">&#39;Units of 10^20 cm^-2.&#39;</span><span class="p">,</span>
                        <span class="n">symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$N_{\rm H}$&#39;</span><span class="p">,</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;column_density&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CustomInterstellar</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">N_H</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">attenuation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Interpolate the attenuation coefficients.</span>

<span class="sd">        Useful for post-processing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;column_density&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interpolator</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interpolator</span> <span class="o">=</span> <span class="n">Akima1DInterpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lkp_energies</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_lkp_attenuation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interpolator</span><span class="o">.</span><span class="n">extrapolate</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpolator</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_SWG</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load attenuation file from the NICER SWG. &quot;&quot;&quot;</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

        <span class="n">energies</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">351</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">attenuation</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">351</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">attenuation</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="signal">
<h2>Signal<a class="headerlink" href="#signal" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; CustomSignal.py &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">import</span> <span class="nn">xpsi</span>

<span class="kn">from</span> <span class="nn">xpsi.likelihoods.default_background_marginalisation</span> <span class="kn">import</span> <span class="n">eval_marginal_likelihood</span>
<span class="kn">from</span> <span class="nn">xpsi.likelihoods.default_background_marginalisation</span> <span class="kn">import</span> <span class="n">precomputation</span>

<span class="k">class</span> <span class="nc">CustomSignal</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Signal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A custom calculation of the logarithm of the likelihood.</span>

<span class="sd">    We extend the :class:`xpsi.Signal.Signal` class to make it callable.</span>

<span class="sd">    We overwrite the body of the __call__ method. The docstring for the</span>
<span class="sd">    abstract method is copied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workspace_intervals</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">epsabs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">epsrel</span> <span class="o">=</span> <span class="mf">1.0e-8</span><span class="p">,</span>
                 <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1.0e-3</span><span class="p">,</span> <span class="n">sigmas</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">support</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform precomputation. &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CustomSignal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_precomp</span> <span class="o">=</span> <span class="n">precomputation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No data... can synthesise data but cannot evaluate a &#39;</span>
                  <span class="s1">&#39;likelihood function.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_workspace_intervals</span> <span class="o">=</span> <span class="n">workspace_intervals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epsabs</span> <span class="o">=</span> <span class="n">epsabs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epsrel</span> <span class="o">=</span> <span class="n">epsrel</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span> <span class="o">=</span> <span class="n">epsilon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sigmas</span> <span class="o">=</span> <span class="n">sigmas</span>

            <span class="k">if</span> <span class="n">support</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="n">support</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_support</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_support</span>

    <span class="nd">@support</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_support</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase_shifts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_shifts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loglikelihood</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_signal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">background_given_support</span> <span class="o">=</span> \
                <span class="n">eval_marginal_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">exposure_time</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">counts</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_signals</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_shifts</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_precomp</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_support</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_workspace_intervals</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_epsabs</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_epsrel</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_epsilon</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_sigmas</span><span class="p">,</span>
                                          <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;llzero&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="prior">
<h2>Prior<a class="headerlink" href="#prior" title="Permalink to this headline">Â¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; CustomPrior.py &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">truncnorm</span>

<span class="kn">import</span> <span class="nn">xpsi</span>
<span class="kn">from</span> <span class="nn">xpsi.global_imports</span> <span class="kn">import</span> <span class="n">_G</span><span class="p">,</span> <span class="n">_csq</span><span class="p">,</span> <span class="n">_km</span><span class="p">,</span> <span class="n">_M_s</span><span class="p">,</span> <span class="n">_2pi</span>
<span class="kn">from</span> <span class="nn">xpsi.global_imports</span> <span class="kn">import</span> <span class="n">gravradius</span><span class="p">,</span> <span class="n">inv_gravradius</span>

<span class="kn">from</span> <span class="nn">xpsi.cellmesh.mesh_tools</span> <span class="kn">import</span> <span class="n">eval_cedeCentreCoords</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">Akima1DInterpolator</span>

<span class="k">class</span> <span class="nc">CustomPrior</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Prior</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A custom (joint) prior distribution.</span>

<span class="sd">    Source: PSR J0030+0451</span>
<span class="sd">    Model variant: ST+PST</span>
<span class="sd">        Two single-temperature hot regions with unshared parameters</span>
<span class="sd">        and different complexity levels.</span>

<span class="sd">    Parameter vector: (print the likelihood object)</span>

<span class="sd">    * p[0] = (rotationally deformed) gravitational mass (solar masses)</span>
<span class="sd">    * p[1] = coordinate equatorial radius (km)</span>
<span class="sd">    * p[2] = distance (kpc)</span>
<span class="sd">    * p[3] = cos(inclination of Earth to rotational axis)</span>
<span class="sd">    * p[4] = primary cap phase shift (cycles); (alias for initial azimuth, periodic)</span>
<span class="sd">    * p[5] = primary centre colatitude (radians)</span>
<span class="sd">    * p[6] = primary angular radius (radians)</span>
<span class="sd">    * p[7] = primary log10(comoving NSX FIH effective temperature [K])</span>
<span class="sd">    * p[8] = secondary cap phase shift (cycles)</span>
<span class="sd">    * p[9] = secondary centre colatitude (radians)</span>
<span class="sd">    * p[10] = secondary angular radius (radians)</span>
<span class="sd">    * p[11] = secondary omit colatitude (radians)</span>
<span class="sd">    * p[12] = secondary omit angular radius (radians)</span>
<span class="sd">    * p[13] = secondary omit azimuth (radians); periodic</span>
<span class="sd">    * p[14] = secondary log10(comoving NSX FIH effective temperature [K])</span>
<span class="sd">    * p[15] = hydrogen column density (10^20 cm^-2)</span>
<span class="sd">    * p[16] = instrument parameter alpha</span>
<span class="sd">    * p[17] = instrument parameter beta</span>
<span class="sd">    * p[18] = instrument parameter gamma</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__derived_names__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;compactness&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;s__annulus_width&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;s__transformed_phase&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;s__f&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;s__xi&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;s__super_offset_fraction&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;s__super_offset_azi&#39;</span><span class="p">]</span>

    <span class="n">a_f</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">b_f</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">a_xi</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">b_xi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">a_xi</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">b_xi</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct mapping from unit interval. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span> <span class="o">=</span> <span class="n">Akima1DInterpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vector_super_radius_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="o">.</span><span class="n">extrapolate</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Evaluate distribution at ``p``.</span>

<span class="sd">        :param list p: Model parameter values.</span>

<span class="sd">        :return: Logarithm of the distribution evaluated at ``p``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CustomPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">temp</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">temp</span>

        <span class="c1"># based on contemporary EOS theory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">16.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">star</span><span class="o">.</span><span class="n">spacetime</span> <span class="c1"># shortcut</span>

        <span class="c1"># polar radius at photon sphere for ~static star (static ambient spacetime)</span>
        <span class="n">R_p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">ref</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.788</span> <span class="o">+</span> <span class="mf">1.030</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">zeta</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">R_p</span> <span class="o">&lt;</span> <span class="mf">1.5</span> <span class="o">/</span> <span class="n">ref</span><span class="o">.</span><span class="n">R_r_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="c1"># limit polar radius to try to exclude deflections &gt;= \pi radians</span>
        <span class="c1"># due to oblateness this does not quite eliminate all configurations</span>
        <span class="c1"># with deflections &gt;= \pi radians</span>
        <span class="c1">#if R_p &lt; 1.76 / ref.R_r_s:</span>
        <span class="c1">#    return -np.inf</span>

        <span class="n">mu</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.788</span> <span class="o">+</span> <span class="mf">1.030</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">zeta</span><span class="p">)))</span>

        <span class="c1"># 2-surface cross-section have a single maximum in |z|</span>
        <span class="c1"># i.e., an elliptical surface; minor effect on support, if any,</span>
        <span class="c1"># for high spin frequenies</span>
        <span class="k">if</span> <span class="n">mu</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="c1"># redefine shortcut</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">_2pi</span>
        <span class="n">phi</span> <span class="o">-=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_azimuth&#39;</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">_2pi</span> <span class="o">-</span> <span class="n">phi</span>

        <span class="n">ang_sep</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="o">.</span><span class="n">psi</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">],</span>
                                     <span class="n">phi</span><span class="p">,</span>
                                     <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">])</span>

        <span class="c1"># hot regions cannot overlap</span>
        <span class="k">if</span> <span class="n">ang_sep</span> <span class="o">&lt;</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="nf">_I</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_II</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_scalar_super_radius_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_II</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_I</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mass</span>

    <span class="k">def</span> <span class="nf">_vector_super_radius_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">masses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">masses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scalar_super_radius_mass</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>

        <span class="n">masses</span> <span class="o">/=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_f</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_f</span><span class="p">)</span>
        <span class="n">masses</span> <span class="o">/=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">masses</span>

    <span class="k">def</span> <span class="nf">_inverse_sample_cede_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">psi</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">psi</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">psi</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_xi</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span><span class="o">/</span><span class="n">psi</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">psi</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span><span class="o">/</span><span class="n">psi</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">psi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_xi</span><span class="o">/</span><span class="n">psi</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inverse_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hypercube</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Draw sample uniformly from the distribution via inverse sampling.</span>

<span class="sd">        :param hypercube: A pseudorandom point in an n-dimensional hypercube.</span>

<span class="sd">        :return: A parameter ``list``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">vector</span>

        <span class="k">if</span> <span class="n">hypercube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hypercube</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="n">_</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CustomPrior</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">(</span><span class="n">hypercube</span><span class="p">)</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="c1"># redefine shortcut</span>

        <span class="c1"># draw from flat prior in inclination</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="n">b</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncnorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                        <span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span>
                                        <span class="n">loc</span><span class="o">=</span><span class="mf">0.325</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.009</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="mf">0.35</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.25</span> <span class="o">+</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="p">(</span><span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inverse_sample_cede_radius</span><span class="p">(</span><span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                                                  <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">])</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]:</span>
            <span class="c1"># temp var</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># temp var</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;s__omit_azimuth&#39;</span><span class="p">)</span>
        <span class="c1"># temp var</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">_2pi</span>

        <span class="c1"># function from mesh tools module</span>
        <span class="c1"># in this case the ceding region is the &quot;super&quot; region, which</span>
        <span class="c1"># cedes to the omission region</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">],</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">eval_cedeCentreCoords</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_colatitude&#39;</span><span class="p">],</span> <span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_azimuth&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncnorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                     <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span>
                                     <span class="n">loc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">)</span>
        <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncnorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">hypercube</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                     <span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span>
                                     <span class="n">loc</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># restore proper cache</span>
        <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">cache</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="n">to_cache</span><span class="p">):</span>
            <span class="n">parameter</span><span class="o">.</span><span class="n">cached</span> <span class="o">=</span> <span class="n">cache</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">vector</span> <span class="c1"># only free parameter values returned</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">old_API</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A transformation for post-processing.</span>

<span class="sd">        Note that if you want to use dictionary-like access to values,</span>
<span class="sd">        you could make a dictionary, e.g.:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            ref = dict(zip(self.parameters.names, p))</span>

<span class="sd">        and use the ``__getitem__`` functionality of ``ref`` instead of</span>
<span class="sd">        numeric indexing.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c1"># copy</span>

        <span class="k">if</span> <span class="n">old_API</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="c1"># used ordered names and values</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

        <span class="c1"># compactness ratio M/R_eq</span>
        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gravradius</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]]</span>

        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]]</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">eval_cedeCentreCoords</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_colatitude&#39;</span><span class="p">],</span>
                                     <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">],</span>
                                     <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_azimuth&#39;</span><span class="p">])</span>

        <span class="n">azi</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">azi</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">azi</span> <span class="o">+=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> \
              <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> \
              <span class="k">else</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]]</span> <span class="c1"># f</span>

        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> \
              <span class="o">&lt;=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]]</span> <span class="c1"># xi</span>

        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">])</span> \
              <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> \
              <span class="k">else</span> <span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__omit_radius&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">])]</span> <span class="c1"># kappa</span>

        <span class="n">p</span> <span class="o">+=</span> <span class="p">[</span><span class="n">azi</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">p</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="postprocessing_tutorial.html" class="btn btn-neutral float-left" title="Post-processing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="example_job.html" class="btn btn-neutral float-right" title="Example job" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, 2020, 2021 Thomas E. Riley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>