<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multiple imaging &mdash; xpsi 0.7.10 documentation</title><link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Post-processing" href="postprocessing_tutorial.html" />
    <link rel="prev" title="Modeling (without statistics)" href="model_construction_streamlined.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> xpsi
          </a>
              <div class="version">
                0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgements.html">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_instruments.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field_checking_tools_tutorial.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction_streamlined.html">Modeling (without statistics)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Multiple imaging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Default-(phase-invariant)">Default (phase-invariant)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Linking-in-rayXpanda">Linking in rayXpanda</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Decreasing-the-image-order-limit">Decreasing the image order limit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Multiple-images">Multiple images</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Millisecond-pulsar-spin-(phase-invariant)">Millisecond pulsar spin (phase-invariant)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Custom-(phase-dependent)">Custom (phase-dependent)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing_tutorial.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="example_job.html">Example job</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="signal.html">Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Extension modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="extensions_overview.html">Overview of extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="surface_radiation_field.html">Surface radiation field</a></li>
<li class="toctree-l1"><a class="reference internal" href="likelihood_implementations.html">Likelihoods</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="postprocessing.html">PostProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">xpsi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Multiple imaging</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/multiple_imaging.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Multiple-imaging">
<h1>Multiple imaging<a class="headerlink" href="#Multiple-imaging" title="Permalink to this headline">¶</a></h1>
<p>Let’s explore simulation of signals generated by neutron stars sufficiently compact to generate multiple images of a subset or even all of the surface. En route we demonstrate correctness for an oblate surface embedded in an ambient Schwarzschild spacetime by calling <em>four</em> integrators whose algorithms are (vastly) different. In particular integrators that directly discretise the surface with a regular mesh will be compared to an integrator that discretises a moderately distant image-plane;
integrators that employs these distinct discretisation schemes in the computational domain are effectively orthogonal and provide strong internal validation of the ray-tracing backend used for statistical computation in practice. We will also replace numerical primary-image ray solutions (lensing integral computed via numerical quadrature and inversion by spline interpolation) with a high-order lensing integral expansion via linking to the
<a class="reference external" href="https://github.com/ThomasEdwardRiley/rayXpanda">rayXpanda</a> package.</p>
<p>Ultimately, we conclude that the inclusion of secondary images is important in practice, whilst the inclusion of tertiary images is unimportant in practice, and the inclusion of quaternary order and higher is entirely unnecessary as far as we can forsee.</p>
<p><strong>Note that if you wish to execute this notebook as is, it is costly because we use rather high-resolution calculations to probe convergence of different integrators. You can also lower the integrator resolution settings and change the model parameters including the stellar spin frequency, the spacetime properties, and the source-receiver configuration.</strong></p>
<p>The unexecuted notebook for this tutorial may be found in a GitHub repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/ThomasEdwardRiley/xpsi_workshop.git &lt;/path/to/clone&gt;

<span class="nb">cd</span> &lt;/path/to/clone&gt;/tutorials/v0.6/
</pre></div>
</div>
<p>You can use the default atmosphere extension modules <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/archive/hot/blackbody.pyx</span></code> and <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/archive/local_variables/uniform.pyx</span></code>. To run this tutorial, you should therefore be able to simply use the default <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/hot.pyx</span></code> extension and <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/local_variables.pyx</span></code> that are automatically compiled when X-PSI is installed.</p>
<p>The first part of this tutorial largely follows the <em>Global surface emission</em> tutorial. We use a surface radiation field that is globally uniform to compare all integrators. We use an effectively spherical star by entering the limit of zero spin.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">AutoLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">xpsi</span>
<span class="kn">from</span> <span class="nn">xpsi</span> <span class="kn">import</span> <span class="n">Parameter</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">xpsi</span><span class="o">.</span><span class="n">cellmesh</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># use the override switch to deactivate external library for now</span>
    <span class="c1"># this means that lensing integral solutions will be fully numerical</span>
    <span class="n">xpsi</span><span class="o">.</span><span class="n">cellmesh</span><span class="o">.</span><span class="n">__deactivate_rayXpanda__</span> <span class="o">=</span> <span class="kc">True</span>

<span class="kn">from</span> <span class="nn">xpsi.global_imports</span> <span class="kn">import</span> <span class="n">_c</span><span class="p">,</span> <span class="n">_G</span><span class="p">,</span> <span class="n">_dpr</span><span class="p">,</span> <span class="n">gravradius</span><span class="p">,</span> <span class="n">_csq</span><span class="p">,</span> <span class="n">_km</span><span class="p">,</span> <span class="n">_2pi</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
/=============================================\
| X-PSI: X-ray Pulse Simulation and Inference |
|---------------------------------------------|
|                Version: 0.6.0               |
|---------------------------------------------|
|  https://thomasedwardriley.github.io/xpsi/  |
\=============================================/

Imported GetDist version: 0.3.1
Imported nestcheck version: 0.2.0
</pre></div></div>
</div>
<p>First we need to do some setup of the ambient spacetime and the surface embedded in it that the photosphere exists on.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">600.0</span><span class="p">),</span>
              <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>                     <span class="c1"># (Earth) distance</span>
              <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>                         <span class="c1"># mass</span>
              <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">gravradius</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">16.0</span><span class="p">),</span>    <span class="c1"># equatorial radius</span>
              <span class="n">cos_inclination</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>              <span class="c1"># (Earth) inclination to rotation axis</span>

<span class="n">spacetime</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Spacetime</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span> <span class="c1"># spherical star</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;frequency&#34; with bounds [1.000e-01, 6.000e+02] and initial value 1.000e-01.
    &gt; Spin frequency [Hz].


Creating parameter:
    &gt; Named &#34;mass&#34; with bounds [1.000e+00, 3.000e+00].
    &gt; Gravitational mass [solar masses].


Creating parameter:
    &gt; Named &#34;radius&#34; with bounds [4.430e+00, 1.600e+01].
    &gt; Coordinate equatorial radius [km].


Creating parameter:
    &gt; Named &#34;distance&#34; with bounds [1.000e-01, 1.000e+00].
    &gt; Earth distance [kpc].


Creating parameter:
    &gt; Named &#34;cos_inclination&#34; with bounds [0.000e+00, 1.000e+00].
    &gt; Cosine of Earth inclination to rotation axis.


</pre></div></div>
</div>
<div class="section" id="Default-(phase-invariant)">
<h2>Default (phase-invariant)<a class="headerlink" href="#Default-(phase-invariant)" title="Permalink to this headline">¶</a></h2>
<p>First we invoke a globally uniform temperature field. There is no azimuthal dependence, meaning that the signal generated by the star is time-invariant. We are in need of an object that embeds a <em>globally</em> discretised surface into the ambient spacetime and exposes methods for integration over solid angle on our sky.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

<span class="n">everywhere</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Everywhere</span><span class="p">(</span><span class="n">time_invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                             <span class="n">values</span><span class="o">=</span><span class="p">{},</span> <span class="c1"># no fixed/derived variables</span>
                             <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># in colatitude, and in azimuth separately</span>
                             <span class="n">num_rays</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># O(1000) useful for secondary and tertiary images</span>
                             <span class="n">num_leaves</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="c1"># specify leaves if time-dependent</span>
                             <span class="n">num_phases</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="c1"># of the output signal</span>
                             <span class="n">image_order_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># as many images as possible within resolution</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;temperature&#34; with bounds [3.000e+00, 7.000e+00].
    &gt; log10(effective temperature [K] everywhere).


</pre></div></div>
</div>
<p>We are free to subclass <a class="reference internal" href="everywhere.html#xpsi.Everywhere.Everywhere"><span class="std std-ref">Everywhere</span></a> and implement custom functionality beyond the simple default above. The argument specifying the number of rays has the familiar meaning. The argument for the number of cells is now used to discretise the surface in azimuth and colatitude with respect to the stellar rotation axis, as was the case for the <a class="reference internal" href="elsewhere.html#xpsi.Elsewhere.Elsewhere"><span class="std std-ref">Elsewhere</span></a> module. The new argument <code class="docutils literal notranslate"><span class="pre">time_invariant</span></code> declares
whether or not the surface radiation field is dependent on azimuth; if it is independent of azimuth, a faster integrator is called.</p>
<p>Now we need an instance of <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a> that we can feed our <code class="docutils literal notranslate"><span class="pre">everywhere</span></code> object to. If we are not imaging the photosphere or we are satisfied with the default behaviour we do <em>not</em> need to subclass <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">derive</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Derive</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundto</span><span class="p">,</span> <span class="n">caller</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">spacetime</span>
        <span class="k">return</span> <span class="n">spacetime</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Photosphere</span><span class="p">(</span><span class="n">hot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">elsewhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">everywhere</span> <span class="o">=</span> <span class="n">everywhere</span><span class="p">,</span>
                               <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode_frequency</span> <span class="o">=</span> <span class="n">derive</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;mode_frequency&#34; that is derived from ulterior variables.
    &gt; Coordinate frequency of the mode of radiative asymmetry in the
photosphere that is assumed to generate the pulsed signal [Hz].


</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Star</span><span class="p">(</span><span class="n">spacetime</span> <span class="o">=</span> <span class="n">spacetime</span><span class="p">,</span> <span class="n">photospheres</span> <span class="o">=</span> <span class="n">photosphere</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s check the vector of parameter values in the <code class="docutils literal notranslate"><span class="pre">Star</span></code> instance and the other objects it encapsulates references to.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Free parameters
---------------
frequency: Spin frequency [Hz].
mass: Gravitational mass [solar masses].
radius: Coordinate equatorial radius [km].
distance: Earth distance [kpc].
cos_inclination: Cosine of Earth inclination to rotation axis.
temperature: log10(effective temperature [K] everywhere).
</pre></div></div>
</div>
<p>We assign parameter values and update the star as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># (Earth) distance</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.33</span>
<span class="c1"># gravitational mass</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.7088795</span>
<span class="c1"># coordinate equatorial radius</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="c1"># (Earth) inclination to rotation axis</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="c1"># isotropic blackbody temperature</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.3</span>

<span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>The temperature is chosen to be something appropriately hot for the energy range, so that the specific flux at the lowest energies is <em>not</em> dominated by bright stellar limb, which will be the case for targets in X-ray telescope wavebands. More on this later.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span><span class="o">.</span><span class="n">R_r_s</span> <span class="c1"># rather compact! effectively @ the Schwarzschild photon sphere</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.5000001812176318
</pre></div></div>
</div>
<p>Let’s see what the maximum deflection is calculated to be conditional on the resolution:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">_maxDeflection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">xpsi</span><span class="o">.</span><span class="n">global_imports</span><span class="o">.</span><span class="n">_pi</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
5.44436523851195
</pre></div></div>
</div>
<p>A true maximum deflection of this value, for a spherical star, would mean a subset of the stellar surface would be imaged <em>six</em> times. This subset is defined by having a <em>principal</em> deflection of <span class="math notranslate nohighlight">\(\psi\gtrsim(1-0.4444)\pi\)</span>, meaning a spherical cap of this angular radius centred on the direction between Earth and the centre of the star. The subset of the surface with <em>principal</em> deflection of <span class="math notranslate nohighlight">\(\psi\lesssim(1-0.4444)\pi\)</span>, and by definition less than <span class="math notranslate nohighlight">\(\pi\)</span>, is <em>only</em> imaged <em>five</em>
times.</p>
<p>Let’s compute the incident specific flux signal, up to some constant coefficient.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># calls to xpsi/cellmesh/integrator_for_time_invariance.pyx</span>
</pre></div>
</div>
</div>
<p>The signal is time-invariant and therefore we need to copy the spectrum to a sequence of matrix columns to get the desired energy-phase signal matrix:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">temp_int1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<p>We need a helper function to plot the signal, normalised to the maximum specific flux:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">xpsi.tools</span> <span class="kn">import</span> <span class="n">phase_interpolator</span>

<span class="k">def</span> <span class="nf">plot_2D_pulse</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span>
                  <span class="n">num_rotations</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function to plot a phase-energy pulse.</span>

<span class="sd">    :param array-like z:</span>
<span class="sd">        A pair of *ndarray[m,n]* objects representing the signal at</span>
<span class="sd">        *n* phases and *m* values of an energy variable.</span>

<span class="sd">    :param ndarray[n] x: Phases the signal is resolved at.</span>

<span class="sd">    :param tuple shift: Hot region phase parameters.</span>

<span class="sd">    :param ndarray[m] x: Energy values the signal is resolved at.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

    <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">new_phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">num_rotations</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
        <span class="n">joint</span> <span class="o">=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">joint</span> <span class="o">+=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">_temp</span> <span class="o">=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                      <span class="n">x</span><span class="p">,</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">interpolated</span> <span class="o">=</span> <span class="n">_temp</span> <span class="o">-</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                           <span class="n">x</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">interpolated</span> <span class="o">/=</span> <span class="n">_temp</span><span class="o">/</span><span class="mf">100.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">interpolated</span> <span class="o">=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                          <span class="n">x</span><span class="p">,</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">shift</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interpolated</span> <span class="o">=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                          <span class="n">x</span><span class="p">,</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">interpolated</span> <span class="o">+=</span> <span class="n">phase_interpolator</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                                                   <span class="n">x</span><span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
        <span class="n">interpolated</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">interpolated</span><span class="p">)</span>

    <span class="n">profile</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">new_phases</span><span class="p">,</span>
                             <span class="n">y</span><span class="p">,</span>
                             <span class="n">interpolated</span><span class="p">,</span>
                             <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="p">,</span>
                             <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span>
                             <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span>
                             <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                             <span class="n">rasterized</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">profile</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">num_rotations</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Phase (cycles)&#39;</span><span class="p">)</span>
    <span class="n">veneer</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span>
                      <span class="n">cax</span> <span class="o">=</span> <span class="n">ax_cb</span><span class="p">,</span>
                      <span class="n">ticks</span> <span class="o">=</span> <span class="n">AutoLocator</span><span class="p">())</span>

    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="ow">or</span> <span class="sa">r</span><span class="s1">&#39;Signal (normalised by maximum)&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">solids</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

    <span class="n">cb</span><span class="o">.</span><span class="n">outline</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">joint</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">18.0</span>

<span class="k">def</span> <span class="nf">veneer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make the plots a little more aesthetically pleasing. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">(</span><span class="n">temp_int1</span><span class="p">,</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_34_0.png" src="_images/multiple_imaging_34_0.png" />
</div>
</div>
<p>If we declare the signal as time-dependent, a different integrator is called:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">time_invariant</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># switches to xpsi/cellmesh/integrator.pyx</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">_integrator_toggle</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">temp_int2</span> <span class="o">=</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">temp_int2</span><span class="p">,</span> <span class="n">temp_int1</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.001</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_40_0.png" src="_images/multiple_imaging_40_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">_integrator_toggle</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># switch to final integrator that discretises surface, xpsi/cellmesh/integrator_for_azimuthal_invariance.pyx, for testing</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">temp_int3</span> <span class="o">=</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">temp_int3</span><span class="p">,</span> <span class="n">temp_int2</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.000001</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_44_0.png" src="_images/multiple_imaging_44_0.png" />
</div>
</div>
<p>We can also call a fourth integrator. This integrator is more general purpose, and thus inexorably more expensive to call. First we need to force the spacetime to be static (otherwise univeral relations are invoked based on the stellar spin frequency as set above):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># spacetime spin parameter (~angular momentum)</span>
<span class="n">spacetime</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># spacetime mass quadrupole moment</span>
</pre></div>
</div>
</div>
<p>Now we call the integrator. The integrator discretises a distant image plane instead of the stellar surface. The <em>image</em> of the star is spatially resolved on the image plane. The integrator yields four-dimensional information about the signal. We trace a set of rays from the image plane to the star; the set is roughly equal in cardinality to the number of cells that discretise the surface above. Note that when this extension module is called, some output for diagnostics is directed to the
terminal in which you launched this Jupyter notebook.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">reimage</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">reuse_ray_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                  <span class="n">phases</span> <span class="o">=</span> <span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                  <span class="n">sqrt_num_rays</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
                  <span class="c1"># squeeze rays towards limb where higher-order images are</span>
                  <span class="n">image_plane_radial_increment_power</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                  <span class="n">threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>          <span class="c1"># OpenMP</span>
                  <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>   <span class="c1"># max number of steps per ray</span>
                  <span class="n">epsrel_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="c1"># ray relative tolerance</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imaging the star...
Commencing ray tracing and imaging...
Ray tracing complete.
Ray set cached.
Phase-resolved specific flux integration complete.
Star imaged.
</pre></div></div>
</div>
<p>We now compare the signal to those computed above. The phase-energy resolved specific flux signal (integrated over sky solid angle) can be accessed through the <code class="docutils literal notranslate"><span class="pre">images</span></code> property of the <code class="docutils literal notranslate"><span class="pre">photosphere</span></code> object. The elements of this property also contain image plane coordinates, stellar surface coordinates, and quantities such as the specific <em>photon</em> intensity as a function of phase, energy, and sky direction (image plane coordinates). Note that the units of the specific flux signal are
photons/cm<span class="math notranslate nohighlight">\(^{2}\)</span>/s/keV because it has already been scaled by the square of the distance. The signals generated by the integrators above have not been scaled by the square of the distance (an implementation specific detail that is susceptible to change in the future).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="p">,</span> <span class="n">temp_int1</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_50_0.png" src="_images/multiple_imaging_50_0.png" />
</div>
</div>
<p>Let’s make a comparison of the integrators in one plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>

<span class="n">MAX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">MAX</span><span class="p">,</span>
         <span class="s1">&#39;k-&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="n">temp_int2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">MAX</span><span class="p">,</span>
         <span class="s1">&#39;k--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="n">temp_int3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">MAX</span><span class="p">,</span>
         <span class="s1">&#39;k:&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="o">/</span><span class="n">MAX</span><span class="p">,</span>
         <span class="s1">&#39;k-.&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Normalised photons/cm$^</span><span class="si">{2}</span><span class="s1">$/s/keV&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
<span class="n">veneer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temp_int2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;k--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temp_int3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;k:&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;k-.&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. </span><span class="si">% f</span><span class="s1">rac. diff.&#39;</span><span class="p">)</span>

<span class="n">veneer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_52_0.png" src="_images/multiple_imaging_52_0.png" />
</div>
</div>
<p>The differences can be reduced, within the scope of a given algorthm, by defining higher resolution integration settings. The integration algorithms are so distinct that this consistency validates the tools internally; verification against external packages would nevertheless permit stronger guarantees of robustness. The simple package <a class="reference external" href="https://github.com/ThomasEdwardRiley/rayXpanda">rayXpanda</a> offered a weak validation (i.e., for primary images only) of the Schwarzschild ray integration
routines called by the surface-discretisation signal integrators. In fact, let’s now link rayXpanda into X-PSI to make a final validating cross-check of the primary image computation: X-PSI calculating the lensing integral <span class="math notranslate nohighlight">\(\psi(\alpha;u)\)</span> and the convergence <span class="math notranslate nohighlight">\(\sim\partial\cos\alpha/\partial\cos\psi\)</span> via numerical quadrature and inversion by spline interpolation, and rayXpanda calculating a high-order integral expansion to simultaneously evaluate <span class="math notranslate nohighlight">\(\alpha(\psi;u)\)</span> and the
convergence. Here the deflection <span class="math notranslate nohighlight">\(\psi\)</span> depends on the ray angle to the radial direction (in a local Eulerian frame) and on the compactness coordinate <span class="math notranslate nohighlight">\(u=r_{\rm s}/R(\theta;M,\Omega,R_{\rm eq})\)</span>.</p>
</div>
<div class="section" id="Linking-in-rayXpanda">
<h2>Linking in rayXpanda<a class="headerlink" href="#Linking-in-rayXpanda" title="Permalink to this headline">¶</a></h2>
<p>If you do not have rayXpanda installed, the surface-discretisation integrators will simply revert to the default behaviour already shown above.</p>
<p>If rayXpanda is linked in, then it replaces the primary image lensing calculation up to some deflection limit. There are however two behaviours to be of that we demonstrate below. If the deflection limit is too low high but below <span class="math notranslate nohighlight">\(\pi\)</span> radians (by definition), then the expansion truncation error manifests. And non-intuitively, if the deflection limit is too low, then due to the design of the algorithm to support inclusion of higher-order images, the numerical solution will become
inaccurate for small deflections. If rayXpanda is not linked in, a different numerical scheme is substituted in that handles primary images that are deflected by <span class="math notranslate nohighlight">\(\psi&lt;\pi/2\)</span> radians; the rayXpanda expansion is highly consistent with this numerical (quadrature + interpolation) solution as shown below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">capture</span>

try:
    xpsi.cellmesh
except AttributeError:
    pass
else:
    # use the override switch to deactivate external library for now
    # this means that lensing integral solutions will be fully numerical
    xpsi.cellmesh.__deactivate_rayXpanda__ = False
    everywhere.time_invariant = True # calls to xpsi/cellmesh/integrator_for_time_invariance.pyx
    everywhere.image_order_limit = 0 # in case it changed anywhere, e.g., cells executed out of order
    limits = np.linspace(0.01, 0.99*math.pi, 100)
    def helper(lim):
        xpsi.set_rayXpanda_deflection_limit(lim)
        photosphere.integrate(energies=energies, threads=4)
        return np.max(100.0*np.abs(photosphere.signal[0][0][:,0]/temp_int1[:,0] - 1.0))

    errors = []
    for lim in limits:
        errors.append(helper(lim))
</pre></div>
</div>
</div>
<p>If we do not capture the output, the warning below will be printed a number of times:</p>
<p>Warning: invoking rayXpanda for a signal integration over a subdomain of the stellar image.</p>
<p>Warning: the larger the primary image subdomain chosen for rayXpanda calls,</p>
<p>Warning: the larger the rayXpanda expansion truncation error.</p>
<p>Warning: you can control this by setting the rayXpanda deflection limit manually.</p>
<p>Warning: please use the top-level function xpsi.set_rayXpanda_deflection_limit(float).</p>
<p>Warning: please refer to the documentation at <a class="reference external" href="https://thomasedwardriley.github.io/rayXpanda/theory">https://thomasedwardriley.github.io/rayXpanda/theory</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">xpsi</span><span class="o">.</span><span class="n">cellmesh</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">limits</span><span class="o">/</span><span class="n">xpsi</span><span class="o">.</span><span class="n">global_imports</span><span class="o">.</span><span class="n">_pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span><span class="o">/</span><span class="mf">100.0</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;rayXpanda primary image limit [$\pi$ radians]&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Max. abs. frac. diff.&#39;</span><span class="p">)</span>

    <span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_60_0.png" src="_images/multiple_imaging_60_0.png" />
</div>
</div>
<p>The default rayXpanda deflection limit, if the library is linked in, is also <span class="math notranslate nohighlight">\(\psi&lt;\pi/2\)</span> radians. If you are interested in a straightforward comparison of the high-order rayXpanda expansion and the default numerical primary image scheme for <span class="math notranslate nohighlight">\(\psi&lt;\pi/2\)</span>, please refer to the rayXpanda documentation for demonstrative plots.</p>
</div>
<div class="section" id="Decreasing-the-image-order-limit">
<h2>Decreasing the image order limit<a class="headerlink" href="#Decreasing-the-image-order-limit" title="Permalink to this headline">¶</a></h2>
<p>For integrators that directly discretise the stellar surface with a regular mesh we can straightforwardly control the limiting image order to try to sum up to. If the image order is conservative, the integrators automatically detect invisibility and truncate. Note that the sum is executed from low- to high-order, which generally means adding small numbers to much larger numbers, and thus in principle accuracy loss, but the number magnitude decays very rapidly with order so the contribution from
combining higher-order images first shouldn’t make an importance difference. If higher-order images are visible, they are simply missed because of enforced truncation. It follows that because the flux contribution from higher-order images (even at fixed phase and energy) decays with order, setting a limit of three images or even two images is going to be entirely sufficient in practice. On the other hand, not setting a limit won’t affect integration time in an important way for less compact
stars, but if prior support extends to very compact stars, the computation time increases by a factor of a few, until the resolution limit is reached.</p>
<p>Choosing a limit of two or three, and allowing the prior support to encompass configurations with polar radius greater than the Schwarzschild photon sphere radius should be sufficient. Then, if of interest, incrementing the order limit during post-processing to execute sensitivity analysis via importance sampling should allow one to demonstrate insensitivity to higher-order image inclusion; this is only relevant if the samples are from a posterior mode at high compactness where part of the
surface is doubly or multiply-imaged.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">time_invariant</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># calls to xpsi/cellmesh/integrator_for_time_invariance.pyx</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">helper</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="n">everywhere</span><span class="o">.</span><span class="n">image_order_limit</span> <span class="o">=</span> <span class="n">order</span>
    <span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xpsi</span><span class="o">.</span><span class="n">cellmesh</span><span class="o">.</span><span class="n">__deactivate_rayXpanda__</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">temp_int1_rayX_1</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># primary image only</span>
<span class="n">temp_int1_rayX_2</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># up to secondary images</span>
<span class="n">temp_int1_rayX_3</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># up to tertiary images</span>
<span class="n">temp_int1_rayX_4</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># and so on...</span>
<span class="n">temp_int1_rayX_5</span> <span class="o">=</span> <span class="n">helper</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># we will compare to the adaptive computation above</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
     <span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">temp_int1_rayX_1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span>
     <span class="s1">&#39;k-&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">temp_int1_rayX_2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;k-.&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">temp_int1_rayX_3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;k--&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">temp_int1_rayX_4</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;k:&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">temp_int1_rayX_5</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;r:&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span>
         <span class="mf">100.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="o">/</span><span class="n">temp_int1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">),</span>
         <span class="s1">&#39;b-.&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Abs. </span><span class="si">% f</span><span class="s1">rac. diff.&#39;</span><span class="p">)</span>

<span class="n">veneer</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_68_0.png" src="_images/multiple_imaging_68_0.png" />
</div>
</div>
<p>For this compact star only the secondary images are demonstrably important, with a massive increase in accuracy. We also show again the level of validation achieved via image-plane calculation in <em>blue</em>. To further demonstrate either the convergence of the image-plane and surface discretisation algorithms, and thus determine if the algorithms need to be improved to be accurate for image orders beyond two, we’d need to tune up the resolution settings. In particular we sacrificed primary image
resolution when squeezing the image-plane rays towards the stellar limb, given that we were also in pursuit of visualisation the higher-order image squeezing. Resolution settings that target flux accuracy will improve the consistency.</p>
</div>
<div class="section" id="Multiple-images">
<h2>Multiple images<a class="headerlink" href="#Multiple-images" title="Permalink to this headline">¶</a></h2>
<p>Let’s use the cached ray map to try to visualise the multiple imaging:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ref</span> <span class="o">=</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>
<span class="c1"># rays that scatter have negative constant values &lt;-100</span>
<span class="c1"># for map quantities such as the colatitude</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_72_0.png" src="_images/multiple_imaging_72_0.png" />
</div>
</div>
<p>The artefact near the origin along the equator is because we squeezed the image-plane polar ray set towards the image boundary, leaving fewer rays around the origin for accurate contour computation (via Delaunay triangulation).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_74_0.png" src="_images/multiple_imaging_74_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.95</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_75_0.png" src="_images/multiple_imaging_75_0.png" />
</div>
</div>
<p>Let’s zoom in again to see the insane squeezing of just the third image of the southern pole:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.025</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.9995</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">veneer</span><span class="p">((</span><span class="mf">0.0025</span><span class="p">,</span><span class="mf">0.01</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000025</span><span class="p">,</span><span class="mf">0.0001</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_77_0.png" src="_images/multiple_imaging_77_0.png" />
</div>
</div>
<p>We’d evidently need more rays and potentially more accurate ray tracing (in particular surface detection for near-grazing rays) to resolve even these third-order images if they contributed to the flux in an important way. Note that in theory the image of this almost exactly spherical star should extend to coordinates <span class="math notranslate nohighlight">\(y=\pm1\)</span> and <span class="math notranslate nohighlight">\(x=\pm1\)</span> almost exactly (for an oblate star and the definition of the coordinate units, the maximum extent of the star is <span class="math notranslate nohighlight">\(x=\pm1\)</span>, with the actual
extent being a function of both viewing angle and the surface oblateness and compactness). We continue discussion of performance below.</p>
<p>Let’s first plot the azimuth map to distinguish images:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">)):</span>

    <span class="k">if</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">elif</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

<span class="n">phi_lvls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">phi_lvls</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>
<span class="c1"># rays that scatter have negative constant values &lt;-100</span>
<span class="c1"># for map quantities such as the azimuth</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_80_0.png" src="_images/multiple_imaging_80_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">phi_lvls</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_81_0.png" src="_images/multiple_imaging_81_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">phi_lvls</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.95</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_82_0.png" src="_images/multiple_imaging_82_0.png" />
</div>
</div>
</div>
<div class="section" id="Millisecond-pulsar-spin-(phase-invariant)">
<h2>Millisecond pulsar spin (phase-invariant)<a class="headerlink" href="#Millisecond-pulsar-spin-(phase-invariant)" title="Permalink to this headline">¶</a></h2>
<p>Let’s spin the star up to include two additional effects: relativistic beaming of the surface emission and rotational deformation (oblateness). The former means that for an observer substantially inclined to the rotational axis, the flux at (gravitationally blueshifted) energies beyond a thermal knee in the photosphere specific intensity spectrum becomes dominated by images at the edge of the stellar image on our sky (i.e., at the stellar limb). An interesting effect to note is that relatvistic
beaming brightens odd-order images and dims even-order images, or vice versa dependending on whether the radiating neighbourhood of the surface is receeding or approaching based on the primary image. That means for instance, that if the primary is dimmed due to beaming, and the secondary is brightened, the tertiary image will be dimmed even more than the primary due to beaming which compounds the solid angle decay. This is one way in which a secondary image can in principle contribute at least
as much flux as a primary image at some rotational phases and viewing configurations, whilst the quaternary image contributes a similar flux to the tertiary image, and so on relating adjacent odd and even order images; the tertiary and higher-order images are would be unimportant though. On the other hand, if the primary image is brighened, the secondary is dimmed and the tertiary is brightened. In this case, a tertiary image can contribute more flux than a secondary image at select phases and
viewing configurations, but will itself generally be entirely dominated by the primary. The relationships between unimportant higher-order adjacent even and odd images is similar to the above description.</p>
<p><em>Note that another way to weight the flux integral towards the stellar limb is to have temperature inversion in the atmosphere, leading to bright near-tangential emission, but the effect is not as a strong as tuning up to millisecond spin periods and higher.</em></p>
<p>Only at energies well beyond a thermal knee in the surface emission will the relativistic beaming mean that the flux is dominated by the brightness at the stellar limb (when there is somewhat uniform, global surface emission as assumed here), where the high-order images will be squeezed. The brightness of near-tangential emission after beaming partially counteracts the solid angle decay with image order, in such a case, but will not realistically ever mean high-order images contribute more flux
at some energy. However, X-ray telescopes will generally be sensitive to softer emission where there are <em>far</em> more counts, meaning relative insensitivity of a well-performing likelihood function jointly over the instrument waveband to flux integration error in the vicinity of the stellar limb.</p>
<p>Realistically, if a surface does not radiate somewhat unformly in the instrument waveband, leading to pulsed emission, effectively the same reasoning applies to the importance of accurately calculating the flux at phases where the flux is dominated by the signal from the stellar limb where the limb is constituted by only primary images, simply because of geometric projected effects. This is without or without additional strong relativistic beaming effects leading to flux (at energies beyond a
thermal knee in the surface emission spectrum) being dominated by the contribution from the relevant radiating regions when they reach the stellar limb on the approaching side of the star.</p>
<p>Oblateness has the effect of increasing the maximum deflection that can be attained by a point on the surface, relative to an unperturbed spherical <em>background</em> solution. Some points, such as the locus in the vicinity of the equator only lower in maximum deflection. In the vicinities of the poles, points gain in maximum deflection. In these cases the surface normal remains effectively radial. For intermediate points between a pole and the equator, the maximum deflection generally increases due
to tilt even if the compactness coordinate decreases, but also due to tilt, some images (either even or odd beyond some order) are also lost. This is because the maximum deflection depends on the ray direction aside from the angle subtended to the radial direction.</p>
<p>Note that for very compact stars with polar radius near the Schwarzschild photon sphere, higher order images need to graze closer and closer to the photon sphere to complete revolutions before scattering. If the surface is slightly oblate, then an opaque surface quickly truncates higher order images. Alas, for an oblate surface in this case to be valid in the ambient Schwarzschild spacetime, it would have to be effectively massless; it requires substantial rotation speed for such soft equations
of state that lead to high compactness, which thus nullifies the Schwarzschild ambient spacetime and photon sphere. The issue of rotational deformation leading to a (highly compact) photosphere which lies within it’s own null future due to high (outgoing) ray curvature is somewhat of open problem to our knowledge but it is thought that the source matter curvature will always be too high to intercept outgoing rays that would otherwise scatter in the ambient spacetime in the absence of the opaque
surface (private communication with the NICER collaboration light-curve SWG, Joonas Nättilä, and Juri Poutanen, July 2016, Seattle). Beyond this reasoning, it is not considered even mildly important for realistic experiements because the flux contribution from higher order images is so small and entirely dominated by other modelling inaccuracies.</p>
<p>Note that in principle, for a maximally compact toy equation of state (see, e.g., <a class="reference external" href="https://doi.org/10.1063/1.4909560">Lattimer 2015</a> and references therein), non-rotating scale-free solutions exist within the Schwarzschild photon sphere, but rather close to it, at <span class="math notranslate nohighlight">\(R\approx1.41r_{\rm s}\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">205.0</span> <span class="c1"># ~J0030+0451 spin</span>
</pre></div>
</div>
</div>
<p>We’ll reset the mass so that the oblate surface lies entirely, and barely just outside ambient Schwarzschild photon sphere:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.695</span> <span class="c1"># choose mass so that surface lies entirely, and barely just outside Schwarzschild photon sphere</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span><span class="o">.</span><span class="n">R_r_s</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1.5077253212974875
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">time_invariant</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rtemp_int1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">(</span><span class="n">rtemp_int1</span><span class="p">,</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_96_0.png" src="_images/multiple_imaging_96_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">time_invariant</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># switches to xpsi/cellmesh/integrator.pyx</span>
<span class="c1"># a few cells from this one onwards were executed again, and thus their execution numbers</span>
<span class="c1"># are out of order, because this switch was forgotten at first</span>
<span class="n">everywhere</span><span class="o">.</span><span class="n">_integrator_toggle</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rtemp_int2</span> <span class="o">=</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">rtemp_int2</span><span class="p">,</span> <span class="n">rtemp_int1</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_100_0.png" src="_images/multiple_imaging_100_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">everywhere</span><span class="o">.</span><span class="n">_integrator_toggle</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># switch to final integrator that discretises surface, xpsi/cellmesh/integrator_for_azimuthal_invariance.pyx, for testing</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rtemp_int3</span> <span class="o">=</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">rtemp_int3</span><span class="p">,</span> <span class="n">rtemp_int1</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.01</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_104_0.png" src="_images/multiple_imaging_104_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">rtemp_int3</span><span class="p">,</span> <span class="n">rtemp_int2</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_105_0.png" src="_images/multiple_imaging_105_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># spacetime spin parameter (~angular momentum)</span>
<span class="n">spacetime</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># spacetime mass quadrupole moment</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">reimage</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">reuse_ray_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                  <span class="n">phases</span> <span class="o">=</span> <span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                  <span class="n">sqrt_num_rays</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
                  <span class="c1"># squeeze rays towards limb where higher-order images are</span>
                  <span class="n">image_plane_radial_increment_power</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span>
                  <span class="n">threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>          <span class="c1"># OpenMP</span>
                  <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>   <span class="c1"># max number of steps per ray</span>
                  <span class="n">epsrel_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="c1"># ray relative tolerance</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imaging the star...
Commencing ray tracing and imaging...
Ray tracing complete.
Ray set cached.
Phase-resolved specific flux integration complete.
Star imaged.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="p">,</span> <span class="n">rtemp_int1</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">,</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_108_0.png" src="_images/multiple_imaging_108_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">ref</span> <span class="o">=</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>
<span class="c1"># rays that scatter have negative constant values &lt;-100</span>
<span class="c1"># for map quantities such as the colatitude</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_109_0.png" src="_images/multiple_imaging_109_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_110_0.png" src="_images/multiple_imaging_110_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.95</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_111_0.png" src="_images/multiple_imaging_111_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ref</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ref</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                                   <span class="mi">200</span><span class="p">),</span>
               <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.025</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.9995</span><span class="p">])</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">veneer</span><span class="p">((</span><span class="mf">0.0025</span><span class="p">,</span><span class="mf">0.01</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.000025</span><span class="p">,</span><span class="mf">0.0001</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_112_0.png" src="_images/multiple_imaging_112_0.png" />
</div>
</div>
<p>Notice that due to finite oblateness the resolved limb is slightly further from <span class="math notranslate nohighlight">\(y=-1\)</span> that is the case for the effectively spherical star above. For the <span class="math notranslate nohighlight">\(x\)</span> coordinate, the proximity to <span class="math notranslate nohighlight">\(x±1\)</span> depends on the viewing angle and surface oblateness and compactness (besides the ray resolution).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="o">...</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">)):</span>

    <span class="k">if</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">elif</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>

<span class="n">phi_lvls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]),</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">phi_lvls</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>
<span class="c1"># rays that scatter have negative constant values &lt;-100</span>
<span class="c1"># for map quantities such as the azimuth</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.025</span><span class="p">,</span><span class="mf">1.025</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_114_0.png" src="_images/multiple_imaging_114_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">phi_lvls</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_115_0.png" src="_images/multiple_imaging_115_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">levels</span><span class="o">=</span><span class="n">phi_lvls</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">magma_r</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.95</span><span class="p">])</span>
<span class="n">veneer</span><span class="p">((</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.1</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.005</span><span class="p">,</span><span class="mf">0.025</span><span class="p">),</span> <span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_116_0.png" src="_images/multiple_imaging_116_0.png" />
</div>
</div>
</div>
<div class="section" id="Custom-(phase-dependent)">
<h2>Custom (phase-dependent)<a class="headerlink" href="#Custom-(phase-dependent)" title="Permalink to this headline">¶</a></h2>
<p>Let’s now play with localised hot regions so that secondary images in particular can be visualised directly in intensity sky maps.</p>
<p>You now need to reinstalled the package after replacing the contents of <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/local_variables.pyx</span></code> with the exact contents of <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/archive/two_spots.pyx</span></code>. The <code class="docutils literal notranslate"><span class="pre">local_variables.pyx</span></code> extension module must transform some set of <em>global</em> variables into <em>local</em> variables at the spacetime event defined by the intersection of a ray with the stellar surface. A vector of local variables is then passed to the <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/hot.pyx</span></code>
module for evaluation of the specific intensity of radiation, w.r.t a local comoving surface frame, that after Lorentz transformation is transported along the ray to the image plane.</p>
<p><strong>Once you can reinstalled the package, you need to restart the IPython kernel and then execute code cells [1] and [14] above.</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">600.0</span><span class="p">),</span>
              <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>                     <span class="c1"># (Earth) distance</span>
              <span class="n">mass</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">),</span>                         <span class="c1"># mass</span>
              <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">gravradius</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">16.0</span><span class="p">),</span>    <span class="c1"># equatorial radius</span>
              <span class="n">cos_inclination</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>              <span class="c1"># (Earth) inclination to rotation axis</span>

<span class="n">spacetime</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Spacetime</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="mf">205.0</span><span class="p">))</span> <span class="c1"># ~J0030 spin</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;frequency&#34; with bounds [1.000e-01, 6.000e+02] and initial value 2.050e+02.
    &gt; Spin frequency [Hz].


Creating parameter:
    &gt; Named &#34;mass&#34; with bounds [1.000e+00, 3.000e+00].
    &gt; Gravitational mass [solar masses].


Creating parameter:
    &gt; Named &#34;radius&#34; with bounds [4.430e+00, 1.600e+01].
    &gt; Coordinate equatorial radius [km].


Creating parameter:
    &gt; Named &#34;distance&#34; with bounds [1.000e-01, 1.000e+00].
    &gt; Earth distance [kpc].


Creating parameter:
    &gt; Named &#34;cos_inclination&#34; with bounds [0.000e+00, 1.000e+00].
    &gt; Cosine of Earth inclination to rotation axis.


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">super_colatitude</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">),</span>
              <span class="n">super_radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">),</span>
              <span class="n">phase_shift</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
              <span class="n">super_temperature</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">6.8</span><span class="p">))</span>

<span class="n">primary</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">values</span><span class="o">=</span><span class="p">{},</span>
                            <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">omit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">cede</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                            <span class="n">min_sqrt_num_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">max_sqrt_num_cells</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                            <span class="n">num_leaves</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                            <span class="n">num_phases</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                            <span class="n">num_rays</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                            <span class="n">is_secondary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">super_colatitude</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">),</span>
              <span class="n">super_radius</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">),</span>
              <span class="n">phase_shift</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">),</span>
              <span class="n">super_temperature</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.1</span><span class="p">,</span> <span class="mf">6.8</span><span class="p">))</span>

<span class="n">secondary</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">HotRegion</span><span class="p">(</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">values</span><span class="o">=</span><span class="p">{},</span>
                            <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">omit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">cede</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">concentric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">sqrt_num_cells</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                            <span class="n">min_sqrt_num_cells</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">max_sqrt_num_cells</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                            <span class="n">num_leaves</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                            <span class="n">num_phases</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                            <span class="n">num_rays</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                            <span class="n">is_antiphased</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">xpsi</span> <span class="kn">import</span> <span class="n">HotRegions</span>

<span class="n">hot</span> <span class="o">=</span> <span class="n">HotRegions</span><span class="p">((</span><span class="n">primary</span><span class="p">,</span> <span class="n">secondary</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;super_colatitude&#34; with bounds [1.000e-03, 3.141e+00].
    &gt; The colatitude of the centre of the superseding region [radians].


Creating parameter:
    &gt; Named &#34;super_radius&#34; with bounds [1.000e-03, 1.570e+00].
    &gt; The angular radius of the (circular) superseding region [radians].


Creating parameter:
    &gt; Named &#34;phase_shift&#34; with bounds [-2.500e-01, 7.500e-01].
    &gt; The phase of the hot region, a periodic parameter [cycles].


Creating parameter:
    &gt; Named &#34;super_temperature&#34; with bounds [5.100e+00, 6.800e+00].
    &gt; log10(superseding region effective temperature [K]).


Creating parameter:
    &gt; Named &#34;super_colatitude&#34; with bounds [1.000e-03, 3.141e+00].
    &gt; The colatitude of the centre of the superseding region [radians].


Creating parameter:
    &gt; Named &#34;super_radius&#34; with bounds [1.000e-03, 1.570e+00].
    &gt; The angular radius of the (circular) superseding region [radians].


Creating parameter:
    &gt; Named &#34;phase_shift&#34; with bounds [-2.500e-01, 7.500e-01].
    &gt; The phase of the hot region, a periodic parameter [cycles].


Creating parameter:
    &gt; Named &#34;super_temperature&#34; with bounds [5.100e+00, 6.800e+00].
    &gt; log10(superseding region effective temperature [K]).


</pre></div></div>
</div>
<p>We want to image the photosphere and the default behaviour of <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a> is insufficient. We therefore subclass <a class="reference internal" href="photosphere.html#xpsi.Photosphere.Photosphere"><span class="std std-ref">Photosphere</span></a> to provide a custom implementation of a higher-complexity radiation field. The customisation is actually very simple: we must make a property return a vector of global variable values that are relayed to a compiled extension module
<code class="docutils literal notranslate"><span class="pre">xpsi.surface_radiation_field.local_variables</span></code> by the image-plane discretisation integrator. Thus, the bulk of the customisation must be written in <code class="docutils literal notranslate"><span class="pre">xpsi/surface_radiation_field/local_variables.pyx</span></code> for compilation; this has already been handled for this tutorial (see instructions above).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">CustomPhotosphere</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Photosphere</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Implement custom global variables property. &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method is needed if we also want to invoke the image-plane signal simulator.</span>

<span class="sd">        The extension module compiled is surface_radiation_field/archive/local_variables/two_spots.pyx,</span>
<span class="sd">        which replaces the contents of surface_radiation_field/local_variables.pyx.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;p__super_temperature&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">],</span>
                          <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;s__super_temperature&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">derive</span><span class="p">(</span><span class="n">xpsi</span><span class="o">.</span><span class="n">Derive</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boundto</span><span class="p">,</span> <span class="n">caller</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">spacetime</span>
        <span class="k">return</span> <span class="n">spacetime</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span> <span class="o">=</span> <span class="n">CustomPhotosphere</span><span class="p">(</span><span class="n">hot</span> <span class="o">=</span> <span class="n">hot</span><span class="p">,</span>
                                <span class="n">elsewhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">everywhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode_frequency</span> <span class="o">=</span> <span class="n">derive</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Creating parameter:
    &gt; Named &#34;mode_frequency&#34; that is derived from ulterior variables.
    &gt; Coordinate frequency of the mode of radiative asymmetry in the
photosphere that is assumed to generate the pulsed signal [Hz].


</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span> <span class="o">=</span> <span class="n">xpsi</span><span class="o">.</span><span class="n">Star</span><span class="p">(</span><span class="n">spacetime</span> <span class="o">=</span> <span class="n">spacetime</span><span class="p">,</span> <span class="n">photospheres</span> <span class="o">=</span> <span class="n">photosphere</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># (Earth) distance</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.33</span>
<span class="c1"># gravitational mass</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.695</span>
<span class="c1"># coordinate equatorial radius</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="c1"># (Earth) inclination to rotation axis</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;cos_inclination&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="n">star</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="c1"># isotropic blackbody temperature</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;p__super_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.3</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;p__super_colatitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;p__super_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="n">star</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="c1"># isotropic blackbody temperature</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;s__super_temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.3</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;s__super_colatitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">star</span><span class="p">[</span><span class="s1">&#39;s__super_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.2</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">star</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">joint</span> <span class="o">=</span> <span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                          <span class="n">x</span><span class="o">=</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">shift</span><span class="o">=</span><span class="p">(</span> <span class="n">hot</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">],</span> <span class="n">hot</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="p">),</span>
                          <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                          <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
                          <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_131_0.png" src="_images/multiple_imaging_131_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">primary</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">secondary</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">energies</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">_joint</span> <span class="o">=</span> <span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">photosphere</span><span class="o">.</span><span class="n">signal</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                      <span class="n">x</span><span class="o">=</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">shift</span><span class="o">=</span><span class="p">(</span> <span class="n">hot</span><span class="p">[</span><span class="s1">&#39;p__phase_shift&#39;</span><span class="p">],</span> <span class="n">hot</span><span class="p">[</span><span class="s1">&#39;s__phase_shift&#39;</span><span class="p">]</span> <span class="p">),</span>
                      <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                      <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
                      <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_134_0.png" src="_images/multiple_imaging_134_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">joint</span><span class="p">,</span> <span class="n">_joint</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.000001</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span> <span class="mf">0.000001</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_135_0.png" src="_images/multiple_imaging_135_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spacetime</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># spacetime spin parameter (~angular momentum)</span>
<span class="n">spacetime</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># spacetime mass quadrupole moment</span>
</pre></div>
</div>
</div>
<p>Now we call the image-plane integrator. The image-plane ray mesh is distributed globally over the stellar image, and we therefore for cross-validation, we need a mesh constituted by a larger number of elements than the moving meshes that discretise just the surface hot regions and near vicinities.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">reimage</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">reuse_ray_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                  <span class="n">phases</span> <span class="o">=</span> <span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                  <span class="n">sqrt_num_rays</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">,</span> <span class="c1"># ~16 million rays to try to converge</span>
                  <span class="n">threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>          <span class="c1"># OpenMP</span>
                  <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>   <span class="c1"># max number of steps per ray</span>
                  <span class="n">epsrel_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="c1"># ray relative tolerance</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imaging the star...
Commencing ray tracing and imaging...
Ray tracing complete.
Ray set cached.
Phase-resolved specific flux integration complete.
Star imaged.
</pre></div></div>
</div>
<p>Let’s examine the phase-energy resolved photon specific flux signal and compare it to the signal computed by via surface discretisation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">(</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="p">,</span>
                  <span class="n">x</span><span class="o">=</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">shift</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                  <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
                  <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_140_0.png" src="_images/multiple_imaging_140_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plot_2D_pulse</span><span class="p">((</span><span class="n">photosphere</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">spacetime</span><span class="o">.</span><span class="n">d_sq</span><span class="p">,</span> <span class="n">joint</span><span class="p">),</span>
              <span class="n">x</span><span class="o">=</span><span class="n">hot</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
              <span class="n">shift</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">),</span>
              <span class="n">y</span><span class="o">=</span><span class="n">energies</span><span class="p">,</span>
              <span class="n">ylabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Energy (keV)&#39;</span><span class="p">,</span>
              <span class="n">cm</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Pct. frac. diff.&quot;</span><span class="p">,</span>
              <span class="n">num_rotations</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
              <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span>
              <span class="n">vmax</span><span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_141_0.png" src="_images/multiple_imaging_141_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sky_map_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;panel_indices&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
                  <span class="s1">&#39;num_levels&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="c1"># in intensity field rendering</span>
                  <span class="s1">&#39;colormap&#39;</span><span class="p">:</span> <span class="n">cm</span><span class="o">.</span><span class="n">Purples_r</span><span class="p">,</span>
                  <span class="s1">&#39;phase_average&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="s1">&#39;annotate_energies&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># background from the surface and behind the star</span>
                  <span class="s1">&#39;energy_annotation_format&#39;</span><span class="p">:</span> <span class="s1">&#39;[</span><span class="si">%.2f</span><span class="s1"> keV]&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;annotate_location&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.025</span><span class="p">)}</span>

<span class="c1"># you can install ffmpeg with conda in order to animate</span>
<span class="n">animate_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cycles&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;fps&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">photosphere</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">reimage</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">reuse_ray_map</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                  <span class="n">cache_intensities</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="c1"># cache size limit in GBs</span>
                  <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">]),</span>
                  <span class="n">phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                  <span class="n">sqrt_num_rays</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="c1"># do not need as many to see the important imagess</span>
                  <span class="n">threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                  <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
                  <span class="n">epsrel_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">,</span>
                  <span class="n">plot_sky_maps</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># activate if you want to plot frames</span>
                  <span class="n">sky_map_kwargs</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="p">,</span>
                  <span class="n">animate_sky_maps</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># activate if you want to animate</span>
                  <span class="n">free_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># activate if memory is a concern, to delete ray-map/intensity caches</span>
                  <span class="n">animate_kwargs</span> <span class="o">=</span> <span class="n">animate_kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imaging the star...
Commencing ray tracing and imaging...
Ray tracing complete.
Ray set cached.
Intensity caching complete.
Plotting intensity sky maps...
Normalising each sky map panel separately...
Normalised sky map panels separately.
Rendering images for phase numbers [1, 10]...
Rendering images for phase numbers (10, 20]...
Rendering images for phase numbers (20, 30]...
Rendering images for phase numbers (30, 40]...
Rendering images for phase numbers (40, 50]...
Rendering images for phase numbers (50, 60]...
Rendering images for phase numbers (60, 70]...
Rendering images for phase numbers (70, 80]...
Rendering images for phase numbers (80, 90]...
Rendering images for phase numbers (90, 100]...
Intensity sky maps plotted.
Animating intensity sky maps...
Writing to disk: ./images/skymap_animated.mp4...
Intensity sky maps animated.
Star imaged.
</pre></div></div>
</div>
<p>If you are executing this notebook, you can view the video file:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">HTML</span>
&lt;div align=&quot;middle&quot;&gt;
&lt;video width=&quot;100%&quot; controls loop&gt;
    &lt;source src=&quot;images/skymap_animated.mp4&quot; type=&quot;video/mp4&quot;&gt;
&lt;/video&gt;&lt;/div&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div align="middle">
<video width="100%" controls loop>
    <source src="images/skymap_animated.mp4" type="video/mp4">
</video></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>mkdir images/frames_multiple_imaging
<span class="o">!</span>mv images/*.png images/frames_multiple_imaging/.
</pre></div>
</div>
</div>
<p>Here is a frame for the purpose of the documentation notebook. Each panel displays the photon specific intensity field, on the sky, at a given energy; energy increases from top-left to bottom-right. The intensity field in each panel is normalised over sky direction and phase, for each energy in the sequence.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;./images/frames_multiple_imaging/skymap_50.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_148_0.png" src="_images/multiple_imaging_148_0.png" />
</div>
</div>
<p>Finally, let’s phase-average the intensity sky maps:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sky_map_kwargs</span><span class="p">[</span><span class="s1">&#39;phase_average&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># only one set of panels so why not choose higher res.?</span>
<span class="n">sky_map_kwargs</span><span class="p">[</span><span class="s1">&#39;num_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">photosphere</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">reimage</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># because we decided not to free_memory earlier</span>
                  <span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">]),</span>
                  <span class="n">phases</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">96</span><span class="p">)</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">,</span>
                  <span class="n">plot_sky_maps</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">sky_map_kwargs</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Imaging the star...
Plotting intensity sky maps...
Averaging (specific) intensity over rotational phase...
Averaged (specific) intensity over rotational phase.
Normalising each sky map panel separately...
Normalised sky map panels separately.
Rendering phase-averaged images...
Intensity sky maps plotted.
Star imaged.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>mv images/skymap_0.png images/frames_multiple_imaging/skymap_multiple_imaging_phase_averaged.png
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython2 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Image</span><span class="p">(</span><span class="s2">&quot;images/frames_multiple_imaging/skymap_multiple_imaging_phase_averaged.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="_images/multiple_imaging_152_0.png" src="_images/multiple_imaging_152_0.png" />
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="model_construction_streamlined.html" class="btn btn-neutral float-left" title="Modeling (without statistics)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="postprocessing_tutorial.html" class="btn btn-neutral float-right" title="Post-processing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, 2020, 2021 Thomas E. Riley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>