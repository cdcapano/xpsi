<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xpsi.Photosphere &mdash; xpsi 0.7.10 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> xpsi
          </a>
              <div class="version">
                0.7
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../todo.html">Future</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements.html">Acknowledgements</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model_construction.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multiple_instruments.html">Instrument synergy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../surface_radiation_field_checking_tools_tutorial.html">Surface radiation field tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model_construction_streamlined.html">Modeling (without statistics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../multiple_imaging.html">Multiple imaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../postprocessing_tutorial.html">Post-processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example_job.html">Example job</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../signal.html">Signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Extension modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../extensions_overview.html">Overview of extension modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../surface_radiation_field.html">Surface radiation field</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../likelihood_implementations.html">Likelihoods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../postprocessing.html">PostProcessing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xpsi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>xpsi.Photosphere</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for xpsi.Photosphere</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">.global_imports</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">global_imports</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_warning</span><span class="p">,</span> <span class="n">make_verbose</span><span class="p">,</span> <span class="n">verbose</span>

<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">_join</span>

<span class="kn">from</span> <span class="nn">.Spacetime</span> <span class="kn">import</span> <span class="n">Spacetime</span>
<span class="kn">from</span> <span class="nn">.HotRegion</span> <span class="kn">import</span> <span class="n">HotRegion</span>
<span class="kn">from</span> <span class="nn">.Elsewhere</span> <span class="kn">import</span> <span class="n">Elsewhere</span>
<span class="kn">from</span> <span class="nn">.Everywhere</span> <span class="kn">import</span> <span class="n">Everywhere</span>

<span class="kn">from</span> <span class="nn">.Parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">.ParameterSubspace</span> <span class="kn">import</span> <span class="n">ParameterSubspace</span>

<span class="kn">from</span> <span class="nn">.pixelmesh.integrator</span> <span class="kn">import</span> <span class="n">integrate</span> <span class="k">as</span> <span class="n">_integrate</span>
<span class="kn">from</span> <span class="nn">.tools.energy_integrator</span> <span class="kn">import</span> <span class="n">energy_integrator</span>
<span class="kn">from</span> <span class="nn">.tools.phase_integrator</span> <span class="kn">import</span> <span class="n">phase_integrator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">_mpl</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">AutoLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
    <span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mgimg</span>

<div class="viewcode-block" id="Photosphere"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere">[docs]</a><span class="k">class</span> <span class="nc">Photosphere</span><span class="p">(</span><span class="n">ParameterSubspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A photosphere embedded in an ambient Schwarzschild spacetime.</span>

<span class="sd">    :param obj hot:</span>
<span class="sd">        An instance of :class:`~.HotRegion.HotRegion` (or a derived class).</span>
<span class="sd">        This objects represents the hot regions of the surface that in most</span>
<span class="sd">        use-cases will be assumed to contain radiating material that is hotter</span>
<span class="sd">        than that *elsewhere*.</span>

<span class="sd">    :param obj elsewhere:</span>
<span class="sd">        An instance of :class:`~.Elsewhere.Elsewhere` (or a derived class).</span>

<span class="sd">    :param obj everywhere:</span>
<span class="sd">        An instance of :class:`~.Everywhere.Everywhere` (or a derived class).</span>
<span class="sd">        Note that if you use construct the surface radiation field in this</span>
<span class="sd">        way, you should use the :attr:`~.Photosphere.Photosphere.hot_atmosphere`</span>
<span class="sd">        property to pass a buffer of numerical data to the integrator</span>
<span class="sd">        routines. You then need to ensure that the extension modules</span>
<span class="sd">        ``xpsi/surface_radiation_field/hot_radiation_field.pyx`` and</span>
<span class="sd">        ``xpsi/surface_radiation_field/elsewhere_radiation_field.pyx`` match.</span>

<span class="sd">    .. note::</span>

<span class="sd">        You cannot specify the surface radiation field *everywhere* if you</span>
<span class="sd">        use hot regions (the latter usage may also include specification of</span>
<span class="sd">        the radiation field *elsewhere*).</span>

<span class="sd">    :param dict bounds:</span>
<span class="sd">        Bounds are supplied for instantiation of a frequency parameter.</span>
<span class="sd">        The parameter name ``&#39;mode_frequency&#39;`` must be a key in the</span>
<span class="sd">        dictionary unless the parameter is *fixed* or *derived*. If a bound</span>
<span class="sd">        is ``None`` that bound is set equal to a strict hard-coded bound.</span>
<span class="sd">        If ``None``, lock the coordinate rotation frequency of a mode of</span>
<span class="sd">        asymmetry in the photosphere to a fixed frequency, e.g., the stellar</span>
<span class="sd">        rotation frequency. If bounds are passed, the frequency is interpreted</span>
<span class="sd">        as a free parameter.</span>

<span class="sd">    :param dict values:</span>
<span class="sd">        Either the fixed value of the mode frequency, a callable if the</span>
<span class="sd">        frequency is *derived*, or a value upon initialisation if the</span>
<span class="sd">        frequency is free. The dictionary must have a key with name</span>
<span class="sd">        ``&#39;mode_frequency&#39;`` if it is *fixed* or *derived*.</span>
<span class="sd">        If the asymmetry is locked to the stellar spin, then you need to pass</span>
<span class="sd">        the spin frequency. If fixed but different to the spin frequency, this</span>
<span class="sd">        value needs to be passed instead. In the hot region base class this</span>
<span class="sd">        mode frequency is applied to normalise the ray lags instead of the</span>
<span class="sd">        stellar rotation frequency.</span>

<span class="sd">    :param iterable custom:</span>
<span class="sd">        A :class:`~.Parameter.Parameter` instance or iterable over such</span>
<span class="sd">        instances. Might be useful for calling image plane extensions and</span>
<span class="sd">        passing global variables, without having to instantiate</span>
<span class="sd">        surface-discretisation classes and without having to handle global</span>
<span class="sd">        variable values at compile time or from disk for runtime access.</span>

<span class="sd">    .. note::</span>

<span class="sd">        In basic modelling patterns the frequency is the spin frequency,</span>
<span class="sd">        and thus you only need to explicitly pass the spin as ``value`` whilst</span>
<span class="sd">        leaving ``bounds`` to default. If the spin frequency happens to be a</span>
<span class="sd">        free parameter (perhaps with informative prior information), then</span>
<span class="sd">        pass a callable instead that can be used to get the spin frequency</span>
<span class="sd">        dynamically when the derived mode frequency variable is called for.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">hot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">elsewhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">everywhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">custom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">everywhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hot</span> <span class="ow">or</span> <span class="n">elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use hot region nor elsewhere &#39;</span>
                                 <span class="s1">&#39;functionality if constructing the &#39;</span>
                                 <span class="s1">&#39;radiation field everywhere.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">everywhere</span><span class="p">,</span> <span class="n">Everywhere</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for everywhere object.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">elsewhere</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># can call image-plane extensions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elsewhere</span><span class="p">,</span> <span class="n">Elsewhere</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for an elsewhere object.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">hot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Hot region object(s) must be used in &#39;</span>
                                     <span class="s1">&#39;conjuction with an elsewhere object.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span> <span class="o">=</span> <span class="p">()</span>
                                              <span class="c1"># including derived classes</span>
            <span class="k">if</span> <span class="n">hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hot</span><span class="p">,</span> <span class="n">HotRegion</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hot</span><span class="p">,</span> <span class="s1">&#39;objects&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hot</span><span class="p">,</span> <span class="s1">&#39;objects&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HotRegion</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid object for the hot &#39;</span>
                                            <span class="s1">&#39;region(s).&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid object for the hot region(s).&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="o">=</span> <span class="n">hot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="o">=</span> <span class="n">elsewhere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="o">=</span> <span class="n">everywhere</span>

        <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">bounds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Coordinate frequency of the mode of radiative asymmetry in the</span>
<span class="s2">        photosphere that is assumed to generate the pulsed signal [Hz].</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">mode_frequency</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">,</span>
                                   <span class="n">strict_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2000.0</span><span class="p">),</span>
                                   <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                   <span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="p">,</span>
                                   <span class="n">symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$f_{\rm mode}$&#39;</span><span class="p">,</span>
                                   <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Photosphere</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mode_frequency</span><span class="p">,</span>
                                          <span class="n">hot</span><span class="p">,</span> <span class="n">elsewhere</span><span class="p">,</span> <span class="n">everywhere</span><span class="p">,</span>
                                          <span class="n">custom</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hot_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the numerical atmosphere buffers for hot regions if used.</span>

<span class="sd">        To preload a numerical atmosphere into a buffer, subclass and</span>
<span class="sd">        overwrite the setter. The underscore attribute set by the setter</span>
<span class="sd">        must be an :math:`n`-tuple whose :math:`n^{th}` element is an</span>
<span class="sd">        :math:`(n-1)`-dimensional array flattened into a one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray`. The first :math:`n-1`</span>
<span class="sd">        elements of the :math:`n`-tuple must each be an ordered one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray` of parameter values for the purpose of</span>
<span class="sd">        multi-dimensional interpolation in the :math:`n^{th}` buffer. The</span>
<span class="sd">        first :math:`n-1` elements must be ordered to match the index</span>
<span class="sd">        arithmetic applied to the :math:`n^{th}` buffer. An example would be</span>
<span class="sd">        ``self._hot_atmosphere = (logT, logg, mu, logE, buf)``, where:</span>
<span class="sd">        ``logT`` is a logarithm of local comoving effective temperature;</span>
<span class="sd">        ``logg`` is a logarithm of effective surface gravity;</span>
<span class="sd">        ``mu`` is the cosine of the angle from the local surface normal;</span>
<span class="sd">        ``logE`` is a logarithm of the photon energy; and</span>
<span class="sd">        ``buf`` is a one-dimensional buffer of intensities of size given by</span>
<span class="sd">        the product of sizes of the first :math:`n-1` tuple elements.</span>

<span class="sd">        It is highly recommended that buffer preloading is used, instead</span>
<span class="sd">        of loading from disk in the customisable radiation field extension</span>
<span class="sd">        module, to avoid reading from disk for every signal</span>
<span class="sd">        (likelihood) evaluation. This can be a non-negligible waste of compute</span>
<span class="sd">        resources. By preloading in Python, the memory is allocated and</span>
<span class="sd">        references to that memory are not in general deleted until a sampling</span>
<span class="sd">        script exits and the kernel stops. The likelihood callback accesses</span>
<span class="sd">        the same memory upon each call without I/O.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span>

    <span class="nd">@hot_atmosphere</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">hot_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement if required. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement setter if required.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elsewhere_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the numerical atmosphere buffers for elsewhere if used.</span>

<span class="sd">        To preload a numerical atmosphere into a buffer, subclass and</span>
<span class="sd">        overwrite the setter. The underscore attribute set by the setter</span>
<span class="sd">        must be an :math:`n`-tuple whose :math:`n^{th}` element is an</span>
<span class="sd">        :math:`(n-1)`-dimensional array flattened into a one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray`. The first :math:`n-1`</span>
<span class="sd">        elements of the :math:`n`-tuple must each be an ordered one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray` of parameter values for the purpose of</span>
<span class="sd">        multi-dimensional interpolation in the :math:`n^{th}` buffer. The</span>
<span class="sd">        first :math:`n-1` elements must be ordered to match the index</span>
<span class="sd">        arithmetic applied to the :math:`n^{th}` buffer. An example would be</span>
<span class="sd">        ``self._hot_atmosphere = (logT, logg, mu, logE, buf)``, where:</span>
<span class="sd">        ``logT`` is a logarithm of local comoving effective temperature;</span>
<span class="sd">        ``logg`` is a logarithm of effective surface gravity;</span>
<span class="sd">        ``mu`` is the cosine of the angle from the local surface normal;</span>
<span class="sd">        ``logE`` is a logarithm of the photon energy; and</span>
<span class="sd">        ``buf`` is a one-dimensional buffer of intensities of size given by</span>
<span class="sd">        the product of sizes of the first :math:`n-1` tuple elements.</span>

<span class="sd">        It is highly recommended that buffer preloading is used, instead</span>
<span class="sd">        of loading from disk in the customisable radiation field extension</span>
<span class="sd">        module, to avoid reading from disk for every signal</span>
<span class="sd">        (likelihood) evaluation. This can be a non-negligible waste of compute</span>
<span class="sd">        resources. By preloading in Python, the memory is allocated and</span>
<span class="sd">        references to that memory are not in general deleted until a sampling</span>
<span class="sd">        script exits and the kernel stops. The likelihood callback accesses</span>
<span class="sd">        the same memory upon each call without I/O.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span>

    <span class="nd">@elsewhere_atmosphere</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">elsewhere_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement if required. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement setter if required.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the instance of :class:`~.HotRegion.HotRegion`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elsewhere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the instance of :class:`~.Elsewhere.Elsewhere`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">everywhere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the instance of :class:`~.Everywhere.Everywhere`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spacetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return instance of :class:`~.Spacetime.Spacetime`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span>

    <span class="nd">@spacetime</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spacetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Spacetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for spacetime object.&#39;</span><span class="p">)</span>
        <span class="c1"># otherwise store a reference to the spacetime object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span> <span class="o">=</span> <span class="n">obj</span>

<div class="viewcode-block" id="Photosphere.embed"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.embed">[docs]</a>    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_total_counts</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Embed the photosphere in an ambient Schwarzschild spacetime.</span>

<span class="sd">        In other words, generate a discrete representation of the photospheric</span>
<span class="sd">        radiation field and the null mapping from the photosphere to infinity,</span>
<span class="sd">        for use in flux integrators called by distant observers.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="p">,</span>
                                   <span class="n">threads</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="p">,</span>
                                    <span class="n">fast_total_counts</span><span class="p">,</span>
                                    <span class="n">threads</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span><span class="o">.</span><span class="n">_compute_cellParamVecs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="n">fast_total_counts</span><span class="p">,</span>
                                <span class="n">threads</span><span class="p">)</span></div>

<div class="viewcode-block" id="Photosphere.integrate"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.integrate">[docs]</a>    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Integrate over the photospheric radiation field.</span>

<span class="sd">        :param energies:</span>
<span class="sd">            A one-dimensional :class:`numpy.ndarray` of energies in keV.</span>

<span class="sd">        :param int threads:</span>
<span class="sd">            Number of ``OpenMP`` threads to spawn for signal integration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                                   <span class="n">energies</span><span class="p">,</span>
                                                   <span class="n">threads</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="p">((</span><span class="n">spectrum</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),),)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="p">((</span><span class="n">spectrum</span><span class="p">,),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spectrum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                                     <span class="n">energies</span><span class="p">,</span>
                                                     <span class="n">threads</span><span class="p">,</span>
                                                     <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                                   <span class="n">energies</span><span class="p">,</span>
                                                   <span class="n">threads</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">,)</span>

                <span class="c1"># add time-invariant component to first time-dependent component</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">spectrum</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the stored signal.</span>

<span class="sd">        :returns:</span>
<span class="sd">            A tuple of tuples of *ndarray[m,n]*.</span>
<span class="sd">            Here :math:`m` is the number of energies, and</span>
<span class="sd">            :math:`n` is the number of phases. Units are photon/s/keV; the</span>
<span class="sd">            distance is a fast parameter so the areal units are not yet</span>
<span class="sd">            factored in. If the signal is a spectrum because the signal is</span>
<span class="sd">            time-invariant, then :math:`n=1`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signal</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a vector of global surface radiation field variables.</span>

<span class="sd">        :returns: An *ndarray[n]* of scalars required to evaluate variables</span>
<span class="sd">                  that control the radiation field w.r.t local comoving frames</span>
<span class="sd">                  across the stellar surface.</span>

<span class="sd">        The following code block is how one would pass the properties of a</span>
<span class="sd">        single-temperature circular ``HotRegion`` to the extension modules. If</span>
<span class="sd">        you have more than one ``HotRegion`` object merged into the subspace</span>
<span class="sd">        associated with the ``Photosphere`` object, they may each be prefixed,</span>
<span class="sd">        meaning that the set of parameter names below would need to be prefixed</span>
<span class="sd">        at the least, and unless you only want to image one ``HotRegion``, the</span>
<span class="sd">        parameters of the ``HotRegions`` object are required.</span>

<span class="sd">        .. highlight:: python</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            return _np.array([self[&#39;super_colatitude&#39;],</span>
<span class="sd">                              self[&#39;phase_shift&#39;] * _2pi,</span>
<span class="sd">                              self[&#39;super_radius&#39;],</span>
<span class="sd">                              self[&#39;super_temperature&#39;]])</span>

<span class="sd">        The phase shift controls the initial rotational phase of the</span>
<span class="sd">        ``HotRegion`` when imaging commences.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Subclass and provide an implementation.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_to_local_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_to_local_file</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@global_to_local_file</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">global_to_local_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">_six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;File path must be a string.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;File does not exist.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_to_local_file</span> <span class="o">=</span> <span class="n">filepath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the precomputed image information. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span>

    <span class="nd">@images</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store an *ndarray[i,j,k]* of images and associated information. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Image information was expected to be &#39;</span>
                                        <span class="s1">&#39;contained in an ndarray.&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unexpected type for image information.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;An iterable of objects containing image &#39;</span>
                            <span class="s1">&#39;information must be supplied.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There must be six ndarray objects specifing &#39;</span>
                             <span class="s1">&#39;image information.&#39;</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Image information element </span><span class="si">%i</span><span class="s1"> must have </span><span class="si">%i</span><span class="s1"> dimensions.&#39;</span>

        <span class="c1"># tuple elements:</span>
        <span class="c1">#   energy-phase resolved signal (2D array)</span>
        <span class="c1">#   x coordinate on image plane (1D array)</span>
        <span class="c1">#   y coordinate on image plane (1D array)</span>
        <span class="c1">#   colatitude mapped to point (x,y) on image plane (1D array)</span>
        <span class="c1">#   azimuth mapped to point (x,y) on image plane (1D array)</span>
        <span class="c1">#   radial coord mapped to point (x,y) on image plane (1D array)</span>
        <span class="c1">#   phase lag</span>
        <span class="c1">#   redshift</span>
        <span class="c1">#   aberrated ray angle to local surface normal</span>
        <span class="c1">#   elliptical image-plane radial array</span>
        <span class="c1">#   elliptical image-plane semi-major axis</span>
        <span class="c1">#   elliptical image-plane semi-minor axis</span>
        <span class="c1">#   energy-phase resolved specific intensity sky maps (3D array)</span>
        <span class="c1"># the last element is None if intensities not cached</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">images</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">_num_rays</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">9</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">_num_rays</span><span class="p">),</span>\
                <span class="p">(</span><span class="s1">&#39;Ray map: array length mismatch (array at tuple index </span><span class="si">%i</span><span class="s1"> is &#39;</span>
                 <span class="s1">&#39;not equal in length to array at tuple index 1).&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span> <span class="n">_m</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">_num_rays</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">9</span><span class="p">]),</span>\
                <span class="p">(</span><span class="s1">&#39;Ray map: array length mismatch for image-plane radial &#39;</span>
                 <span class="s1">&#39;coordinate array (array at tuple index 9).&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">images</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>\
                    <span class="p">(</span><span class="s1">&#39;Intensity cache dimension 0 does not match the length of &#39;</span>
                     <span class="s1">&#39;dimension 1 of the specific flux array &#39;</span>
                     <span class="s1">&#39;(at tuple index 1), meaning the number of phases &#39;</span>
                     <span class="s1">&#39;is mismatched.&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">_num_rays</span><span class="p">,</span>\
                    <span class="p">(</span><span class="s1">&#39;Intensity cache dimension 2 does not match the length of &#39;</span>
                     <span class="s1">&#39;ray map arrays (e.g., array at tuple index 1), meaning &#39;</span>
                     <span class="s1">&#39;the number of rays is mismatched.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="n">images</span>

    <span class="nd">@images</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span>

<div class="viewcode-block" id="Photosphere.load_image_data"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.load_image_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_image_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load imaging data from disk.</span>

<span class="sd">        :param str directory:</span>
<span class="sd">            Path to directory to load files from. Should contain files written</span>
<span class="sd">            to disk by :meth:`write_image_data`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_d</span> <span class="o">=</span> <span class="n">directory</span>

        <span class="n">photon_specific_flux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;photon_specific_flux.npy&#39;</span><span class="p">))</span>

        <span class="n">x_coordinate</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;x_coordinate.npy&#39;</span><span class="p">))</span>

        <span class="n">y_coordinate</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;y_coordinate.npy&#39;</span><span class="p">))</span>

        <span class="n">colatitude</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;colatitude.npy&#39;</span><span class="p">))</span>

        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;azimuth.npy&#39;</span><span class="p">))</span>

        <span class="n">radial_coord</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;radial_coord.npy&#39;</span><span class="p">))</span>

        <span class="n">phase_lag</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;phase_lag.npy&#39;</span><span class="p">))</span>

        <span class="n">redshift</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;redshift.npy&#39;</span><span class="p">))</span>

        <span class="n">abberated_angle</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;abberated_angle.npy&#39;</span><span class="p">))</span>

        <span class="n">IP_radial_array</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;IP_radial_array.npy&#39;</span><span class="p">))</span>

        <span class="n">IP_ellipse_axes</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;IP_ellipse_axes.npy&#39;</span><span class="p">))</span>

        <span class="n">intensity</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;intensity.npy&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">photon_specific_flux</span><span class="p">,</span>
                       <span class="n">x_coordinate</span><span class="p">,</span>
                       <span class="n">y_coordinate</span><span class="p">,</span>
                       <span class="n">colatitude</span><span class="p">,</span>
                       <span class="n">azimuth</span><span class="p">,</span>
                       <span class="n">radial_coord</span><span class="p">,</span>
                       <span class="n">phase_lag</span><span class="p">,</span>
                       <span class="n">redshift</span><span class="p">,</span>
                       <span class="n">abberated_angle</span><span class="p">,</span>
                       <span class="n">IP_radial_array</span><span class="p">,</span>
                       <span class="n">IP_ellipse_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                       <span class="n">IP_ellipse_axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="n">intensity</span><span class="p">]</span></div>

<div class="viewcode-block" id="Photosphere.write_image_data"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.write_image_data">[docs]</a>    <span class="k">def</span> <span class="nf">write_image_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write imaging data to disk.</span>

<span class="sd">        :param str directory:</span>
<span class="sd">            Path to directory to write to. Must exist.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_d</span> <span class="o">=</span> <span class="n">directory</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;photon_specific_flux.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;x_coordinate.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;y_coordinate.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;colatitude.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;azimuth.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;radial_coord.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;phase_lag.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;redshift.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;abberated_angle.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;IP_radial_array.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;IP_ellipse_axes.npy&#39;</span><span class="p">),</span>
                 <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">))</span>

        <span class="n">_np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_join</span><span class="p">(</span><span class="n">_d</span><span class="p">,</span> <span class="s1">&#39;intensity.npy&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">photon_specific_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the photon specific flux as a function of phase and energy.</span>

<span class="sd">        :return: A two-dimensional :class:`numpy.ndarray`, where photon energy</span>
<span class="sd">                 varies with row number, and phase varies with column number.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">photon_specific_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the photon specific intensity.</span>

<span class="sd">        Function of phase, energy and sky direction.</span>

<span class="sd">        :return: A three-dimensional :class:`numpy.ndarray`, where the first</span>
<span class="sd">                 dimension is phase, the second dimension is photon energy,</span>
<span class="sd">                 and the third dimension is sky direction (flattened from</span>
<span class="sd">                 two-dimensional sky coordinates to one dimension).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>

<div class="viewcode-block" id="Photosphere.image"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.image">[docs]</a>    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Imaging the star&#39;</span><span class="p">,</span> <span class="s1">&#39;Star imaged&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">reimage</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">reuse_ray_map</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">energies</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">num_phases</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">phases</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">phases_in_cycles</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">sqrt_num_rays</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
              <span class="n">epsabs_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">,</span>
              <span class="n">epsrel_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">,</span>
              <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
              <span class="n">init_step</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">image_plane_radial_increment_power</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
              <span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
              <span class="n">cache_intensities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">cache_energy_indices</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">cache_phase_indices</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">single_precision_intensities</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">plot_sky_maps</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">sky_map_kwargs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">animate_sky_maps</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">free_memory</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">animate_kwargs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Image the star as a function of phase and energy.</span>

<span class="sd">        :param bool reimage:</span>
<span class="sd">            (Re)image the star. If ``False``, but the spacetime configuration</span>
<span class="sd">            has been updated or the photosphere parameters have been updated,</span>
<span class="sd">            a warning will be generated. In principle, one might want to plot</span>
<span class="sd">            sky maps using cached imaging information, or animate sky maps</span>
<span class="sd">            using images on disk, so reimaging is not forced if (non-fixed)</span>
<span class="sd">            parameters have been changed.</span>

<span class="sd">        :param bool reuse_ray_map:</span>
<span class="sd">            Reuse a precomputed ray map from the stellar surface to the image</span>
<span class="sd">            plane. If the spacetime configuration has changed (non-fixed</span>
<span class="sd">            parameters have changed), a cached ray map will *not* be reused. If</span>
<span class="sd">            the spacetime configuration is unchanged, but resolution settings</span>
<span class="sd">            have changed for ray tracing, pass ``False`` to adhere to the new</span>
<span class="sd">            resolution settings.</span>

<span class="sd">        :param ndarray[n] energies:</span>
<span class="sd">            Energies in keV to evaluate incident specific intensities at.</span>

<span class="sd">        :param int num_phases:</span>
<span class="sd">            The number of phases spanning the unit interval (zero and unity</span>
<span class="sd">            inclusive) to image at.</span>

<span class="sd">        :param ndarray[m] phases:</span>
<span class="sd">            Phases in *radians* or *cycles* at which to evaluate incident</span>
<span class="sd">            specific intensities at. If not ``None``, takes precedence over</span>
<span class="sd">            :obj:`num_phases`. The units need to be specified with the</span>
<span class="sd">            :obj:`phases_in_cycles` keyword argument: if ``False``, give</span>
<span class="sd">            the phase array in *radians*.</span>

<span class="sd">        :param bool phases_in_cycles:</span>
<span class="sd">            Is the phase array, if not ``None``, in units of rotational cycles?</span>

<span class="sd">        :param int sqrt_num_rays:</span>
<span class="sd">            Square-root of the number of rays. This is the level of</span>
<span class="sd">            discretisation in both a radial coordinate and a polar coordinate</span>
<span class="sd">            on an elliptical image plane.</span>

<span class="sd">        .. note::</span>

<span class="sd">            When the spacetime is static or extremely close to being static in</span>
<span class="sd">            a numerical context, at the resolutions we are interested in, we</span>
<span class="sd">            need to mitigate problems with rays that graze the pole</span>
<span class="sd">            infinitesimally close to the polar axis. In the vicinity of the</span>
<span class="sd">            polar coordinate singularity the ODE system is stiff and the</span>
<span class="sd">            solution is unstable. The most straightforward way to mitigate this</span>
<span class="sd">            is to perform a fallback forward Euler step for a ray that passes</span>
<span class="sd">            exactly through the pole, and use that ray as an approximation for</span>
<span class="sd">            the grazing ray that started very nearby on the image plane.</span>
<span class="sd">            Internally, if a ray intersects the image plane at</span>
<span class="sd">            :math:`x`-coordinate that is numerically very close to, but not</span>
<span class="sd">            exactly, zero (which would mean alignment to the rotational axis),</span>
<span class="sd">            it is approximated by a ray that intersects :math:`x=0`.</span>
<span class="sd">            Image-plane interpolation of quantities (such as intensity) for</span>
<span class="sd">            the purpose of visualisation will then smooth out any such</span>
<span class="sd">            artefacts.</span>

<span class="sd">            Moreover, as an additional measure against artefacts in the sky</span>
<span class="sd">            maps in the vicinity of the rotational pole, rays are distributed</span>
<span class="sd">            accordingingly. For example, if we request :math:`n=400` rays per</span>
<span class="sd">            dimension, a maximal spacing of the rays from the rotational axis</span>
<span class="sd">            is achieved by rotating the *spokes* of rays (by up to</span>
<span class="sd">            :math:`\pm\pi/n`) so that no spoke is aligned (or anti-aligned)</span>
<span class="sd">            with the :math:`y`-direction.</span>

<span class="sd">        :param float epsabs_ray:</span>
<span class="sd">            Absolute error tolerance per ray to adhere to during numerical</span>
<span class="sd">            integration.</span>

<span class="sd">        :param float epsrel_ray:</span>
<span class="sd">            Relative error tolerance per ray to adhere to during numerical</span>
<span class="sd">            integration.</span>

<span class="sd">        :param int max_steps:</span>
<span class="sd">            Maximum number of steps to permit per ray before forced termination</span>
<span class="sd">            of integration.</span>

<span class="sd">        :param float init_step:</span>
<span class="sd">            The initial *suggested* step size at the image plane for the</span>
<span class="sd">            affine parameter for each ray.</span>

<span class="sd">        :param float image_plane_radial_increment_power:</span>
<span class="sd">            Controls the behaviour of the radial discretisation.</span>
<span class="sd">            Higher values towards unity result in linear spacing of rays with</span>
<span class="sd">            the radial coordinate. Lower values towards zero squeeze the rays</span>
<span class="sd">            towards the visible stellar limb, which is necessary for resolving</span>
<span class="sd">            images of extended radiating elements. Values above unity are not</span>
<span class="sd">            recommended, and would squeeze rays towards the image-plane origin,</span>
<span class="sd">            compromising resolution at the stellar limb.</span>

<span class="sd">        :param int threads:</span>
<span class="sd">            Number of OpenMP threads to spawn for parallel blocks of code.</span>
<span class="sd">            Parallel blocks include ray integration to generate a global ray</span>
<span class="sd">            map from image plane to surface; and image calculation at a</span>
<span class="sd">            sequence of rotational phases.</span>

<span class="sd">        :param float cache_intensities:</span>
<span class="sd">            Cache the photon specific intensity sky maps in memory, as a</span>
<span class="sd">            function of phase and energy? The type must be a float (greater than</span>
<span class="sd">            or equal to zero) or ``False``. The value represents the limiting</span>
<span class="sd">            size in GB that can be allocated for the intensity cache. Defaults</span>
<span class="sd">            to zero because this dominates memory consumption. You need to</span>
<span class="sd">            activate this option if you want to plot the sky maps (see below).</span>
<span class="sd">            To activate, supply a limit. A hard limit of 2 GB is imposed for</span>
<span class="sd">            safety. To override, use the secret :obj:`_OVERRIDE_MEM_LIM`</span>
<span class="sd">            keyword argument to supply a positive limit in GB.</span>

<span class="sd">        :param ndarray[m] cache_phase_indices:</span>
<span class="sd">            A one-dimensional :class:`numpy.ndarray` of ``dtype=numpy.int32``,</span>
<span class="sd">            specifying the phase-array indices to cache intensities at. This</span>
<span class="sd">            is useful to save memory when you want to plot specific intensity</span>
<span class="sd">            skymaps but also compute the specific flux at many more phases. If</span>
<span class="sd">            ``None``, intensities will be cached at all phases subject to</span>
<span class="sd">            memory constraints. Note that the order of the list matters for</span>
<span class="sd">            plotting order, so the indices should generally increase, as should</span>
<span class="sd">            the phases themselves. If plotting the pulse-profile and spectrum,</span>
<span class="sd">            then this is a case where many more phases are useful for the</span>
<span class="sd">            resolving specific flux pulse-profile than are needed to plot</span>
<span class="sd">            specific intensity skymaps and specific flux spectra at three</span>
<span class="sd">            representative phases.</span>

<span class="sd">        :param ndarray[m] cache_energy_indices:</span>
<span class="sd">            A one-dimensional :class:`numpy.ndarray` of ``dtype=numpy.int32``,</span>
<span class="sd">            specifying the energy-array indices to cache intensities at. This</span>
<span class="sd">            is useful to save memory when you want to plot specific intensity</span>
<span class="sd">            skymaps but also compute the specific flux at many more energies. If</span>
<span class="sd">            ``None``, intensities will be cached at all energies subject to</span>
<span class="sd">            memory constraints. Note that the order of the list matters for</span>
<span class="sd">            plotting order, so the indices should generally increase, as should</span>
<span class="sd">            the energies themselves. If plotting the pulse-profile and spectrum,</span>
<span class="sd">            then this is a case where many more energies are useful for the</span>
<span class="sd">            resolving specific flux spectrum than are needed to plot specific</span>
<span class="sd">            intensity skymaps and specific flux pulse-profiles at three</span>
<span class="sd">            representative energies.</span>

<span class="sd">        :param bool single_precision_intensities:</span>
<span class="sd">            Cache the intensities in single precision? In most use cases,</span>
<span class="sd">            double precision is simply unnecessary, and because memory</span>
<span class="sd">            consumption can be high, choosing single precision can reduce</span>
<span class="sd">            memory requirements by a factor of two. Note that this only applies</span>
<span class="sd">            to the caching of intensities, not the calculation of intensities,</span>
<span class="sd">            which is done safely in double precision; only the final caching</span>
<span class="sd">            operation is a demotion cast to single precision. The default</span>
<span class="sd">            is single precision caching. Option ignored if intensities are not</span>
<span class="sd">            cached.</span>

<span class="sd">        :param bool plot_sky_maps:</span>
<span class="sd">            Plot (specific) intenity sky maps at a sequence of phases, or</span>
<span class="sd">            by averaging over phase. Maps can be made at one more energies</span>
<span class="sd">            or energy intervals. The images will be written to disk and</span>
<span class="sd">            can be used as frames in an animated sequence.</span>

<span class="sd">        :param dict sky_map_kwargs:</span>
<span class="sd">            Dictionary of keyword arguments passed to</span>
<span class="sd">            :meth:`~Photosphere._plot_sky_maps`. Refer to the associated</span>
<span class="sd">            method docstring for available options.</span>

<span class="sd">        :param bool animate_sky_maps:</span>
<span class="sd">            Compile images from disk into an animated sequence.</span>

<span class="sd">        :param bool free_memory:</span>
<span class="sd">            Try to free the imaging information before animating a sequence of</span>
<span class="sd">            sky maps written to disk, to try to avoid high memory usage. For</span>
<span class="sd">            safety the default is to free the memory, so deactivate this at your</span>
<span class="sd">            own risk. If there are other non-weak references created to the</span>
<span class="sd">            underlying objects, the memory may fail to be freed. In the</span>
<span class="sd">            methods below, the aim is that the native garbage collection cleans</span>
<span class="sd">            up the references because they only exist in the method local scope</span>
<span class="sd">            (no closures or globals).</span>

<span class="sd">        .. note::</span>

<span class="sd">            Memory used for plotting the sky maps and loading the images from</span>
<span class="sd">            disk to animate a phase sequence might not be straightforwardly</span>
<span class="sd">            freed despite efforts to do so, because of non-weak references</span>
<span class="sd">            covertly held by the matplotlib module.</span>

<span class="sd">        :param dict animate_kwargs:</span>
<span class="sd">            Dictionary of keyword arguments passed to</span>
<span class="sd">            :meth:`~Photosphere._animate`. Refer to the associated method</span>
<span class="sd">            docstring for available options.</span>

<span class="sd">        :param bool deactivate_all_verbosity:</span>
<span class="sd">            Deactivate the verbose output? Note that despite this keyword</span>
<span class="sd">            argument not appearing in the method signature, it is a valid</span>
<span class="sd">            switch.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span> <span class="c1"># geometry shortcut saves characters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_DV</span> <span class="o">=</span> <span class="n">deactivate_verbosity</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">_DV</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">_exc</span> <span class="o">=</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You need to cache intensity sky maps if you &#39;</span>
                          <span class="s1">&#39;want to plot them.&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reimage</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">plot_sky_maps</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">_exc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Warning: star will not be reimaged... assuming &#39;</span>
                           <span class="s1">&#39;images exist on disk.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reimage</span> <span class="ow">and</span> <span class="n">plot_sky_maps</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_exc</span>

        <span class="k">if</span> <span class="n">phases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Imaging phases must be in a 1D ndarray.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">phases_in_cycles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">_warning</span><span class="p">(</span><span class="s1">&#39;Phase array does not span the unit interval.&#39;</span><span class="p">)</span>
                <span class="n">phases</span> <span class="o">*=</span> <span class="n">_2pi</span>
        <span class="k">elif</span> <span class="n">phases</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_phases</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_phases</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Integer number of phases required.&#39;</span><span class="p">)</span>
            <span class="n">phases</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">num_phases</span><span class="p">)</span> <span class="o">*</span> <span class="n">_2pi</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Imaging energies must be in a 1D ndarray.&#39;</span><span class="p">)</span>

        <span class="n">time_is_space</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_is_space&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reimage</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_sky_maps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cache_intensities</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_exc</span>

            <span class="k">if</span> <span class="n">cache_intensities</span><span class="p">:</span>
                <span class="n">_override_mem_lim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_OVERRIDE_MEM_LIM&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_override_mem_lim</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Intensity cache limit override must be a &#39;</span>
                                    <span class="s1">&#39;float.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">_override_mem_lim</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Intensity cache limit override must be &#39;</span>
                                     <span class="s1">&#39;positive or zero.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_intensities</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Intensity cache limit must be a float.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">cache_intensities</span> <span class="o">&lt;=</span> <span class="n">_override_mem_lim</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Intensity cache limit must be positive &#39;</span>
                                     <span class="s1">&#39;and less than the safety limit, which &#39;</span>
                                     <span class="s1">&#39;in turn can be overridden as described &#39;</span>
                                     <span class="s1">&#39;in the method docstring.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cache_energy_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cache_energy_indices</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
                                                      <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_energy_indices</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Energy indices for intensity caching &#39;</span>
                                    <span class="s1">&#39;must be supplied in a 1D numpy.ndarray.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cache_energy_indices</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Energy indices for intensity caching &#39;</span>
                                    <span class="s1">&#39;must be integers.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_energy_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Sky maps must be cached at all energies.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cache_phase_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cache_phase_indices</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">),</span>
                                                      <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache_phases_indices</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Phase indices for intensity caching &#39;</span>
                                    <span class="s1">&#39;must be supplied in a 1D numpy.ndarray.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">cache_phase_indices</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Phase indices for intensity caching &#39;</span>
                                    <span class="s1">&#39;must be integers.&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_phases_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Sky maps must be cached at all phases.&#39;</span><span class="p">)</span>

                <span class="n">_req_size</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="k">if</span> <span class="n">single_precision_intensities</span> <span class="k">else</span> <span class="mf">8.0</span>
                <span class="n">_req_size</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_phase_indices</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_energy_indices</span><span class="p">)</span> <span class="c1"># bytes</span>
                <span class="n">_req_size</span> <span class="o">*=</span> <span class="n">sqrt_num_rays</span><span class="o">**</span><span class="mf">2.0</span> <span class="c1"># + 1.0 # origin ray negligible</span>

                <span class="k">if</span> <span class="n">_req_size</span><span class="o">/</span><span class="mf">1.0e9</span> <span class="o">&gt;=</span> <span class="n">cache_intensities</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">MemoryError</span><span class="p">(</span><span class="s1">&#39;Too much memory would be required to &#39;</span>
                                      <span class="s1">&#39;cache the intensities at this &#39;</span>
                                      <span class="s1">&#39;resolution. Try decreasing the number &#39;</span>
                                      <span class="s1">&#39;of rays, energies, and/or phases, or &#39;</span>
                                      <span class="s1">&#39;override the cache size limit if &#39;</span>
                                      <span class="s1">&#39;safe.&#39;</span><span class="p">)</span>
                <span class="n">cache_intensities</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cache_intensities</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reuse_ray_map</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Warning: a ray map has not been cached... &#39;</span>
                           <span class="s1">&#39;tracing new ray set&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if spacetime configuration was updated</span>
                <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">needs_update</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">reuse_ray_map</span><span class="p">:</span>
                    <span class="c1"># try to free up memory; CPython reference counting means</span>
                    <span class="c1"># this should have immediate effect</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># del self.images[0] # doesn&#39;t require much memory</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># requires far more memory</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_ray_map</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">yield</span> <span class="s1">&#39;Cached ray set to be reused... commencing imaging&#39;</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">_ray_map</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">yield</span> <span class="s1">&#39;Commencing ray tracing and imaging&#39;</span>

            <span class="n">images</span> <span class="o">=</span> <span class="n">_integrate</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">r_s</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">Omega</span><span class="p">,</span>
                                <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">],</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">zeta</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="c1"># dimensionless spin</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="c1"># mass quadrupole</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                                <span class="n">sqrt_num_rays</span><span class="p">,</span>
                                <span class="n">epsabs_ray</span><span class="p">,</span>
                                <span class="n">epsrel_ray</span><span class="p">,</span>
                                <span class="n">max_steps</span><span class="p">,</span>
                                <span class="n">init_step</span><span class="p">,</span>
                                <span class="n">image_plane_radial_increment_power</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">global_variables</span><span class="p">,</span>
                                <span class="n">energies</span><span class="p">,</span>
                                <span class="n">phases</span><span class="p">,</span>
                                <span class="n">cache_intensities</span><span class="p">,</span>
                                <span class="n">cache_energy_indices</span><span class="p">,</span>
                                <span class="n">cache_phase_indices</span><span class="p">,</span>
                                <span class="n">single_precision_intensities</span><span class="p">,</span>
                                <span class="n">_ray_map</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">global_to_local_file</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;A numerical error arose during imaging &#39;</span>
                                <span class="s1">&#39;computation... terminating simulation.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_ray_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># only recalculated info is returned</span>
                <span class="c1"># tuple elements:</span>
                <span class="c1">#   energy-phase resolved signal (2D array)</span>
                <span class="c1">#   energy-phase resolved specific intensity sky maps (3D array)</span>
                <span class="c1"># the last element is None if intensities not cached</span>
                <span class="c1"># transpose so signal phase increments along columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># the ray map is also returned</span>
                <span class="c1"># tuple elements:</span>
                <span class="c1">#   energy-phase resolved signal (2D array)</span>
                <span class="c1">#   x coordinate on image plane (1D array)</span>
                <span class="c1">#   y coordinate on image plane (1D array)</span>
                <span class="c1">#   colatitude mapped to point (x,y) on image plane (1D array)</span>
                <span class="c1">#   azimuth mapped to point (x,y) on image plane (1D array)</span>
                <span class="c1">#   radial coord mapped to point (x,y) on image plane (1D array)</span>
                <span class="c1">#   phase lag</span>
                <span class="c1">#   redshift</span>
                <span class="c1">#   aberrated ray angle to local surface normal</span>
                <span class="c1">#   elliptical image-plane radial array</span>
                <span class="c1">#   elliptical image-plane semi-major axis</span>
                <span class="c1">#   elliptical image-plane semi-minor axis</span>
                <span class="c1">#   energy-phase resolved specific intensity sky maps (3D array)</span>
                <span class="c1"># the last element is None if intensities not cached</span>
                <span class="c1"># transpose so signal phase increments along columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">yield</span> <span class="s1">&#39;Ray tracing complete.&#39;</span>
                <span class="k">yield</span> <span class="s1">&#39;Ray set cached.&#39;</span>

            <span class="k">if</span> <span class="n">cache_intensities</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;Intensity caching complete.&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Phase-resolved specific flux integration complete.&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Specific flux integration complete.&#39;</span>

            <span class="c1"># memoization</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">([</span><span class="n">param</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">sky_map_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sky_map_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">animate_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">animate_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">plot_sky_maps</span> <span class="ow">or</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
            <span class="n">root_dir</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;root_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;./images&#39;</span><span class="p">)</span>
            <span class="n">file_root</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_root&#39;</span><span class="p">,</span> <span class="s1">&#39;skymap&#39;</span><span class="p">)</span>
            <span class="n">file_root</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">file_root</span><span class="p">)</span>

            <span class="n">phase_average</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phase_average&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_average</span> <span class="ow">and</span> <span class="n">time_is_space</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot phase average sky maps when spatial &#39;</span>
                                 <span class="s1">&#39;dimensions are used to render time.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_average</span> <span class="ow">and</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Phase averaged sky maps cannot be animated.&#39;</span><span class="p">)</span>

            <span class="n">bolometric</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bolometric&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bolometric</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot energy-integrate sky maps when spatial &#39;</span>
                                 <span class="s1">&#39;dimensions are used to render energy.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bolometric</span> <span class="ow">and</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bolometric sky maps cannot be animated.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
                <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_0.png&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: at least one image file exists &#39;</span>
                      <span class="s1">&#39;in ``</span><span class="si">%s</span><span class="s1">``.&#39;</span> <span class="o">%</span> <span class="n">root_dir</span><span class="p">)</span>
                <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Attempting to move image files to a subdirectory &#39;</span>
                      <span class="s1">&#39;of ``</span><span class="si">%s</span><span class="s1">``.&#39;</span> <span class="o">%</span> <span class="n">root_dir</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="c1"># to archive the existing image files</span>
                    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="s1">&#39;__datetime__</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">__</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;archived_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">temp</span><span class="p">)</span>
                    <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

                    <span class="n">image_files</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                            <span class="n">_os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">image</span><span class="p">),</span>
                                       <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Aborting: image files would be &#39;</span>
                                    <span class="s1">&#39;overwritten. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>  <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Image files archived in subdirectory ``</span><span class="si">%s</span><span class="s1">``.&#39;</span> <span class="o">%</span> <span class="n">temp</span>

            <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">num_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sky_maps</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span>
                                               <span class="n">_phases</span> <span class="o">=</span> <span class="n">phases</span><span class="p">,</span>
                                               <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                                               <span class="n">_c_idxs</span> <span class="o">=</span> <span class="n">cache_energy_indices</span><span class="p">,</span>
                                               <span class="n">_c_pidxs</span> <span class="o">=</span> <span class="n">cache_phase_indices</span><span class="p">,</span>
                                               <span class="n">_redraw</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="n">deactivate_verbosity</span> <span class="o">=</span> <span class="n">_DV</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">sky_map_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reimage</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Star was reimaged but sky maps were not &#39;</span>
                                 <span class="s1">&#39;plotted... aborting animation.&#39;</span><span class="p">)</span>

            <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">num_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sky_maps</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span>
                                               <span class="n">_phases</span> <span class="o">=</span> <span class="n">phases</span><span class="p">,</span>
                                               <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                                               <span class="n">_c_idxs</span> <span class="o">=</span> <span class="n">cache_energy_indices</span><span class="p">,</span>
                                               <span class="n">_c_pidxs</span> <span class="o">=</span> <span class="n">cache_phase_indices</span><span class="p">,</span>
                                               <span class="n">_redraw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="n">deactivate_verbosity</span> <span class="o">=</span> <span class="n">_DV</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">sky_map_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_0.png&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;No images located for animation.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_frames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">reimage</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">num_frames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;You need to declare the image phases &#39;</span>
                                        <span class="s1">&#39;in order to include all images from disk.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;You need to declare the image energies &#39;</span>
                                        <span class="s1">&#39;in order to include all images from disk.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">free_memory</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="c1"># try to free up memory</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_animate</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span>
                          <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span>
                          <span class="n">deactivate_verbosity</span> <span class="o">=</span> <span class="n">_DV</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">animate_kwargs</span><span class="p">)</span>

        <span class="k">yield</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Photosphere._plot_sky_maps"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere._plot_sky_maps">[docs]</a>    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Plotting intensity sky maps&#39;</span><span class="p">,</span> <span class="s1">&#39;Intensity sky maps plotted&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_plot_sky_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">_file_root</span><span class="p">,</span>
                       <span class="n">_phases</span><span class="p">,</span>
                       <span class="n">_energies</span><span class="p">,</span>
                       <span class="n">_c_idxs</span><span class="p">,</span>
                       <span class="n">_c_pidxs</span><span class="p">,</span>
                       <span class="n">_redraw</span><span class="p">,</span>
                       <span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">with_pulse_profile_and_spectrum</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">time_is_space</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">panel_layout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">panel_indices</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">cycles</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">phase_average</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">bolometric</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">energy_bounds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">phase_bounds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">num_levels</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                       <span class="n">add_zero_intensity_level</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">normalise_each_panel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">annotate_energies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">annotate_phases</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">energy_annotation_format</span><span class="o">=</span><span class="s1">&#39;[</span><span class="si">%.1f</span><span class="s1"> keV]&#39;</span><span class="p">,</span>
                       <span class="n">phase_annotation_format</span><span class="o">=</span><span class="s1">&#39;[</span><span class="si">%.1f</span><span class="s1"> cycles]&#39;</span><span class="p">,</span>
                       <span class="n">annotate_location</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">),</span>
                       <span class="n">colormap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                       <span class="n">usetex</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">fontsize_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">tick_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span>
                       <span class="n">tick_length_scaling</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">dpi_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method for specific intensity sky map visualization.</span>

<span class="sd">        Uses Delaunay triangulation to create an irregular sky mesh and</span>
<span class="sd">        calculate photon (specific) intensity contours at a sequence of phases.</span>

<span class="sd">        Each figure generated contains a sequence of panels arranged in</span>
<span class="sd">        one or two spatial dimensions. Each panel is an intensity sky map,</span>
<span class="sd">        either at a particular energy or integrated over a finite energy</span>
<span class="sd">        interval. Panels cannot mix specific and integrated intensities. Only</span>
<span class="sd">        a some sequence of energy (intervals), in any order, can be identified</span>
<span class="sd">        as labelling panels in one or two spatial dimensions. Time (rotational</span>
<span class="sd">        phase), whilst it could be defined to label a sequence of panels, is</span>
<span class="sd">        only identified as a labelling a sequence of *figures*.</span>

<span class="sd">        Similarly, sequence of energies could be identified as a variable</span>
<span class="sd">        labelling a sequence of figures, but is not. Moreover, energy and time</span>
<span class="sd">        could label panels in to spatial dimensions, but such mixing is not</span>
<span class="sd">        permitted. Finally, variables controlling the source-receiver system</span>
<span class="sd">        could be identified as labels of panels and/or figures, but this</span>
<span class="sd">        is also not supported. More complicated rendering patterns may be</span>
<span class="sd">        supported in future versions, but for now can be achieved via</span>
<span class="sd">        custom extensions building off of the current functionality.</span>

<span class="sd">        :param str _file_root:</span>
<span class="sd">            Relative or absolute path to parent directory for images,</span>
<span class="sd">            extended with the root name for the image files. E.g., the</span>
<span class="sd">            default is ``./images/skymap``. You do not need to change this</span>
<span class="sd">            unless you wish to, and is otherwise reserved for internal use.</span>
<span class="sd">            You may supply a custom file path via keywords ``root_dir`` and</span>
<span class="sd">            ``file_root`` upon calling :meth:`~Photosphere.image`, which are</span>
<span class="sd">            concatenated appropriately.</span>

<span class="sd">        :param ndarray[n] _phases:</span>
<span class="sd">            The phases at which the star was imaged. This is handled</span>
<span class="sd">            internally, so do *not* pass a keyword argument. If phase averaging,</span>
<span class="sd">            the minimum and maximum phases must be zero and :math:`2\pi`</span>
<span class="sd">            radians (i.e., zero and one cycles).</span>

<span class="sd">        :param ndarray[n] _energies:</span>
<span class="sd">            The energies at which the star was imaged. This is handled</span>
<span class="sd">            internally, so do *not* pass a keyword argument.</span>

<span class="sd">        :param ndarray[n] _c_idxs:</span>
<span class="sd">            The energy indices for which the intensity maps were cached for</span>
<span class="sd">            memory-efficieny plotting. This is handled internally, so do *not*</span>
<span class="sd">            pass a keyword argument.</span>

<span class="sd">        :param ndarray[n] _c_pidxs:</span>
<span class="sd">            The energy indices for which the intensity maps were cached for</span>
<span class="sd">            memory-efficieny plotting. This is handled internally, so do *not*</span>
<span class="sd">            pass a keyword argument.</span>

<span class="sd">        :param bool _redraw:</span>
<span class="sd">            Redraw the sky maps? This is handled internally, so do *not* pass</span>
<span class="sd">            a keyword argument.</span>

<span class="sd">        :param int threads:</span>
<span class="sd">            Number of OpenMP threads to spawn.</span>

<span class="sd">        :param bool with_pulse_profile_and_spectrum:</span>
<span class="sd">            A setting that fundamentally changes some behaviours. If</span>
<span class="sd">            deactivated (the default), only photon (specific) intensity skymaps</span>
<span class="sd">            are plotted. The following frame is an example:</span>

<span class="sd">        .. image:: _static/_skymap_plot.png</span>

<span class="sd">        :param bool with_pulse_profile_and_spectrum:</span>
<span class="sd">            If deactivated, the following keyword arguments do not have a use:</span>
<span class="sd">            :obj:`cycles` and :obj:`colormap`. If *activated*, photon specific</span>
<span class="sd">            intensity skymaps at three energies are plotted in each frame,</span>
<span class="sd">            together with their associated photon specific flux pulse-profiles,</span>
<span class="sd">            and also the photon specific flux spectrum at a finer array of</span>
<span class="sd">            energies. Use :obj:`panel_indices` to select the energies. The</span>
<span class="sd">            pulse-profiles are each normalised to their respective maxima,</span>
<span class="sd">            and the spectrum shows the relative orders of magnitude of the</span>
<span class="sd">            specific flux signals. The following frame is an example:</span>

<span class="sd">        .. image:: _static/_skymap_with_pulse_profile_and_spectrum_plot.png</span>

<span class="sd">        :param bool with_pulse_profile_and_spectrum:</span>
<span class="sd">            If activated, a subset of other keyword arguments are ignored:</span>
<span class="sd">            :obj:`energy_bounds`, :obj:`phase_average`, :obj:`panel_layout`,</span>
<span class="sd">            and :obj:`invert`. The panel layout is rigid (not customisable) in</span>
<span class="sd">            order to focus on the plot quality. If more energies were added, the</span>
<span class="sd">            information density in the plot-space might become too high without</span>
<span class="sd">            adding much more new information.</span>

<span class="sd">        :param bool time_is_space:</span>
<span class="sd">            Each image is at constant energy (or is a spectral trace up to</span>
<span class="sd">            that energy) instead of being at constant phase (or a pulse-profile</span>
<span class="sd">            trace up to that phase).</span>

<span class="sd">        :param tuple[int,int] panel_layout:</span>
<span class="sd">            Two elements: the number of rows and columns of panels. If ``None``,</span>
<span class="sd">            a layout is automatically determined based on the number of</span>
<span class="sd">            images to be plotted.</span>

<span class="sd">        :param iterable panel_indices:</span>
<span class="sd">            These ordered integers will be used to select intensity information</span>
<span class="sd">            by indexing the energy dimension of a 3D intensity array. If</span>
<span class="sd">            specific intensites are plotted, these integers should index</span>
<span class="sd">            a subset of energies at which the star was imaged. If intensities</span>
<span class="sd">            are plotted, these integers should index a subset of the energy</span>
<span class="sd">            intervals over which specific intensities are integrated. See</span>
<span class="sd">            the :obj:`energy_bounds` keyword argument. If the flux is</span>
<span class="sd">            calculated at more energies than specific intensities are cached</span>
<span class="sd">            at, then these integers need to index the</span>
<span class="sd">            :obj:`cache_energy_indices` array appropriately.</span>

<span class="sd">        :param int cycles:</span>
<span class="sd">            Nuber of cycles to generate images for. Only relevant if one cycle</span>
<span class="sd">            is different to the next in terms of the frame, e.g., most commonly</span>
<span class="sd">            if plotting the pulse-profile traces over more than one cycle. If</span>
<span class="sd">            frames separated by one cycle are identical, declare the number</span>
<span class="sd">            of cycles to the animator instead.</span>

<span class="sd">        :param bool phase_average:</span>
<span class="sd">            Average each sky map over one revolution (cycle) in phase?</span>
<span class="sd">            Note that the resulting image is incompatible with the currently</span>
<span class="sd">            supported animation mode. The following image is an example:</span>

<span class="sd">        .. image:: _static/_skymap_phaseaveraged.png</span>

<span class="sd">        :param bool bolometric:</span>
<span class="sd">            Integrate each sky map over energy? Note that the resulting image</span>
<span class="sd">            is incompatible with the currently supported animation mode.</span>

<span class="sd">        :param iterable energy_bounds:</span>
<span class="sd">            A set of two-element containers. Each container has an ordered pair</span>
<span class="sd">            of energies which delimit an integration domain. Specific intensity</span>
<span class="sd">            is integrated along each sky direction, at each phase, between</span>
<span class="sd">            these energy bounds. The bounds must be between the minimum and</span>
<span class="sd">            maximum energies at which the star was imaged. If ``None``,</span>
<span class="sd">            specific intensity sky maps will be plotted (the default). This</span>
<span class="sd">            option is ignored if energy is defined as the time dimension,</span>
<span class="sd">            meaning the sky maps are animated with respect to energy.</span>

<span class="sd">        :param iterable phase_bounds:</span>
<span class="sd">            A set of two-element containers. Each container has an ordered pair</span>
<span class="sd">            of energies which delimit an integration domain. Specific intensity</span>
<span class="sd">            is integrated along each sky direction, at each phase, between</span>
<span class="sd">            these energy bounds. The bounds must be between the minimum and</span>
<span class="sd">            maximum energies at which the star was imaged. If ``None``,</span>
<span class="sd">            specific intensity sky maps will be plotted (the default). This</span>
<span class="sd">            option is ignored if phase is defined as the time dimension,</span>
<span class="sd">            meaning the sky maps are animated with respect to phase.</span>

<span class="sd">        .. note::</span>

<span class="sd">            To use this functionality, the specific intensities must have</span>
<span class="sd">            been cached at all energies the specific flux is calculated at.</span>

<span class="sd">        :param int num_levels:</span>
<span class="sd">            Number of contour levels in (specific) intensity, distributed</span>
<span class="sd">            between minimum finite, and maximum values per panel, or over all</span>
<span class="sd">            panels. See :obj:`normalise_each_panel` keyword argument.</span>

<span class="sd">        :param bool add_zero_intensity_level:</span>
<span class="sd">            Add a contour level at zero intensity such that the colormap</span>
<span class="sd">            minimum corresponds to zero intensity? If ``True`` (the default),</span>
<span class="sd">            then the background sky, where there is by definition zero model</span>
<span class="sd">            intensity, has the same colour only as the subset of the image of</span>
<span class="sd">            the surface that is not radiating in the model. The disadvantage of</span>
<span class="sd">            this choice is that the intensity structure of the image as a</span>
<span class="sd">            function of phase and sky direction is generally not as well-</span>
<span class="sd">            resolved by the colour and greyscale variation. In the limit</span>
<span class="sd">            that the minimum finite intensity of the image is far smaller than</span>
<span class="sd">            the maximum, then the intensity resolution by colour and greyscale</span>
<span class="sd">            values is highest. If ``False``, then the minimum colour is</span>
<span class="sd">            assigned to the minimum finite intensity as a function of phase</span>
<span class="sd">            and sky direction. This also maximally resolves the intensity by</span>
<span class="sd">            colour and greyscale values, which is useful for models wherein the</span>
<span class="sd">            surface radiation field is constructed, for instance, from</span>
<span class="sd">            uniform-temperature localised hot regions. However, in this case</span>
<span class="sd">            the background sky colour is undefined; the background sky colour</span>
<span class="sd">            is thus set to the minimum colour in the colormap, meaning that the</span>
<span class="sd">            fainest subset of the image over phase and sky direction merges</span>
<span class="sd">            with the background sky in terms of colour and greyscale values.</span>

<span class="sd">        :param bool normalise_each_panel:</span>
<span class="sd">            Normalise the contour colormap to each skymap panel uniquely, or</span>
<span class="sd">            globally over all panels? The former yields relative intensity</span>
<span class="sd">            as function of phase and sky direction for an energy or energy</span>
<span class="sd">            interval, whilst the latter offers more spectral information but</span>
<span class="sd">            emission in some panels may not be discernable.</span>

<span class="sd">        :param bool invert:</span>
<span class="sd">            Invert the greyscale to show bright pixels as dark on a white</span>
<span class="sd">            plot background. If a colormap is manually supplied, this just</span>
<span class="sd">            controls the plot background colour. Inversion is recommended</span>
<span class="sd">            for printed format, whilst a black background is more intuitive</span>
<span class="sd">            when in digital format.</span>

<span class="sd">        :param obj colormap:</span>
<span class="sd">            Usage dependent on other settings. If not plotting the pulse-profile</span>
<span class="sd">            and spectrum, then this is simply a (matplotlib) colormap object.</span>
<span class="sd">            Choose something appropriate and *accessible* for a non-negative</span>
<span class="sd">            scalar field (sky intensities). If plotting the pulse-profile and</span>
<span class="sd">            spectrum too, then :obj:`colormap` can be the string</span>
<span class="sd">            ``&#39;RedGreyBlue&#39;`` to invoke the default colour scheme which is reds</span>
<span class="sd">            for the lowest energy intensity skymap and pulse-profile; pure</span>
<span class="sd">            greyscale for the intermediate energy; and blues for the highest</span>
<span class="sd">            energy.  Alternatively, if :obj:`colormap` is simply ``None``, the</span>
<span class="sd">            default greyscale will be used for all energies, with all</span>
<span class="sd">            pulse-profiles in black. Lastly, you can supply a three-element</span>
<span class="sd">            list or tuple of colormap objects, ordered from lowest to highest</span>
<span class="sd">            energy; the pulse-profile line colours will be retrieved as the</span>
<span class="sd">            midpoint of the colormap. Note that the background sky colour will</span>
<span class="sd">            be set to the lowest colour in each colourmap.</span>

<span class="sd">        :param tuple(int,int) figsize:</span>
<span class="sd">            The figure size (width, height) in *inches*. If the dimensions are</span>
<span class="sd">            inconsistent with the aspect ratio suggested by the</span>
<span class="sd">            :obj`panel_layout` settings, the height of the figure will be</span>
<span class="sd">            automatically rescaled to achieve congruence, meaning each panel is</span>
<span class="sd">            approximately square.</span>

<span class="sd">        :param bool usetex:</span>
<span class="sd">            Use TeX backend for figure text.</span>

<span class="sd">        :param float fontsize_scale:</span>
<span class="sd">            Use this argument to scale the font size of figure text relative</span>
<span class="sd">            to the default font size that is automatically determined based</span>
<span class="sd">            on the approximate panel size, which is in turn based on the</span>
<span class="sd">            figure size and the panel layout.</span>

<span class="sd">        :param tuple[float,float] tick_spacing:</span>
<span class="sd">            A two-element container. The first element is the minor tick</span>
<span class="sd">            spacing, and the second is the major tick spacing, for both</span>
<span class="sd">            the :math:`x` and :math:`y` directions on the image plane. The</span>
<span class="sd">            units are both the maximum possible angular size of the image of the</span>
<span class="sd">            surface in an ambient Schwarzschild spacetime,</span>
<span class="sd">            :math:`R_{\\rm eq}/\\sqrt{1-r_{\\rm s}/R_{\\rm eq}}`.</span>

<span class="sd">        :param float tick_length_scaling:</span>
<span class="sd">            Use this argument to scale the axis tick lengths relative to the</span>
<span class="sd">            default lengths that are automatically determined based on the</span>
<span class="sd">            panel size.</span>

<span class="sd">        :param float dpi_scale:</span>
<span class="sd">            Use this argument to scale the dots per inch of the figure,</span>
<span class="sd">            relative to the default that is automatically determined based</span>
<span class="sd">            on the panel size.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_root</span> <span class="o">=</span> <span class="n">_file_root</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">_phases</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">_energies</span>
        <span class="n">redraw</span> <span class="o">=</span> <span class="n">_redraw</span>

        <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Selected plot type designed for showcasing &#39;</span>
                                 <span class="s1">&#39;the specific photon intensity skymaps and &#39;</span>
                                 <span class="s1">&#39;their associated specific photon flux &#39;</span>
                                 <span class="s1">&#39;pulse-profiles or spectra specifically at &#39;</span>
                                 <span class="s1">&#39;at three energies or phases to avoid &#39;</span>
                                 <span class="s1">&#39;excessive information density.&#39;</span><span class="p">)</span>
            <span class="n">panel_layout</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cycles</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Declare the number of cycles with an integer.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cycles</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cycles</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># quietly ignore input</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cycles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">panel_layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_m</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_m</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                <span class="n">panel_layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">panel_layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

        <span class="c1"># try to improve the aspect ratio so that each panel is</span>
        <span class="c1"># approximately square</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">_hspace</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="k">else</span> <span class="mf">0.2</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">_hspace</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">aspect_ratio</span><span class="p">)</span><span class="o">/</span><span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
               <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>

        <span class="c1"># calculate an appropriate dpi to resolve each panel adequately</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">150.0</span> <span class="o">*</span> <span class="n">dpi_scale</span>

        <span class="k">if</span> <span class="n">redraw</span><span class="p">:</span>
            <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usetex</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Panel indices object must be iterable.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are too few panels for the requested &#39;</span>
                                 <span class="s1">&#39;number of intensity sky maps.&#39;</span><span class="p">)</span>

            <span class="c1"># some scaling for appropriate fontsize</span>
            <span class="n">panel_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                             <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">fontsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel_size</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">14.0</span> <span class="o">*</span> <span class="n">fontsize_scale</span>
            <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="n">tick_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">panel_size</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">tick_length_scaling</span><span class="p">)</span>

            <span class="c1"># get coordinates of irregular set of points for triangulation</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1">#if not isinstance(energies, _np.ndarray):</span>
            <span class="c1">#    raise TypeError(&#39;Imaging energies must be in an ndarray.&#39;)</span>
            <span class="c1">#if not isinstance(phases, _np.ndarray):</span>
            <span class="c1">#    raise TypeError(&#39;Imaging phases must be in an ndarray.&#39;)</span>

            <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">time_is_space</span><span class="p">:</span> <span class="c1"># transpose dimensions</span>
                <span class="n">_images_</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">_images_</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

                <span class="n">images</span> <span class="o">=</span> <span class="n">_images_</span>

            <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                    <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">energy_bounds</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;Integrating specific intensity over energy intervals&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Integrated specific intensity over energy intervals&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="n">energy_bounds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Energy bounds in a tuple must be &#39;</span>
                                             <span class="s1">&#39;ordered.&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">&lt;=</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Extrapolation would be required.&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="s1">&#39;Warning: fewer panels than energy intervals.&#39;</span>

                    <span class="n">integrated</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">),</span>
                                            <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="n">intensities</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># phases</span>
                        <span class="n">intensities</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="c1"># sky directions</span>

                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">)):</span>
                            <span class="n">bounds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">)</span>
                            <span class="n">_integrated</span> <span class="o">=</span> <span class="n">energy_integrator</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span>
                                                            <span class="n">intensities</span><span class="p">,</span>
                                                            <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
                                                            <span class="n">bounds</span><span class="p">)</span>

                            <span class="n">integrated</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">_integrated</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>

                    <span class="n">images</span> <span class="o">=</span> <span class="n">integrated</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_c_idxs</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Warning: number of panels not equal to number of &#39;</span>
                            <span class="s1">&#39;phases.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">and</span> <span class="n">time_is_space</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_c_pidxs</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Warning: number of panels not equal to number of &#39;</span>
                           <span class="s1">&#39;phases.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">phase_average</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;Averaging (specific) intensity over rotational phase&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Averaged (specific) intensity over rotational phase&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_2pi</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Minimum and maximum phases at which &#39;</span>
                                         <span class="s1">&#39;star is imaged must be zero and unity &#39;</span>
                                         <span class="s1">&#39;if you are phase averaging.&#39;</span><span class="p">)</span>

                    <span class="n">averaged</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="n">intensities</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                             <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># energies</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="c1"># sky directions</span>
                            <span class="n">intensities</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                        <span class="n">_averaged</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="c1"># exposure time</span>
                                                     <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
                                                     <span class="n">intensities</span><span class="p">,</span>
                                                     <span class="n">phases</span> <span class="o">/</span> <span class="n">_2pi</span><span class="p">,</span>
                                                     <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># phase shift</span>

                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">averaged</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_averaged</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span>

                    <span class="n">images</span> <span class="o">=</span> <span class="n">averaged</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">and</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">phase_bounds</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;Integrating specific intensity over phase intervals&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Integrated specific intensity over phase intervals&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="n">phase_bounds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Phase bounds in a tuple must be &#39;</span>
                                             <span class="s1">&#39;ordered.&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">&lt;=</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Extrapolation would be required.&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase_bounds</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="s1">&#39;Warning: fewer panels than phase intervals.&#39;</span>

                    <span class="n">integrated</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="nb">len</span><span class="p">(</span><span class="n">phase_bounds</span><span class="p">),</span>
                                            <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="n">intensities</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                             <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># energies</span>
                        <span class="n">intensities</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="c1"># sky directions</span>

                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phase_bounds</span><span class="p">)):</span>
                            <span class="n">bounds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phase_bounds</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="n">_integrated</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                                           <span class="n">bounds</span><span class="p">,</span>
                                                           <span class="n">intensities</span><span class="p">,</span>
                                                           <span class="n">phases</span> <span class="o">/</span> <span class="n">_2pi</span><span class="p">,</span>
                                                           <span class="mf">0.0</span><span class="p">)</span>

                            <span class="n">integrated</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">_integrated</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">images</span> <span class="o">=</span> <span class="n">integrated</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">and</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">bolometric</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                         <span class="s1">&#39;Integrating bolometric intensity&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Averaged bolometric intensity&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_2pi</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Minimum and maximum phases at which &#39;</span>
                                         <span class="s1">&#39;star is imaged must be zero and unity &#39;</span>
                                         <span class="s1">&#39;if you are phase averaging.&#39;</span><span class="p">)</span>

                    <span class="n">integrated</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="mi">1</span><span class="p">,</span>
                                            <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="n">intensities</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                             <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># phases</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="c1"># sky directions</span>
                            <span class="n">intensities</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span>

                        <span class="n">bounds</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="p">)</span>
                        <span class="n">_integrated</span> <span class="o">=</span> <span class="n">energy_integrator</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span>
                                                        <span class="n">intensities</span><span class="p">,</span>
                                                        <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
                                                        <span class="n">bounds</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="n">integrated</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_integrated</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span>

                    <span class="n">images</span> <span class="o">=</span> <span class="n">integrated</span>

            <span class="k">if</span> <span class="n">normalise_each_panel</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                             <span class="s1">&#39;Normalising each sky map panel separately&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Normalised sky map panels separately&#39;</span><span class="p">):</span>
                    <span class="c1"># normalise intensity for each individual panel</span>
                    <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># at each energy</span>
                            <span class="c1"># find extreme intensities over discrete set of image</span>
                            <span class="c1"># phases and sky directions</span>
                            <span class="n">MIN</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">images</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:][</span><span class="n">images</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">])</span>
                            <span class="n">MAX</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:])</span>
                            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">add_zero_intensity_level</span><span class="p">:</span>
                                <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">MIN</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># at each energy</span>
                            <span class="c1"># find extreme intensities over discrete set of image</span>
                            <span class="c1"># phases and sky directions</span>
                            <span class="n">MIN</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:][</span><span class="n">images</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">])</span>
                            <span class="n">MAX</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">j</span><span class="p">,:,:])</span>
                            <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">add_zero_intensity_level</span><span class="p">:</span>
                                <span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">MIN</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                             <span class="s1">&#39;Normalising sky map panels globally&#39;</span>
                             <span class="s1">&#39;Normalised sky map panels globally&#39;</span><span class="p">):</span>
                    <span class="n">MIN</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">images</span><span class="p">[:,:,:][</span><span class="n">images</span><span class="p">[:,:,:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">])</span>
                    <span class="n">MAX</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[:,:,:])</span>
                    <span class="n">levels</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">num_levels</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">add_zero_intensity_level</span><span class="p">:</span>
                        <span class="n">levels</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">MIN</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">levels</span><span class="p">))</span>

            <span class="c1"># because of default tick formatting and a minus sign,</span>
            <span class="c1"># the left and bottom margins need to be different</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mf">0.09</span> <span class="o">*</span> <span class="p">(</span><span class="n">fontsize</span><span class="o">/</span><span class="mf">14.0</span><span class="p">)</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.11</span> <span class="o">*</span> <span class="p">(</span><span class="n">fontsize</span><span class="o">/</span><span class="mf">14.0</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="mf">0.975</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span>

            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s1">&#39;RedGreyBlue&#39;</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">Reds_r</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">,</span> <span class="n">cm</span><span class="o">.</span><span class="n">Blues_r</span><span class="p">]</span>
                    <span class="n">_line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">Reds_r</span><span class="p">(</span><span class="mf">0.25</span><span class="p">),</span>
                                    <span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                                    <span class="n">cm</span><span class="o">.</span><span class="n">Blues_r</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)]</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
                    <span class="n">_line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cmap</span> <span class="o">=</span> <span class="n">colormap</span>
                    <span class="n">_line_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmap</span><span class="p">))]</span>

                <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                       <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
                                       <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">_hspace</span><span class="p">)</span>

                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">))]</span>
                <span class="n">pp_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">spec_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">line_styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;-.&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">colormap</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">)</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                       <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
                                       <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="n">_hspace</span><span class="p">)</span>

                <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">))]</span>

            <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span> <span class="n">annotate_energies</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">annotate_phases</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">_I</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">phase_average</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Rendering phase-averaged images&#39;</span>
                <span class="k">elif</span> <span class="n">bolometric</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Rendering bolometric images&#39;</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Rendering images&#39;</span>
                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Rendering image numbers [</span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">_I</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">i</span><span class="o">%</span><span class="n">_I</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="s1">&#39;Rendering image numbers (</span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="n">_I</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span>
                        <span class="n">_cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_cmap</span> <span class="o">=</span> <span class="n">cmap</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">with_pulse_profile_and_spectrum</span> <span class="ow">or</span>
                        <span class="n">_np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">R</span> <span class="o">&lt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">r_s</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(2x/(3\sqrt</span><span class="si">{3}</span><span class="s1">r_{\rm s}))$&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(x/R_{\rm eq})\sqrt{1-r_{\rm s}/R_{\rm eq}}$&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">j</span> <span class="o">%</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">R</span> <span class="o">&lt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">r_s</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(2y/(3\sqrt</span><span class="si">{3}</span><span class="s1">r_{\rm s}))$&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(y/R_{\rm eq})\sqrt{1-r_{\rm s}/R_{\rm eq}}$&#39;</span><span class="p">)</span>

                    <span class="n">_veneer</span><span class="p">(</span><span class="n">tick_spacing</span><span class="p">,</span> <span class="n">tick_spacing</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="n">tick_length</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">_cmap</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                        <span class="n">lvls</span> <span class="o">=</span> <span class="n">levels</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">levels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lvls</span> <span class="o">=</span> <span class="n">levels</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                                   <span class="n">Y</span><span class="p">,</span>
                                   <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx</span><span class="p">,:],</span>
                                   <span class="n">cmap</span> <span class="o">=</span> <span class="n">_cmap</span><span class="p">,</span>
                                   <span class="n">levels</span> <span class="o">=</span> <span class="n">lvls</span><span class="p">)</span>

                    <span class="c1"># correct the aspect ratio</span>
                    <span class="n">x_view</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">x_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_view_interval</span><span class="p">(</span><span class="n">x_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">,</span>
                                               <span class="n">x_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">)</span>
                    <span class="n">y_view</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_view_interval</span><span class="p">(</span><span class="n">y_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">1.025</span><span class="p">,</span>
                                               <span class="n">y_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">annotate_energies</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">annotate_location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">annotate_location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">s</span><span class="o">=</span><span class="n">energy_annotation_format</span> <span class="o">%</span> <span class="n">energies</span><span class="p">[</span><span class="n">_c_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span>
                           <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="s1">&#39;white&#39;</span><span class="p">},</span>
                           <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">time_is_space</span> <span class="ow">and</span> <span class="n">annotate_phases</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">annotate_location</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">annotate_location</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">s</span><span class="o">=</span><span class="n">phase_annotation_format</span> <span class="o">%</span> <span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="n">_c_pidxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span><span class="o">/</span><span class="n">_2pi</span><span class="p">),</span>
                           <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="s1">&#39;white&#39;</span><span class="p">},</span>
                           <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">with_pulse_profile_and_spectrum</span><span class="p">:</span> <span class="c1"># plot summaries</span>
                    <span class="n">_upper_view_lim</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
                    <span class="n">_lower_view_lim</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
                    <span class="n">_view_lim_diff</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_upper_view_lim</span><span class="p">)</span>
                    <span class="n">_view_lim_diff</span> <span class="o">-=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_lower_view_lim</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                        <span class="n">_idx</span> <span class="o">=</span> <span class="n">_c_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="n">_diff</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">_idx</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">_diff</span> <span class="o">-=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">_lower_view_lim</span><span class="p">)</span>
                        <span class="n">spec_ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="n">_idx</span><span class="p">],</span>
                                 <span class="mf">0.0</span><span class="p">,</span>
                                 <span class="n">_diff</span><span class="o">/</span><span class="n">_view_lim_diff</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="n">_line_colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                 <span class="n">ls</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

                    <span class="n">spec_ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                    <span class="n">spec_ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
                    <span class="n">spec_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">spec_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">_lower_view_lim</span><span class="p">,</span> <span class="n">_upper_view_lim</span><span class="p">)</span>
                    <span class="n">_veneer</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spec_ax</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">tick_length</span><span class="p">,</span>
                            <span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
                    <span class="n">spec_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Photon energy [keV]&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                        <span class="n">spec_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">flux</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                            <span class="n">_idx</span> <span class="o">=</span> <span class="n">_c_pidxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">spec_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">flux</span><span class="p">[</span><span class="n">_idx</span><span class="p">,:</span><span class="n">i</span><span class="p">],</span>
                                         <span class="n">color</span><span class="o">=</span><span class="n">_line_colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                         <span class="n">ls</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                         <span class="n">label</span><span class="o">=</span><span class="n">phase_annotation_format</span> <span class="o">%</span> <span class="n">phases</span><span class="p">[</span><span class="n">_idx</span><span class="p">])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">time_is_space</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">_cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cycles</span><span class="p">):</span> <span class="c1"># plot pulse-profiles</span>
                            <span class="n">_ext_phases</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_cycle</span><span class="p">):</span>
                                <span class="n">_ext_phases</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">_i</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="k">else</span> <span class="mi">0</span><span class="p">:]</span> <span class="o">+</span> <span class="n">_i</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">)</span>
                            <span class="n">_ext_phases</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">_cycle</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_cycle</span> <span class="o">*</span> <span class="n">_2pi</span><span class="p">)</span>
                            <span class="n">_ext_phases</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_ext_phases</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                                <span class="n">_idx</span> <span class="o">=</span> <span class="n">_c_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                                <span class="n">_max</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">_idx</span><span class="p">,:])</span>
                                <span class="n">_ext_flux</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_cycle</span><span class="p">):</span>
                                    <span class="n">_ext_flux</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">_idx</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">_i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">:])</span>
                                <span class="n">_ext_flux</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">_idx</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">_cycle</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">_ext_flux</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_ext_flux</span><span class="p">)</span>
                                <span class="n">pp_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_ext_phases</span><span class="o">/</span><span class="n">_2pi</span><span class="p">,</span>
                                       <span class="n">_ext_flux</span><span class="o">/</span><span class="n">_max</span><span class="p">,</span>
                                       <span class="n">color</span><span class="o">=</span><span class="n">_line_colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                       <span class="n">ls</span><span class="o">=</span><span class="n">line_styles</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                       <span class="n">label</span><span class="o">=</span><span class="n">energy_annotation_format</span> <span class="o">%</span> <span class="n">energies</span><span class="p">[</span><span class="n">_idx</span><span class="p">])</span>

                            <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cycles</span><span class="p">))</span>
                            <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.2</span><span class="p">)</span>
                            <span class="n">_veneer</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">pp_ax</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">tick_length</span><span class="p">)</span>
                            <span class="n">pp_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span>
                                         <span class="n">handlelength</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                                         <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase [$2\pi$ radians]&#39;</span><span class="p">)</span>
                            <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;photons/cm$^2$/s/keV&#39;</span><span class="p">)</span>

                            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_ext_phases</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                        <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                            <span class="n">pp_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">spec_ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pp_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phases</span><span class="o">/</span><span class="n">_2pi</span><span class="p">,</span>
                                 <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,:]),</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

                        <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.2</span><span class="p">)</span>
                        <span class="n">_veneer</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">pp_ax</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">tick_length</span><span class="p">)</span>
                        <span class="n">pp_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span>
                                     <span class="n">handlelength</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                                     <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Phase [$2\pi$ radians]&#39;</span><span class="p">)</span>
                        <span class="n">pp_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;photons/cm$^2$/s/keV&#39;</span><span class="p">)</span>

                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">num_frames</span></div>

<div class="viewcode-block" id="Photosphere._animate"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere._animate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Animating intensity sky maps&#39;</span><span class="p">,</span> <span class="s1">&#39;Intensity sky maps animated&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_animate</span><span class="p">(</span><span class="n">_file_root</span><span class="p">,</span> <span class="n">_num_frames</span><span class="p">,</span> <span class="n">_figsize</span><span class="p">,</span> <span class="n">_dpi</span><span class="p">,</span>
                 <span class="n">cycles</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method to animate the intensity sky maps.</span>

<span class="sd">        :param str _file_root:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int _num_frames:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int _figsize:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int _dpi:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int cycles:</span>
<span class="sd">            Number of explicit cycles to generate frames for. The frames from</span>
<span class="sd">            the principal cycle are reused, so the images are periodic in</span>
<span class="sd">            their phase evolution. There is no delay between cycles in this</span>
<span class="sd">            type of repitition.</span>

<span class="sd">        :param int fps:</span>
<span class="sd">            Frames per second. If ``None``, then one cycle (assuming images</span>
<span class="sd">            have been precomputed for a complete cycle), consisting of</span>
<span class="sd">            so many frames, will exhibit a period of one second.</span>

<span class="sd">        :param bool repeat:</span>
<span class="sd">            Inform *ffmpeg* to enter a loop when video play back commences.</span>
<span class="sd">            Deprecated.</span>

<span class="sd">        :param repeat_delay:</span>
<span class="sd">            Delay between repeats in milliseconds. Deprecated.</span>

<span class="sd">        :param str ffmpeg_path:</span>
<span class="sd">            Absolute path to *ffmpeg* executable. If ``None``, defaults</span>
<span class="sd">            to matplotlib rcParams settings, but no guarantee that the package</span>
<span class="sd">            will be found even if installed on system. Deprecated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_root</span> <span class="o">=</span> <span class="n">_file_root</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="n">_num_frames</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">_figsize</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="n">_dpi</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">wspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># animation code based on:</span>
        <span class="c1"># http://jakevdp.github.io/blog/2012/08/18/matplotlib-animation-tutorial/</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_0.png&#39;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">mgimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">imgplot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

        <span class="n">cycles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cycles</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">cycles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">num_frames</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">_num_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">_context</span><span class="p">:</span> <span class="c1"># mutable nonlocal namespace in closure</span>
            <span class="n">_cycle_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># track cycle</span>
            <span class="n">_j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>        <span class="c1"># track image index</span>
            <span class="n">_last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">def</span> <span class="nf">_update</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="c1"># load phase-ordered set of images</span>
            <span class="k">if</span> <span class="n">_context</span><span class="o">.</span><span class="n">_last</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">imgplot</span><span class="p">,</span>

            <span class="k">if</span> <span class="n">_context</span><span class="o">.</span><span class="n">_cycle_idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">_num_frames</span><span class="p">:</span>
                <span class="n">_context</span><span class="o">.</span><span class="n">_j</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">_context</span><span class="o">.</span><span class="n">_cycle_idx</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">_num_frames</span> <span class="o">+</span> <span class="n">_context</span><span class="o">.</span><span class="n">_cycle_idx</span> <span class="o">*</span> <span class="p">(</span><span class="n">_num_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">_context</span><span class="o">.</span><span class="n">_j</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">_context</span><span class="o">.</span><span class="n">_cycle_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_context</span><span class="o">.</span><span class="n">_j</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">_context</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="n">i</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">_context</span><span class="o">.</span><span class="n">_j</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">mgimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">imgplot</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">imgplot</span><span class="p">,</span>

        <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">_update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">num_frames</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="n">num_frames</span> <span class="c1"># all frames span one second</span>

        <span class="c1"># secret keyword argument; not clear whether should be exposed to user</span>
        <span class="n">bitrate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bitrate&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># default is let _mpl choose</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_animated.mp4&#39;</span>
        <span class="k">yield</span> <span class="s1">&#39;Writing to disk: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span>
                 <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span><span class="p">,</span> <span class="n">bitrate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">,</span>
                 <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s1">&#39;libx264&#39;</span><span class="p">])</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span> <span class="c1"># this or ax.cla() needed to free memory</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">yield</span> <span class="kc">None</span></div></div>

<span class="n">Photosphere</span><span class="o">.</span><span class="n">_update_doc</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_veneer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Make the plots a little more aesthetically pleasing. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, 2020, 2021 Thomas E. Riley.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>